<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="static/js/jquery.min.js"></script>
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <script src="static/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="static/css/jquery.datetimepicker.css" />
    <script src="static/js/jquery.datetimepicker.full.min.js"></script>
    <script src="static/js/jquery.actual.min.js"></script>
    <!-- leaflet -->
    <link rel="stylesheet" href="static/css/leaflet.css" />
    <script src="static/js/leaflet.js"></script>
    <script type="text/javascript" src="static/js/leaflet-windbarb.js"></script>
    <script src="static/js/leaflet.canvaslabel.js"></script>
    <!-- 使用turf -->
    <script src="static/js/turf.min.js"></script>
    <!-- echart -->
    <script type="text/javascript" src="static/js/echarts.min.js"></script>
    <script type="text/javascript" src="static/js/echarts-gl.min.js"></script>
    <script type="text/javascript" src="static/js/ecStat.min.js"></script>
    <script type="text/javascript" src="static/js/dataTool.min.js"></script>
    <script type="text/javascript" src="static/js/china.js"></script>
    <script type="text/javascript" src="static/js/world.js"></script>

    <!-- 引入 layui.css -->
    <link href="static/layui/css/layui.css" rel="stylesheet">
    <!-- 引入 layui.js -->
    <script src="static/layui/layui.js"></script>
    <!-- 数据 -->
    <script src='static/js/taizhou.js'></script>
    <script src='static/js/county.js'></script>
    <!-- 市县地图 -->
    <script src='static/js/xiangzhen/sanmen.js'></script>
    <script src='static/js/xiangzhen/tiantai.js'></script>
    <script src='static/js/xiangzhen/xianju.js'></script>
    <script src='static/js/xiangzhen/linhai.js'></script>
    <script src='static/js/xiangzhen/jiaojiang.js'></script>
    <script src='static/js/xiangzhen/luqiao.js'></script>
    <script src='static/js/xiangzhen/huangyan.js'></script>
    <script src='static/js/xiangzhen/wenling.js'></script>
    <script src='static/js/xiangzhen/yuhuan.js'></script>
    <script src='static/js/taizhoulist.js'></script>
    <script src="static/js/html2canvas.js"></script>
    <script src='static/js/zhejianglist.js'></script>
    <title>实况监测</title>
    <style type="text/css">
        .scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body>
    {% csrf_token %}
    <div 
        style="display: flex;align-content:flex-start;position: absolute; justify-content: center; flex-wrap: wrap; width: 100%;height: 100%;background-color: rgb(246, 247, 250);overflow-y: hidden;">
        <!-- 导航栏目 -->
        <div style="width:100%;">
            <ul class="layui-nav">
                <li  class="layui-nav-item" style="width: 14%;font-size: 25px;padding-left:25px">气象数据分析系统</li>
                <li class="layui-nav-item layui-this"><a href="">实况自动站</a></li>
                <!-- <li class="layui-nav-item"><a href="">模式</a></li> -->
            </ul>
        </div>
        <!-- 内容 -->
        <div style="display: inline-flex;width:100%;height:95%">
            <!-- 这里是垂直导航栏目 -->
            <!-- <div style="width:15%;height: 100%;background-color: rgb(40,43,51);"> -->
                <ul class="layui-nav layui-nav-tree layui-inline" lay-filter="demo" style="width:15%;height: 100%;background-color: rgb(40,43,51);">
                    <li class="layui-nav-item layui-nav-itemed">
                      <a href="javascript:;">降水</a>
                      <dl class="layui-nav-child">
                        <dd style="padding-left: 15px;margin-bottom: 10px;margin-top: 10px;">
                            <button type="button" value=24 class="layui-btn layui-btn-xs rain">R24</button>
                            <button type="button" class="layui-btn layui-btn-xs">R12</button>
                            <button type="button" class="layui-btn layui-btn-xs">R06</button>
                            <button type="button" class="layui-btn layui-btn-xs">R03</button>
                            <button type="button" class="layui-btn layui-btn-xs">R01</button>

                        </dd>
                        <dd style="padding-left: 15px;margin-bottom: 10px;">
                            <button type="button" class="layui-btn layui-btn-xs">R45</button>
                            <button type="button" class="layui-btn layui-btn-xs">R30</button>        
                            <button type="button" class="layui-btn layui-btn-xs">R15</button>
                            <button type="button" class="layui-btn layui-btn-xs">R10</button>
                            <button type="button" class="layui-btn layui-btn-xs">R05</button>
                        </dd>
                      </dl>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:;">风力</a>
                        <dl class="layui-nav-child">
                            <dd style="padding-left: 15px;margin-bottom: 10px;margin-top: 10px;">
                                <button type="button" class="layui-btn layui-btn-xs">F24</button>
                                <button type="button" class="layui-btn layui-btn-xs">F12</button>
                                <button type="button" class="layui-btn layui-btn-xs">F06</button>
                                <button type="button" class="layui-btn layui-btn-xs">F03</button>
                                <button type="button" class="layui-btn layui-btn-xs">F01</button>
                        
                            </dd>
                            <dd style="padding-left: 15px;margin-bottom: 10px;">
                                <button type="button" class="layui-btn layui-btn-xs">F45</button>
                                <button type="button" class="layui-btn layui-btn-xs">F30</button>
                                <button type="button" class="layui-btn layui-btn-xs">F15</button>
                                <button type="button" class="layui-btn layui-btn-xs">F10</button>
                                <button type="button" class="layui-btn layui-btn-xs">F05</button>
                            </dd>
                        </dl>
                      </li>
                      <li class="layui-nav-item">
                        <a href="javascript:;">气温</a>
                        <dl class="layui-nav-child">
                            <dd style="padding-left: 15px;margin-bottom: 10px;margin-top: 10px;">
                                <button type="button" class="layui-btn layui-btn-xs">T24</button>
                                <button type="button" class="layui-btn layui-btn-xs">T12</button>
                                <button type="button" class="layui-btn layui-btn-xs">T06</button>
                                <button type="button" class="layui-btn layui-btn-xs">T03</button>
                                <button type="button" class="layui-btn layui-btn-xs">T01</button>
                        
                            </dd>
                            <dd style="padding-left: 15px;margin-bottom: 10px;">
                                <button type="button" class="layui-btn layui-btn-xs">T45</button>
                                <button type="button" class="layui-btn layui-btn-xs">T30</button>
                                <button type="button" class="layui-btn layui-btn-xs">T15</button>
                                <button type="button" class="layui-btn layui-btn-xs">T10</button>
                                <button type="button" class="layui-btn layui-btn-xs">T05</button>
                            </dd>
                        </dl>
                      </li>
                      <li class="layui-nav-item">
                        <a href="javascript:;">能见度</a>
                        <dl class="layui-nav-child">
                            <dd style="padding-left: 15px;margin-bottom: 10px;margin-top: 10px;">
                                <button type="button" class="layui-btn layui-btn-xs">V24</button>
                                <button type="button" class="layui-btn layui-btn-xs">V12</button>
                                <button type="button" class="layui-btn layui-btn-xs">V06</button>
                                <button type="button" class="layui-btn layui-btn-xs">V03</button>
                                <button type="button" class="layui-btn layui-btn-xs">V01</button>
                        
                            </dd>
                            <dd style="padding-left: 15px;margin-bottom: 10px;">
                                <button type="button" class="layui-btn layui-btn-xs">V45</button>
                                <button type="button" class="layui-btn layui-btn-xs">V30</button>
                                <button type="button" class="layui-btn layui-btn-xs">V15</button>
                                <button type="button" class="layui-btn layui-btn-xs">V10</button>
                                <button type="button" class="layui-btn layui-btn-xs">V05</button>
                            </dd>
                        </dl>
                      </li>
                    <!-- 基础设置 -->
                      <li class="layui-nav-item layui-nav-itemed">
                        <a href="javascript:;">查询设置</a>
                        <dl class="layui-nav-child">
                            <dd style="height:400px"></dd>
                            <dd><a href="">设置内容</a></dd>
                        </dl>
                      </li>
                   

                </ul>


            <!-- </div> -->
            <!-- 这里是地图 -->
            <div id="map" style="width:85%;height: 100%">

            </div>
            <script>
                // 地图加载的核心
                const map_toolbox_object = {
                        start_date: undefined,// 起止时间
                        end_date: undefined, // 终结时间
                        recv_all_data:undefined, // 接收数据
                        recv_single_data:undefined, // 接收单点数据
                        current_map:undefined, // 当前地图层
                        current_layer:undefined, // 当前绘图层
                        current_marker_list:[], // 当前散点阵列
                        getMaxAttribute: function (inLevelV, inGrid, inBreaksProperties) {
                            //定义变量
                            let levelArray = [];
                            let levelLength = inLevelV.length;
                            inLevelV.forEach(function (item, index) {
                                if (index < levelLength - 2) levelArray.push(0);
                            });
                            //统计每个等级中网格点数量
                            inGrid.features.map((i) => {
                                inLevelV.forEach(function (item, index) {
                                    if (index < levelLength - 3) {
                                        if (i.properties.value >= inLevelV[index] && i.properties.value < inLevelV[index + 1]) levelArray[index]++;
                                    }
                                    if (index == levelLength - 2) {
                                        if (i.properties.value >= inLevelV[index]) levelArray[index]++;
                                    }
                                });
                            });
                            //取等级中网格点最多的值
                            let maxIndex = -1;
                            let maxV = 0;
                            levelArray.forEach(function (item, index) {
                                if (maxV < item) { maxV = item; maxIndex = index; }
                            });
                            let value = '';
                            let fill = '';
                            if (maxIndex != -1) {
                                value = inLevelV[maxIndex] + '-' + inLevelV[maxIndex + 1];
                                fill = inBreaksProperties[maxIndex].fill;
                            }
                            return [value, fill]
                        },
                        return_shp: function (boundaries, data, plot_type) {
                            // data 为poin需要用turf的featureCollection(data)加载
                            var points = turf.featureCollection(data);
                            var interpolate_options = {
                                gridType: "points",
                                property: "value",
                                units: "degrees",
                                weight: 10
                            };
                            var isobands_options = map_toolbox_object.color_level(plot_type).isobands_options
                            var levelV = map_toolbox_object.color_level(plot_type).levelV;
                            var grid = turf.interpolate(points, 0.05, interpolate_options);
                            var isobands = turf.isobands(
                                grid,
                                levelV,
                                isobands_options
                            );
                            var isobandsLay = L.geoJSON(isobands, {
                                style: function (feature) {
                                    return {
                                        color: '#4264fb',
                                        fillColor: feature.properties.fill,
                                        weight: 0.1,
                                        fillOpacity: 0.8
                                    };
                                }
                            });
                            var features = [];//裁剪后的结果集
                            isobands.features.forEach(function (feature1) {
                                boundaries.features.forEach(function (feature2) {
                                    var intersection = null;
                                    try {
                                        intersection = turf.intersect(feature1, feature2);
                                    } catch (e) {
                                        try {
                                            //色斑图绘制之后，可能会生成一些非法 Polygon ，例如 在 hole 里存在一些形状（听不懂？去查一下 GeoJSON 的规范），
                                            //我遇到的一个意外情况大概是这样，这种 Polygon 在做 intersect() 操作的时候会报错，所以在代码中做了个容错操作。
                                            //解决的方法通常就是做一次 turf.buffer() 操作，这样可以把一些小的碎片 Polygon 清理掉。
                                            feature1 = turf.buffer(feature1, 0);
                                            intersection = turf.intersect(feature1, feature2);
                                        } catch (e) {
                                            intersection = feature1;//实在裁剪不了就不裁剪了,根据业务需求自行决定
                                        }
                                    }
                                    if (intersection != null) {
                                        intersection.properties = feature1.properties;
                                        intersection.id = (Math.random() * 100000).toFixed(0);
                                        features.push(intersection);
                                    }
                                });
                            });
                            //turf.isobands有点不符合业务预期,只有一个等级时,结果集可能为空,无图形显示,写点程序(找出那一个等级，并添加进结果集)补救下
                            if (features.length == 0) {
                                var maxAttribute = map_toolbox_object.getMaxAttribute(levelV, grid, isobands_options.breaksProperties);
                                var value = maxAttribute[0];
                                var fill = maxAttribute[1];
                                if (value != '' && fill != '') {
                                    //获取网格点Box
                                    var gridBox = turf.bbox(grid);
                                    //生成网格点范围的面
                                    var gridBoxPolygon = [[[gridBox[0], gridBox[1]], [gridBox[0], gridBox[3]], [gridBox[2], gridBox[3]], [gridBox[2], gridBox[1]], [gridBox[0], gridBox[1]]]];
                                    //获取网格范围的面与行政边界的交集 Polygon
                                    var intersectPolygon = null;
                                    var gridoxFeature = {
                                        "type": "Feature",
                                        "properties": { "fill-opacity": 0.8 },
                                        "geometry": { "type": "Polygon", "coordinates": gridBoxPolygon },
                                        "id": 10
                                    };
                                    try {
                                        intersectPolygon = turf.intersect(gridoxFeature, boundaries.features[0]);
                                    } catch (e) {
                                        try {
                                            //色斑图绘制之后，可能会生成一些非法 Polygon ，例如 在 hole 里存在一些形状（听不懂？去查一下 GeoJSON 的规范），
                                            //我遇到的一个意外情况大概是这样，这种 Polygon 在做 intersect() 操作的时候会报错，所以在代码中做了个容错操作。
                                            //解决的方法通常就是做一次 turf.buffer() 操作，这样可以把一些小的碎片 Polygon 清理掉。
                                            gridoxFeature = turf.buffer(gridoxFeature, 0);
                                            intersectPolygon = turf.intersect(gridoxFeature, boundaries.features[0]);
                                        } catch (e) {
                                            intersectPolygon = gridoxFeature;//实在裁剪不了就不裁剪了,根据业务需求自行决定
                                        }
                                    }
                                    //结果添加到结果数组
                                    if (intersectPolygon != null) {
                                        features.push({
                                            "type": "Feature",
                                            "properties": { "fill-opacity": 0.8, "fill": fill, "value": value },
                                            "geometry": intersectPolygon.geometry,
                                            "id": 0
                                        });
                                    }
                                }
                            }
                            var intersection = turf.featureCollection(features);
                            var intersectionLay = L.geoJSON(intersection, {
                                style: function (feature) {
                                    return {
                                        color: 'black',
                                        fillColor: feature.properties.fill,
                                        weight: 0.1,
                                        zIndex: 800,
                                        fillOpacity: 0.7
                                    };
                                }
                            })
                            return {
                                intersectionLay: intersectionLay
                            }
                        },
                        return_boundaries: function (shpdata) {
                            var bounddata = {
                                type: "FeatureCollection",
                                name: "boundaries",
                                crs: { type: "name", properties: { name: "urn:ogc:def:crs:OGC:1.3:CRS84" } },
                                features: shpdata
                            }
                            return {
                                boundaries: bounddata
                            }
                        },
                        get_data: function(model,type,button_value){
                            //向服务器要数据model,type,button 对应导航栏目、垂直导航类型、具体按钮
                            var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                            $.ajax({
                                url: "station_zdz_data",  // 请求的地址
                                type: "post",  // 请求方式
                                timeout: 25000, //设置延迟上限
                                data: {
                                    'csrfmiddlewaretoken': csrf,
                                    'model': model,
                                    'click_type': type,
                                    'button_value': button_value
                                },
                                dataType: "json",
                                success: function (recvdate) {
                                    console.log("接受的数据",recvdate)
                                }
                            })

                        },
                        current_time: function(button_value){
                            //返回时间
                            function getNextDate(date, day) {
                                var dd = new Date(date);
                                dd.setDate(dd.getDate() + day);
                                var y = dd.getFullYear();
                                var m = dd.getMonth() + 1 < 10 ? "0" + (dd.getMonth() + 1) : dd.getMonth() + 1;
                                var d = dd.getDate() < 10 ? "0" + dd.getDate() : dd.getDate();
                                return y + "-" + m + "-" + d;
                            }; 
                            var today = new Date()
                            var y = today.getFullYear();
                            var m = today.getMonth() + 1 < 10 ? "0" + (today.getMonth() + 1) : today.getMonth() + 1;
                            var d = today.getDate() < 10 ? "0" + today.getDate() : today.getDate();
                            var h = today.getHours() < 10 ? "0" + today.getHours() +":" : today.getHours()+":";
                            var minutes = today.getMinutes() < 10 ? "0" + today.getMinutes() + ":" : today.getMinutes() + ":";
                            var sec = today.getSeconds() < 10 ? "0" + today.getSeconds() :today.getSeconds();
                            var today_str = y + "-" + m + "-" + d + " " + h + minutes + sec;
                            if (button_value==24){
                                console.log(today_str)
                                var old_day = getNextDate(today_str, day=-1)

                            }


                        },
                        flush_map: function () {
                            //刷新按钮
                        },
                        init: function () {
                            //地图初始化
                            if(map_toolbox_object.current_map){
                                map_toolbox_object.current_map.eachLayer(function (layer) {
                                    if (!layer._container || ('' + jQuery(layer._container).attr('class')).replace(/\s/g, '') != 'leaflet-layer') {
                                        layer.remove();
                                    }
                                });
                                var boundaries = map_toolbox_object.return_boundaries(taizhoulist).boundaries
                                var zhejiang = map_toolbox_object.return_boundaries(zhejianglist).boundaries
                                var canvasLabel = new L.CanvasLabel({
                                    defaultLabelStyle: {
                                        collisionFlg: true,
                                        scale: 1,
                                        strokeStyle: "#000",
                                        fillStyle: "#fff",
                                        lineWidth: 3
                                    }
                                });
                                var lines = L.geoJSON(zhejiang, {
                                    style: function (feature) {
                                        return { color: 'black', weight: 1, fillOpacity: 0.1 };
                                    }
                                })
                                var map_zdz = new L.Map('map', {
                                    center: new L.LatLng(28.6, 120.9),//110.763, 41.376   39.62353145, 121.9937485
                                    renderer: canvasLabel,
                                    zoom: 9, //4
                                    zoomControl: false,
                                    dragging: true,
                                    scrollWheelZoom: true,
                                    doubleClickZoom: false,
                                    attributionControl: false, //是否去除右下角标志
                                    bounds: turf.bbox(boundaries),

                                    layers: [lines]
                                });
                                map_toolbox_object.current_map = map_zdz

                            }
                            else{
                                var boundaries = map_toolbox_object.return_boundaries(taizhoulist).boundaries
                                var zhejiang = map_toolbox_object.return_boundaries(zhejianglist).boundaries
                                var canvasLabel = new L.CanvasLabel({
                                    defaultLabelStyle: {
                                        collisionFlg: true,
                                        scale: 1,
                                        strokeStyle: "#000",
                                        fillStyle: "#fff",
                                        lineWidth: 3
                                    }
                                });
                                var lines = L.geoJSON(zhejiang, {
                                    style: function (feature) {
                                        return { color: 'black', weight: 1, fillOpacity: 0.1 };
                                    }
                                })
                                var corner1 = L.latLng(25, 115),
                                    corner2 = L.latLng(35, 125),
                                    bound = L.latLngBounds(corner1, corner2);
                                var map_zdz = new L.Map('map', {
                                    center: new L.LatLng(28.6, 120.9),//110.763, 41.376   39.62353145, 121.9937485
                                    renderer: canvasLabel,
                                    zoom: 9, //4
                                    zoomControl: false,
                                    dragging: true,
                                    scrollWheelZoom: true,
                                    doubleClickZoom: false,
                                    attributionControl: false, //是否去除右下角标志
                                    bounds: turf.bbox(boundaries),
                                    maxBounds:bound,
                                    layers: [lines]
                                });
                                map_toolbox_object.current_map = map_zdz

                            }
                        },
                        plot_layer: function () {
                            //绘制图层
                        },
                        plot_mark: function () {
                            //绘制站点                        
                        },
                        plot_line: function () {
                            //绘制站点                        
                        }
                    }
                // 首页加载地图
                map_toolbox_object.init()
                //按钮组的响应函数
                $('.rain').click(function(){
                    var model = "zdz"
                    var type = "rain"
                    var button_value = this.value 
                    map_toolbox_object.current_time(button_value)
                    map_toolbox_object.get_data(model,type,button_value)            
                })


            </script>
        </div>




    </div>


    {% csrf_token %}
</body>

</html>