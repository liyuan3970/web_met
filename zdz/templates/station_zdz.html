<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="static/js/jquery.min.js"></script>
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <script src="static/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="static/css/jquery.datetimepicker.css" />
    <script src="static/js/jquery.datetimepicker.full.min.js"></script>
    <script src="static/js/jquery.actual.min.js"></script>
    <!-- leaflet -->
    <link rel="stylesheet" href="static/css/leaflet.css" />
    <script src="static/js/leaflet.js"></script>
    <script type="text/javascript" src="static/js/leaflet-windbarb.js"></script>
    <script src="static/js/leaflet.canvaslabel.js"></script>
    <script src="static/js/Leaflet.canvasmarker.js"></script>
    <script type="text/javascript" src="static/js/iconLayers.js"></script>
    <link rel="stylesheet" href="static/css/iconLayers.css">
    <script src='static/js/leaflet.mask.js'></script>
    <!-- <script src="https://unpkg.com/leaflet-canvas-marker@0.2.0"></script> -->
    <!-- 散点 -->
    <link rel="stylesheet" href="static/css/leaflet-beautify-marker-icon.css">
    <script src="static/js/leaflet-beautify-marker-icon.js"></script>
    <!-- 使用turf -->
    <script src="static/js/turf.min.js"></script>
    <!-- 地理坐标转换 -->
    <script src="https://unpkg.com/gcoord/dist/gcoord.global.prod.js"></script>
    <!-- 使用插值算法 -->
    <!-- <script src="static/js/kriging.js"></script> -->
    <!-- echart -->
    <script type="text/javascript" src="static/js/echarts.min.js"></script>
    <script type="text/javascript" src="static/js/echarts-gl.min.js"></script>
    <script type="text/javascript" src="static/js/ecStat.min.js"></script>
    <script type="text/javascript" src="static/js/dataTool.min.js"></script>
    <script type="text/javascript" src="static/js/china.js"></script>
    <script type="text/javascript" src="static/js/world.js"></script>
    <!-- hightchart -->
    <script src="static/js/highcharts.js"></script>
    <script src="static/js/windbarb.js"></script>
    <script src="static/js/exporting.js"></script>
    <script src="static/js/export-data.js"></script>
    <script src="static/js/accessibility.js"></script>
    <!-- <script src="https://code.hcharts.cn/highcharts/themes/dark-unica.js"></script> -->
    <!-- 弹窗 -->
    <link rel="stylesheet" type="text/css" href="static/css/translucent.css">
    <script src="static/js/jquery-translucent.js"></script>

    <!-- 引入 layui.css -->
    <link href="static/layui/css/layui.css" rel="stylesheet">
    <!-- 引入 layui.js -->
    <script src="static/layui/layui.js"></script>
    <!-- 弹窗 -->
    <script src="static/layui/layer.js"></script>
    <!-- 数据 -->


    <script src='static/js/taizhou.js'></script>
    <script src='static/js/county.js'></script>
    <!-- 市县地图 -->
    <script src='static/js/xiangzhen/sanmen.js'></script>
    <script src='static/js/xiangzhen/tiantai.js'></script>
    <script src='static/js/xiangzhen/xianju.js'></script>
    <script src='static/js/xiangzhen/linhai.js'></script>
    <script src='static/js/xiangzhen/jiaojiang.js'></script>
    <script src='static/js/xiangzhen/luqiao.js'></script>
    <script src='static/js/xiangzhen/huangyan.js'></script>
    <script src='static/js/xiangzhen/wenling.js'></script>
    <script src='static/js/xiangzhen/yuhuan.js'></script>
    <script src='static/js/taizhoulist.js'></script>
    <script src="static/js/html2canvas.js"></script>
    <script src='static/js/zhejianglist.js'></script>
    <script src='static/js/zjonly.js'></script>
    <script src='static/js/taizhou_county.js'></script>
    <script src='static/js/taizhouxiangzhen.js'></script>
    <!-- <script src='static/js/tzonly.js'></script> -->
    <title>天驰</title>
    <style type="text/css">
        .scrollbar::-webkit-scrollbar {
            display: none;
        }

        .layui-layer-lan .layui-layer-title {
            /* background: #393D49; */
            color: #fff;
            font-size: 20px;
            border: none;
        }

        .layui-code {
            position: relative;
            margin: 0px 0;
            padding: 0px;
            line-height: 20px;
            border: 1px solid #eee;
            border-left-width: 0px;
            background-color: #fafafa;
            color: #333;
            font-family: Courier New;
            font-size: 15px;
            /* font-family: "STKaiti"; */
            text-align: left;
        }

        /* .layui-layer-lan .layui-layer-btn{border-top:1px solid #E9E7E7} */
        /* .demo-class .layui-layer-btn a{background:#333;} */
        /* .demo-class .layui-layer-btn .layui-layer-btn1{background:#999;} */
    </style>
</head>

<body>
    {% csrf_token %}
    <div
        style="display: flex;align-content:flex-start;position: absolute; justify-content: center; flex-wrap: wrap; width: 100%;height: 100%;background-color: rgb(246, 247, 250);overflow-y: hidden;">
        <!-- 导航栏目 -->
        <div style="display: inline-block;width:100%;height: 5%;" class="layui-logo layui-hide-xs layui-bg-black">
            <div style="display: inline-block;width:15%;height: 100%;padding:0;">
                <h3 style="padding-top:10px;padding-left: 50px;width: 200px;">天驰</h3>
            </div>

            <div style="display: inline-block;width:55%;height: 100%;padding:0;float: right;">
                <button id="settings" type="button" class="layui-btn"
                    style="float: right;margin-top:0px;height: 100%;background-color: rgb(57,61,73);">
                    <i class="layui-icon layui-icon-set"></i>
                </button>
            </div>
            <script>
                $("#settings").click(function () {
                    layer.open({
                        type: 1,
                        title: "设置",
                        maxmin: false,
                        scrollbar: false,
                        fixed: false,
                        offset: 'rt',
                        moveOut: false,
                        resize: false,
                        skin: 'layui-layer-lan', //样式类名
                        closeBtn: 1, //不显示关闭按钮
                        area: ['340px', '650px'],
                        // maxHeight: 600,
                        // maxWidth: 1400,
                        anim: 0,
                        shade: 0,
                        zIndex: 9999,
                        shadeClose: false, //开启遮罩关闭
                        content: $("#station_setting")
                    });

                })

            </script>

        </div>
        <!-- 内容 -->
        <div style="display: inline-flex;width:100%;height:95%">
            <!-- 这里是垂直导航栏目 -->
            <!-- <div style="width:15%;height: 100%;background-color: rgb(40,43,51);"> -->
            <ul class="layui-nav layui-nav-tree layui-inline scrollbar"
                style="width:15%;height: 100%;background-color: rgb(40,43,51);overflow-y: scroll;overflow-x: hidden;">
                <li class="layui-nav-item layui-nav-itemed">
                    <div class="layui-btn layui-btn-fluid">短临监测</div>
                    <!-- <a  href="javascript:;" style="display:flex; justify-content:center; align-items:center;">短临监测</a> -->
                    <dl class="layui-nav-child layui-nav-child-c">
                        <dd style="height:140px">
                            <div style="height:100%;width:100%;" class="layui-form">
                                <div id="real_flash" class="layui-form-item" style="padding-top: 5%;">
                                    <label class="layui-form-label">实况同步</label>
                                    <div class="layui-input-block">
                                        <input type="radio" name="real_flash_opt" value="update" title="同步">
                                        <input type="radio" name="real_flash_opt" value="silence" checked="" title="静默">
                                    </div>
                                </div>
                                <div id="warring_div" class="layui-form-item">
                                    <label class="layui-form-label">短临报警</label>
                                    <div class="layui-input-block">
                                        <input type="radio" name="warring_opt" value="warring" title="警报">
                                        <input type="radio" name="warring_opt" value="silence" checked="" title="静音">
                                    </div>
                                </div>
                            </div>
                        </dd>
                        <!-- 警报的相关 -->
                        <script>
                            const warring_obj = {
                                music_audio: undefined,
                                warring_status: "silence",
                                radar_layer: undefined,
                                city: undefined,
                                town: undefined,
                                range: undefined,
                                rain_10min: undefined,
                                wind_10min: undefined,
                                windave_10min: undefined,
                                view_10min: undefined,
                                rain_1hour: undefined,
                                rain_3hour: undefined,
                                rain_6hour: undefined,
                                rain_12hour: undefined,
                                layer_status: undefined,
                                notice_alert: function () {
                                    layui.use('table', function () {
                                        var table = layui.table;
                                        //展示已知数据
                                        table.render({
                                            elem: '#notice_alert_table'
                                            , width: 550
                                            , height: 240
                                            , cellMinWidth: 80
                                            , cols: [[ //标题栏
                                                { field: 'time', title: '时间' }
                                                , { field: 'IIIII', title: '站号' }
                                                , { field: 'Station_Name', title: '站名'}
                                                , { field: 'type', title: '类型' }
                                                , { field: 'value', title: '数据' }
                                                
                                            ]]
                                            , data: [{
                                                'time':"09-13 22:27",
                                                'IIIII':"K8501",
                                                'Station_Name':"大麦屿",
                                                'type':"降水",
                                                'value':"10毫米"
                                            }]
                                            , skin: 'line' //表格风格
                                            // , even: true
                                            , id: 'tabledata_warring'
                                            //,page: true //是否显示分页
                                            //,limits: [5, 7, 10]
                                            , limit: 300 //每页默认显示的数量
                                        });
                                    })
                                    var status = layer.open({
                                        type: 1,
                                        title: "警报",
                                        maxmin: true,
                                        scrollbar: false,
                                        fixed: false,
                                        anim: 0,
                                        offset: 'rb',
                                        moveOut: false,
                                        resize: true,
                                        skin: 'layui-layer-lan', //样式类名
                                        closeBtn: 1, //不显示关闭按钮
                                        area: ['550px', '300px'],
                                        // maxHeight: 600,
                                        // maxWidth: 1400,
                                        anim: 0,
                                        shade: 0,
                                        zIndex: 9999,
                                        shadeClose: false, //开启遮罩关闭
                                        content: $("#notice_alert")
                                    });
                                    warring_obj.layer_status = status
                                },
                                request_warring: function () {
                                    var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                                    $.ajax({
                                        url: "station_zdz_warring",  // 请求的地址
                                        type: "post",  // 请求方式
                                        timeout: 25000, //设置延迟上限
                                        data: {
                                            'csrfmiddlewaretoken': csrf
                                        },
                                        dataType: "json",
                                        success: function (recvdate) {
                                            warring_obj.warring_status = recvdate.warring
                                            var contourf = JSON.parse(recvdate.radar['imglist'][recvdate.radar['imglist'].length - 1])
                                            // const gcoord = require('gcoord');
                                            // var result = gcoord.transform(contourf, gcoord.WGS84, gcoord.GCJ02);
                                            // console.log("坐标转换",result) 
                                            var radarlayer = L.geoJSON(contourf, {
                                                style: function (feature) {
                                                    return { color: feature.properties.stroke, weight: 0.5, fill: true, fillColor: feature.properties.stroke, fillOpacity: 0.7 };
                                                }
                                            }).bindPopup(function (layer) {
                                                return layer.feature.properties.title;
                                            })
                                            warring_obj.radar_layer = radarlayer
                                            var real_flash_opt = $('input[name="real_flash_opt"]:checked').val();
                                            if (real_flash_opt == "update") {
                                                //填充实时的图层 -- leida -- rain -- wind
                                                map_toolbox_object.flash_map()
                                                // leida
                                                if (warring_obj.radar_layer) {
                                                    warring_obj.radar_layer.addTo(map_toolbox_object.current_map)
                                                }
                                                // rain
                                                warring_obj.rain_update(JSON.parse(recvdate.rain))
                                                //wind
                                                warring_obj.wind_update(JSON.parse(recvdate.wind))
                                            }
                                            var warring_opt = $('input[name="warring_opt"]:checked').val();




                                        }
                                    })

                                },
                                warring_config: function () {
                                    var post_data = {
                                        // 设置蹭
                                        "city": warring_obj.city,
                                        "town": warring_obj.town,
                                        "range": warring_obj.range,
                                        // 参数层
                                        "rain_10min": warring_obj.rain_10min,
                                        "wind_10min": warring_obj.wind_10min,
                                        "windave_10min": warring_obj.windave_10min,
                                        "view_10min": warring_obj.view_10min,
                                        "rain_1hour": warring_obj.rain_1hour,
                                        "rain_3hour": warring_obj.rain_3hour,
                                        "rain_6hour": warring_obj.rain_6hour,
                                        "rain_12hour": warring_obj.rain_12hour
                                    }
                                },
                                popNotice: function () {
                                    if (Notification.permission == "granted") {

                                        var n = new Notification("实况警报:", {
                                            // tag: "testTag",
                                            icon: "http://127.0.0.1:9991/media/img/warring.png",
                                            body: `on body, time: ${new Date().toISOString()}`
                                        });

                                        n.onshow = function (event) {
                                            console.log(`on show, time: ${new Date().toISOString()}`);
                                        };

                                        n.onclick = function (event) {
                                            console.log(`on click, time: ${new Date().toISOString()}`);
                                            // window.open("http://127.0.0.1:9991/station_zdz");
                                            // layer.open({
                                            //     type: 1,
                                            //     title: "报警弹窗",
                                            //     maxmin: true,
                                            //     moveOut: true,
                                            //     // resize:true,
                                            //     skin: 'layui-layer-lan', //样式类名
                                            //     closeBtn: 1, //不显示关闭按钮
                                            //     area: ['1200px', '600px'],
                                            //     maxHeight: 600,
                                            //     maxWidth: 1200,
                                            //     anim: 0,
                                            //     shade: 0,
                                            //     zIndex: 9999,
                                            //     shadeClose: false, //开启遮罩关闭
                                            //     content: $("#hidden_station")
                                            // });
                                        };

                                        n.onclose = function (event) {
                                            console.log(`on close, time: ${new Date().toISOString()}`);

                                        };
                                    }
                                },
                                rain_update: function (data) {

                                    data.forEach(function (item) {
                                        var tooltips = item.Station_Name + "-" + item.Station_Id_C + "<br>" + "    纬度:" + item.Lat.toFixed(2).toString() + "  " + "经度:" + item.Lon.toFixed(2).toString() + "<br>" + "    " + item.City + "-" + item.Cnty + "-" + item.Town
                                        if (item.PRE > 0 && item.PRE <= 1) {
                                            var colors = "white"
                                        }
                                        else if (item.PRE > 1 && item.PRE <= 1.5) {
                                            var colors = "rgb(140,246,130)"
                                        }
                                        else if (item.PRE > 1.5 && item.PRE <= 7) {
                                            var colors = "rgb(0,191,27)"
                                        }
                                        else if (item.PRE > 7 && item.PRE <= 15) {
                                            var colors = "rgb(62,185,255)"
                                        }
                                        else if (item.PRE > 15 && item.PRE <= 40) {
                                            var colors = "rgb(25,0,235)"
                                        }
                                        else if (item.PRE > 40 && item.PRE <= 50) {
                                            var colors = "rgb(255,0,255)"
                                        }
                                        else if (item.PRE > 50) {
                                            var colors = "rgb(140,0,65)"
                                        }
                                        var latlng = L.latLng(item.Lat, item.Lon);
                                        // 添加散点插件
                                        var c = L.circleMarker(latlng, {
                                            stationname: item.Station_Name,
                                            stationnum: item.Station_Id_C,
                                            weight: 0,
                                            radius: 8,
                                            opacity: 0,
                                            fill: false,
                                            color: colors,
                                            fillColor: colors,
                                            fillOpacity: 1,
                                            labelStyle: {
                                                text: item.PRE,
                                                collisionFlg: false,
                                                // offsetY: -25,
                                                scale: 1.5,
                                                weight: 3,
                                                rotation: 0,
                                                fillStyle: colors,
                                                zIndex: 60
                                            }
                                        }).bindTooltip(tooltips, {
                                            direction: "top",
                                            offset: L.point(0, -10)
                                        }).openTooltip()
                                        c.addTo(map_toolbox_object.current_map)

                                    })

                                },
                                wind_update: function (data) {
                                    data.forEach(function (item) {
                                        var tooltips = item.Station_Name + "-" + item.Station_Id_C + "<br>" + "    纬度:" + item.Lat.toFixed(2).toString() + "  " + "经度:" + item.Lon.toFixed(2).toString() + "<br>" + "    " + item.City + "-" + item.Cnty + "-" + item.Town
                                        // var latlng = L.latLng(item.Lat, item.Lon);
                                        if (item.WIN_S_Gust_Max <= 17.3) {
                                            var colors = "#E71FED" // 粉色
                                        }
                                        else {
                                            var colors = "red" // 粉色
                                        }
                                        var latlng = L.latLng(item.Lat, item.Lon);
                                        var icon = L.WindBarb.icon({
                                            color: "red",
                                            deg: item.WIN_D_Gust_Max,
                                            pointRadius: 8,
                                            strokeColor: colors,
                                            strokeLength: 25,
                                            forceDir: true,
                                            // barbSpaceing:4,
                                            // barbHeight:20,
                                            fillColor: colors,
                                            speed: (item.WIN_S_Gust_Max)
                                        });
                                        var marker = L.marker([item.Lat, item.Lon], {
                                            icon: icon,
                                            name: item.Station_Id_C,
                                            stationname: item.Station_Name,
                                            stationnum: item.Station_Id_C,
                                            deg: item.WIN_D_Gust_Max,
                                            sped: item.WIN_S_Gust_Max,
                                            station: item.Station_Name
                                        }).bindTooltip(tooltips, {
                                            direction: "top",
                                            offset: L.point(0, -10)
                                        }).openTooltip().addTo(map_toolbox_object.current_map)

                                    })

                                },
                            };
                            //报警设置
                            $("#warring_div").click(function () {
                                var warring_opt = $('input[name="warring_opt"]:checked').val();
                                if (warring_opt == "warring") {
                                    layer.open({
                                        type: 1,
                                        title: "同步报警",
                                        maxmin: false,
                                        scrollbar: false,
                                        fixed: false,
                                        // offset: 'rt',
                                        moveOut: false,
                                        resize: false,
                                        skin: 'layui-layer-lan', //样式类名
                                        closeBtn: 1, //不显示关闭按钮
                                        area: ['900px', '650px'],
                                        // maxHeight: 600,
                                        // maxWidth: 1400,
                                        anim: 0,
                                        shade: 0,
                                        zIndex: 9999,
                                        shadeClose: false, //开启遮罩关闭
                                        content: $("#warring_ui")
                                    });
                                }
                                else if (warring_opt == "silence") {
                                    // 更新警报的信息
                                    warring_obj.warring_status = "silence"
                                    var arr = [];
                                    $("input[name='warring_check']:checked").each(function () {
                                        arr.push(this.value);
                                    });
                                    // console.log(arr)
                                    arr.forEach(function (item) {
                                        var index = "#" + item.toString()
                                        warring_obj[item] = $(index).val()
                                    })
                                    // console.log(new Date(), "取消警报1")
                                    if (warring_obj.music_audio) {
                                        warring_obj.music_audio.pause();
                                        warring_obj.music_audio = undefined
                                        // console.log(new Date(), "取消警报1")
                                    }
                                }
                            })

                            // 报警请求数据
                            var Date2 = window.setInterval(function () {
                                var radar_opt = $('input[name="radar_opt"]:checked').val();
                                var real_flash_opt = $('input[name="real_flash_opt"]:checked').val(); // 是否叠加同步
                                var warring_opt = $('input[name="warring_opt"]:checked').val();// 是否叠加报警
                                var url = "http://127.0.0.1:9991/media/mp3/warring.mp3"
                                // var url = "http://127.0.0.1:9991/media/mp3/ddd.wav"
                                if ((warring_opt == "warring") || (real_flash_opt == "update")) {
                                    // 警报和同步任意触发
                                    warring_obj.request_warring()
                                    var warring_class = $("#warring_class").val() // 弹出框的数据
                                    if (warring_opt == "warring") {
                                        // 需要报警
                                        if (warring_class == "warring") {
                                            // 报警
                                            if (warring_obj.warring_status = "warring") {
                                                if (warring_obj.music_audio) {
                                                    warring_obj.music_audio.play();
                                                }
                                                else {
                                                    let audio = new Audio(url);
                                                    warring_obj.music_audio = audio
                                                    warring_obj.music_audio.autoplay = true;
                                                    warring_obj.music_audio.play();
                                                }
                                            }
                                        }
                                        else if (warring_class == "notification") {
                                            // 弹出框
                                            if (warring_obj.warring_status = "warring") {
                                                if (warring_obj.layer_status) {
                                                    warring_obj.notice_alert();
                                                }
                                                else {
                                                    warring_obj.notice_alert();
                                                }
                                            }
                                        }
                                    }
                                }
                                else if (warring_opt == "silence") {
                                    warring_obj.warring_status = "silence"
                                    if (warring_obj.layer_status) {
                                        layer.close(warring_obj.layer_status);
                                    }
                                }
                            }, 1000 * 5) // 间隔1秒就打印
                        </script>
                    </dl>
                </li>
                <li class="layui-nav-item layui-nav-itemed">
                    <div class="layui-btn layui-btn-fluid">实况统计</div>
                    <dl class="layui-nav-child">
                        <dd style="height:300px">
                            <div style="height:100%;width:100%;margin-top: 5%;" class="layui-form">
                                <label class="layui-form-label">数据类型</label>
                                <div class="layui-input-inline" style="width: 38%;padding-left:28px;">
                                    <select id="real_class">
                                        <option value=""></option>
                                        <option value="rain" selected="">降水</option>
                                        <option value="sped">风级</option>
                                        <option value="wind">风力</option>
                                        <option value="tmax">高温</option>
                                        <option value="tmin">低温</option>
                                        <option value="view">能见度</option>
                                    </select>
                                </div>
                                <div class="layui-input-inline" style="width: 20%;">
                                    <select id="real_times">
                                        <option value=""></option>
                                        <option value="24hours">24小时</option>
                                        <option value="12hours">12小时</option>
                                        <option value="6hours">6小时</option>
                                        <option value="3hours">3小时</option>
                                        <option value="2hours">2小时</option>
                                        <option value="1hours">1小时</option>
                                        <option value="45mins">45分钟</option>
                                        <option value="30mins">30分钟</option>
                                        <option value="now" selected="">实时</option>
                                    </select>
                                </div>

                                <div class="layui-form-item">
                                    <label class="layui-form-label">数据级别</label>
                                    <div class="layui-input-block"
                                        style="background-color:rgb(28,30,36);width:49%;margin-top: 6%;">
                                        <select id="table_type">
                                            <option value=""></option>
                                            <option value="nation">国家站</option>
                                            <option value="regin">区域站</option>
                                            <option value="all">所有站</option>
                                            <option value="main">骨干站</option>
                                            <option value="auto" selected="">全自动</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="layui-form-item" style="margin-top:15px;">
                                    <label class="layui-form-label">显示选项</label>
                                    <div class="layui-input-block" style="">
                                        <input type="radio" name="boundary_type" value="current" title="当前" checked="">
                                        <input type="radio" name="boundary_type" value="all" title="全省">
                                    </div>
                                </div>
                                <div id="radar_plot" class="layui-form-item" style=";margin-top: 5%;">
                                    <label class="layui-form-label">叠加回波</label>
                                    <div class="layui-input-block">
                                        <input type="radio" name="radar_opt" value="plot" title="叠加">
                                        <input type="radio" name="radar_opt" value="none" checked="" title="隐藏">
                                    </div>
                                </div>
                                <div id="radar_sec" class="layui-form-item" style=";margin-top: 5%;">
                                    <label class="layui-form-label">雷达剖面</label>
                                    <div class="layui-input-block">
                                        <input id="sec_start" type="radio" name="radar_sec_opt" value="plot" title="绘制">
                                        <input id="sec_end" type="radio" name="radar_sec_opt" value="none" checked=""
                                            title="隐藏">
                                    </div>
                                </div>



                            </div>
                        </dd>
                        <dd style="margin-left:0;padding-left: 0;">
                            <div class="layui-input-inline" style="width: 90%;margin-top: 15px;margin-bottom: 10px;">
                                <button id="real_plot" type="button" class="layui-btn layui-btn-sm"
                                    style="float: right;margin-left: 10px;">加载</button>
                                <button id="real_single" type="button" class="layui-btn layui-btn-sm"
                                    style="float: right;">单站</button>
                                <button id="real_contour" type="button" class="layui-btn layui-btn-sm"
                                    style="float: right;">快报</button>
                                <!-- <button type="button" class="layui-btn layui-btn-sm"
                                    style="float: right;">通报</button> -->
                                <button id="extra_real_plot" type="button" class="layui-btn layui-btn-sm"
                                    style="float: right;">绘图</button>
                            </div>
                        </dd>
                    </dl>
                </li>
                <!-- 历史实况的统计信息 -->
                <li class="layui-nav-item layui-nav-itemed">
                    <button type="button" class="layui-btn layui-btn-fluid ">整点回放</button>
                    <dl class="layui-nav-child">
                        <dd style="height:120px;padding-top: 5%;">
                            <label class="layui-form-label">时间</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="historydate" placeholder="yyyy-MM-dd"
                                    style="width:80">
                            </div>
                            <div style="height:100%;width:100%;margin-top: 5%;" class="layui-form">
                                <label class="layui-form-label">数据</label>
                                <div class="layui-input-inline" style="width: 30%;padding-left:1px;">
                                    <select name="history_class" lay-filter="history_class">
                                        <option value=""></option>
                                        <option value="rain" selected="">降水</option>
                                        <option value="sped">风级</option>
                                        <option value="wind">风力</option>
                                        <option value="tmax">高温</option>
                                        <option value="tmin">低温</option>
                                        <option value="view">能见度</option>
                                    </select>
                                </div>
                                <div class="layui-input-inline" style="width: 31%;">
                                    <select name="history_hours" lay-filter="history_hours" id="history_hours">
                                        <!-- <option value=""></option>                            
                                        <option value="45mins">45分钟</option>
                                        <option value="30mins">30分钟</option>
                                        <option value="now" selected="">实时</option>                                     -->
                                    </select>
                                </div>
                            </div>

                        </dd>
                        <!-- 历史数据的按钮 -->
                        <dd style="height:50px;padding-right:25px;">
                            <button type="button" class="layui-btn layui-btn-sm"
                                style="float:right;margin-left: 10px;">查询</button>
                            <button type="button" class="layui-btn layui-btn-sm" style="float:right;">刷新</button>
                        </dd>
                        <script>
                            layui.use('laydate', function () {
                                var laydate = layui.laydate;
                                laydate.render({
                                    elem: '#historydate'
                                    , type: 'datetime'
                                    , value: new Date()
                                });
                            })
                            layui.use(['form'], function () {
                                // layui引入需要的组件
                                var $ = layui.jquery;
                                var layer = layui.layer;
                                var form = layui.form;
                                form.render('select');
                                // 第二步 监听父级，每当父级发生变化时，渲染子级的值
                                form.on('select(history_class)', function (data) {
                                    var opt = {
                                        "rain": ["6hours", "3hours"],
                                        "sped": ["6hours", "3hours", "1hours"],
                                        "wind": ["6hours", "3hours", "1hours"],
                                        "tmax": ["12hours", "24hours"],
                                        "tmin": ["12hours", "24hours"],
                                        "view": ["24hours"]
                                    }
                                    var select_names = {
                                        "rain": ["近6小时", "近3小时"],
                                        "sped": ["近6小时", "近3小时", "近1小时"],
                                        "wind": ["近6小时", "近3小时", "近1小时"],
                                        "tmax": ["12小时", "24小时"],
                                        "tmin": ["12小时", "24小时"],
                                        "view": ["24小时"]
                                    }
                                    var select_class = data.value; // 选择的数据类型   
                                    // 清空数据
                                    $('#history_hours').empty();
                                    var html_all = ""
                                    opt[select_class].forEach(function (item, index) {
                                        var html_str = "<option value='" + opt[select_class][index] + "'>" + select_names[select_class][index] + "</option>";
                                        html_all = html_all + html_str
                                    })
                                    $('#history_hours').html(html_all)
                                    form.render('select');

                                });

                            });
                        </script>
                    </dl>
                </li>

                <!-- <li class="layui-nav-item">      
                    <a  href="javascript:;" style="display:flex; justify-content:center; align-items:center;">文字快报</a>
                    <dl class="layui-nav-child">
                        <dd style="height:140px"></dd>
                    </dl>
                </li>
                <li class="layui-nav-item">
                    <a  href="javascript:;" style="display:flex; justify-content:center; align-items:center;">实况绘图</a>
                    <dl class="layui-nav-child">
                        <dd style="height:140px"></dd>
                    </dl>
                </li> -->

            </ul>
            <!-- </div> -->
            <!-- 这里是地图 -->
            <div id="map" style="width:85%;height: 100%">
            </div>
            <script>
                // 等待加载时间
                function showLoad() {
                    return layer.msg('程序加载....', { icon: 16, shade: [0.5, '#f5f5f5'], scrollbar: false, offset: 'auto', time: 100000 });
                }
                // 关闭等待加载时间
                function closeLoad(index) {
                    layer.close(index);
                }
                // 地图加载的核心
                const map_toolbox_object = {
                    start_date: undefined,// 起止时间
                    end_date: undefined, // 终结时间
                    current_data_type:undefined,
                    recv_all_data: undefined, // 接收数据
                    recv_single_data: undefined, // 接收单点数据
                    single_name: undefined,// 单站的值
                    current_map: undefined, // 当前地图层
                    current_chart: undefined,// 当前地图标
                    current_layer: undefined, // 当前绘图层
                    current_marker_list: [], // 当前散点阵列
                    current_points: undefined,// 当前绘图数据
                    // current_points :undefined,// 当前绘制曲线的option
                    boundaries: undefined,
                    get_today: function () {
                        var today = new Date()
                        var y = today.getFullYear();
                        var m = today.getMonth() + 1 < 10 ? "0" + (today.getMonth() + 1) : today.getMonth() + 1;
                        var d = today.getDate() < 10 ? "0" + today.getDate() : today.getDate();
                        var h = today.getHours() < 10 ? "0" + today.getHours() : today.getHours();
                        var min = today.getMinutes() < 10 ? "0" + today.getMinutes() + ":00" : today.getMinutes() + ":00"
                        var today_str = y + "-" + m + "-" + d + " " + h + ":" + min;
                        return today_str
                    },
                    color_level: function (plot_type) {
                        // 降水
                        var rain_options = {
                            zProperty: "value",
                            commonProperties: {
                                "fill-opacity": 1
                            },
                            breaksProperties: [
                                { fill: "rgb(255,255,255)" },// 0 mm
                                { fill: "rgb(140,246,130)" },// 0.1
                                { fill: "rgb(0,191,27)" },// 10
                                { fill: "rgb(62,185,255)" },// 25
                                { fill: "rgb(25,0,235)" },// 50
                                { fill: "rgb(255,0,255)" },// 100
                                { fill: "rgb(140,0,65)" } //250
                            ]
                        };
                        // 气温
                        var temp_options = {
                            zProperty: "value",
                            commonProperties: {
                                "fill-opacity": 1
                            },
                            breaksProperties: [
                                { fill: "rgb(31,31,255)" },//7 
                                { fill: "rgb(59,59,255)" },//6
                                { fill: "rgb(87,87,255)" },// 5
                                { fill: "rgb(114,114,255)" },// 4
                                { fill: "rgb(143,143,255)" },// 3
                                { fill: "rgb(171,171,255)" },// 2
                                { fill: "rgb(199,199,255)" }, // 1
                                { fill: "rgb(248,224,139)" },// 1
                                { fill: "rgb(243,195,111)" },// 2
                                { fill: "rgb(239,167,110)" },// 3
                                { fill: "rgb(236,138,81)" },//  4
                                { fill: "rgb(234,110,81)" },// 5
                                { fill: "rgb(232,81,51)" },// 6
                                { fill: "rgb(230,51,51)" } // 7                         
                            ]
                        };
                        // 能见度
                        var view_options = {
                            zProperty: "value",
                            commonProperties: {
                                "fill-opacity": 0.9
                            },
                            breaksProperties: [
                                { fill: "rgb(169,52,52)" },// 0-50
                                { fill: "rgb(255,150,0)" },// 50-200
                                { fill: "rgb(255,253,55)" },// 200-500
                                { fill: "rgb(55,216,253)" },// 500-1000
                                { fill: "rgb(168,242,243)" },// 1000-2000
                                { fill: "rgb(220,246,247)" },// 2000-5000
                                { fill: "rgb(247,252,252)" },// 5000
                            ]
                        };
                        // 风力
                        var wind_options = {
                            zProperty: "value",
                            commonProperties: {
                                "fill-opacity": 0.9
                            },
                            breaksProperties: [
                                { fill: "rgb(219,212,204)" },// 0 
                                { fill: "rgb(193,192,198)" },// 0.3
                                { fill: "rgb(167,210,203)" },// 1.6
                                { fill: "rgb(219,220,162)" },// 3.4 
                                { fill: "rgb(223,193,155)" },// 5.5
                                { fill: "rgb(217,158,115)" },// 8 
                                { fill: "rgb(226,106,78)" },// 10.8
                                { fill: "rgb(217,64,64)" },// 13.9
                                { fill: "rgb(190,47,574)" }// 17.2
                            ]
                        };
                        if (plot_type == "rain") {
                            if ($("#real_times").val() == "24hours") {
                                var levelV = [-999, 1, 10, 25, 50, 100, 250, 9990]
                            }
                            else if ($("#real_times").val() == "12hours") {
                                var levelV = [-999, 1, 5, 15, 30, 70, 140, 9990]
                            }
                            else if ($("#real_times").val() == "6hours") {
                                var levelV = [-999, 1, 4, 13, 25, 60, 120, 9990]
                            }
                            else if ($("#real_times").val() == "3hours") {
                                var levelV = [-999, 1, 3, 10, 20, 50, 70, 9990]
                            }
                            else {
                                var levelV = [-999, 1, 1.5, 7, 15, 40, 50, 9990]
                            }
                            return {
                                levelV: levelV,
                                isobands_options: rain_options
                            }
                        }
                        else if (plot_type == "temp") {
                            // console.log(map_toolbox_object.current_points)
                            var arrdata = []
                            map_toolbox_object.current_points.forEach(function (item) {
                                arrdata.push(item.properties.value)
                            })
                            var max = Math.max.apply(null, arrdata) + 1
                            var min = Math.min.apply(null, arrdata) - 1
                            var steps = (max - min) / 14
                            console.log(steps, max, min)
                            var levelV = []
                            // generaterArray(min, max, steps)
                            for (var i = 0; i < 14; i++) {
                                var item = min + steps * i
                                levelV.push(item)
                            }
                            var isobands_options = temp_options
                            return {
                                levelV: levelV,
                                isobands_options: isobands_options
                            }
                        }
                        else if (plot_type == "wind") {
                            return {
                                levelV: [0, 3.4, 5.5, 8, 10.8, 13.9, 17.2, 21.0, 40.2],
                                isobands_options: wind_options
                            }
                        }
                        else if (plot_type == "view") {
                            return {
                                levelV: [-999, 5, 20, 50, 100, 200, 500, 300000],
                                isobands_options: view_options
                            }
                        }

                    },
                    getMaxAttribute: function (inLevelV, inGrid, inBreaksProperties) {
                        //定义变量
                        let levelArray = [];
                        let levelLength = inLevelV.length;
                        inLevelV.forEach(function (item, index) {
                            if (index < levelLength - 2) levelArray.push(0);
                        });
                        //统计每个等级中网格点数量
                        inGrid.features.map((i) => {
                            inLevelV.forEach(function (item, index) {
                                if (index < levelLength - 3) {
                                    if (i.properties.value >= inLevelV[index] && i.properties.value < inLevelV[index + 1]) levelArray[index]++;
                                }
                                if (index == levelLength - 2) {
                                    if (i.properties.value >= inLevelV[index]) levelArray[index]++;
                                }
                            });
                        });
                        //取等级中网格点最多的值
                        let maxIndex = -1;
                        let maxV = 0;
                        levelArray.forEach(function (item, index) {
                            if (maxV < item) { maxV = item; maxIndex = index; }
                        });
                        let value = '';
                        let fill = '';
                        if (maxIndex != -1) {
                            value = inLevelV[maxIndex] + '-' + inLevelV[maxIndex + 1];
                            fill = inBreaksProperties[maxIndex].fill;
                        }
                        return [value, fill]
                    },
                    return_boundaries: function (shpdata) {
                        var bounddata = {
                            type: "FeatureCollection",
                            name: "boundaries",
                            crs: { type: "name", properties: { name: "urn:ogc:def:crs:OGC:1.3:CRS84" } },
                            features: shpdata
                        }
                        return {
                            boundaries: bounddata
                        }
                    },
                    flash_map: function () {
                        if (map_toolbox_object.current_map) {
                            map_toolbox_object.current_map.eachLayer(function (layer) {
                                if (!layer._container || ('' + jQuery(layer._container).attr('class')).replace(/\s/g, '') != 'leaflet-layer') {
                                    layer.remove();
                                }
                            });
                        }
                        var boundaries = map_toolbox_object.return_boundaries(zhejianglist[0].features).boundaries
                        map_toolbox_object.boundaries = boundaries
                        var canvasLabel = new L.CanvasLabel({
                            defaultLabelStyle: {
                                collisionFlg: true,
                                scale: 1,
                                strokeStyle: "#000",
                                fillStyle: "#fff",
                                lineWidth: 3
                            }
                        });
                        var lines = L.geoJSON(boundaries, {
                            style: function (feature) {
                                return { color: 'black', fill: false, weight: 3, fillOpacity: 0.1 };
                            }
                        }).addTo(map_toolbox_object.current_map)
                        // var radar_opt = $('input[name="radar_opt"]:checked').val();  
                        // if (radar_opt=="plot"){
                        //     if(warring_obj.radar_layer){
                        //         warring_obj.radar_layer.addTo(map_toolbox_object.current_map)
                        //     }                    
                        // }
                        if ($("#village_line").val() == "wenling") {
                            var boundaries_village = map_toolbox_object.return_boundaries(wl_json.features).boundaries
                            var lines_village = L.geoJSON(boundaries_village, {
                                style: function (feature) {
                                    return { color: 'red', weight: 3, fillOpacity: 0.01 };
                                }
                            }).addTo(map_toolbox_object.current_map)
                        }
                        else if ($("#village_line").val() == "yuhuan") {
                            var boundaries_village = {
                                type: "FeatureCollection",
                                name: "boundaries",
                                crs: { type: "name", properties: { name: "urn:ogc:def:crs:OGC:1.3:CRS84" } },
                                features: yuhuan_map
                            };
                            var lines_village = L.geoJSON(boundaries_village, {
                                style: function (feature) {
                                    return { color: 'red', weight: 3, fillOpacity: 0.01 };
                                }
                            }).addTo(map_toolbox_object.current_map)
                        }
                        //
                        else if ($("#village_line").val() == "huangyan") {
                            var boundaries_village = map_toolbox_object.return_boundaries(hy_json.features).boundaries
                            var lines_village = L.geoJSON(boundaries_village, {
                                style: function (feature) {
                                    return { color: 'red', weight: 3, fillOpacity: 0.01 };
                                }
                            }).addTo(map_toolbox_object.current_map)
                        }
                        else if ($("#village_line").val() == "luqiao") {
                            var boundaries_village = map_toolbox_object.return_boundaries(lq_json.features).boundaries
                            var lines_village = L.geoJSON(boundaries_village, {
                                style: function (feature) {
                                    return { color: 'red', weight: 3, fillOpacity: 0.01 };
                                }
                            }).addTo(map_toolbox_object.current_map)
                        }
                        else if ($("#village_line").val() == "jiaojiang") {
                            var boundaries_village = map_toolbox_object.return_boundaries(jj_json.features).boundaries
                            var lines_village = L.geoJSON(boundaries_village, {
                                style: function (feature) {
                                    return { color: 'red', weight: 3, fillOpacity: 0.01 };
                                }
                            }).addTo(map_toolbox_object.current_map)
                        }
                        else if ($("#village_line").val() == "xianju") {
                            var boundaries_village = map_toolbox_object.return_boundaries(xj_json.features).boundaries
                            var lines_village = L.geoJSON(boundaries_village, {
                                style: function (feature) {
                                    return { color: 'red', weight: 3, fillOpacity: 0.01 };
                                }
                            }).addTo(map_toolbox_object.current_map)
                        }
                        else if ($("#village_line").val() == "linhai") {
                            var boundaries_village = map_toolbox_object.return_boundaries(lh_json.features).boundaries
                            var lines_village = L.geoJSON(boundaries_village, {
                                style: function (feature) {
                                    return { color: 'red', weight: 3, fillOpacity: 0.01 };
                                }
                            }).addTo(map_toolbox_object.current_map)
                        }
                        else if ($("#village_line").val() == "tiantai") {
                            var boundaries_village = map_toolbox_object.return_boundaries(tt_json.features).boundaries
                            var lines_village = L.geoJSON(boundaries_village, {
                                style: function (feature) {
                                    return { color: 'red', weight: 3, fillOpacity: 0.01 };
                                }
                            }).addTo(map_toolbox_object.current_map)
                        }
                        else if ($("#village_line").val() == "sanmen") {
                            var boundaries_village = map_toolbox_object.return_boundaries(sm_json.features).boundaries
                            var lines_village = L.geoJSON(boundaries_village, {
                                style: function (feature) {
                                    return { color: 'red', weight: 3, fillOpacity: 0.01 };
                                }
                            }).addTo(map_toolbox_object.current_map)
                        }



                        // map_toolbox_object.randar_tables()
                        //清空数据


                        map_toolbox_object.recv_all_data = undefined
                        map_toolbox_object.current_marker_list = []

                    },
                    init: function () {
                        //地图初始化
                        if (map_toolbox_object.current_map) {
                            map_toolbox_object.current_map.eachLayer(function (layer) {
                                if (!layer._container || ('' + jQuery(layer._container).attr('class')).replace(/\s/g, '') != 'leaflet-layer') {
                                    layer.remove();
                                }
                            });
                            // var boundaries = map_toolbox_object.return_boundaries(taizhoulist).boundaries
                            var boundaries = map_toolbox_object.return_boundaries(zhejianglist[0].features).boundaries
                            map_toolbox_object.boundaries = boundaries
                            var canvasLabel = new L.CanvasLabel({
                                defaultLabelStyle: {
                                    collisionFlg: true,
                                    scale: 1,
                                    strokeStyle: "#000",
                                    fillStyle: "#fff",
                                    lineWidth: 3
                                }
                            });
                            var lines = L.geoJSON(boundaries, {
                                style: function (feature) {
                                    return { color: 'black', weight: 3, fillOpacity: 0.1 };
                                }
                            })

                            var map_zdz = new L.Map('map', {
                                center: new L.LatLng(28.6, 120.9),//110.763, 41.376   39.62353145, 121.9937485
                                crs: L.CRS.EPSG3857,
                                renderer: canvasLabel,
                                zoom: 9, //4
                                maxZoom: 12,
                                minZoom: 8,
                                zoomControl: false,
                                dragging: true,
                                scrollWheelZoom: true,
                                doubleClickZoom: false,
                                attributionControl: false, //是否去除右下角标志
                                bounds: turf.bbox(boundaries),
                                maxBounds: bound,
                                maxBoundsViscosity: 1.0,
                                layers: [lines]
                            });


                            map_toolbox_object.current_map = map_zdz

                        }
                        else {
                            // var boundaries = map_toolbox_object.return_boundaries(taizhoulist).boundaries                       
                            var boundaries = map_toolbox_object.return_boundaries(zhejianglist[0].features).boundaries
                            map_toolbox_object.boundaries = boundaries
                            var canvasLabel = new L.CanvasLabel({
                                defaultLabelStyle: {
                                    collisionFlg: true,
                                    scale: 1,
                                    // strokeStyle: "#000",
                                    fillStyle: "white",
                                    lineWidth: 3
                                }
                            });
                            var lines = L.geoJSON(boundaries, {
                                style: function (feature) {
                                    return { color: 'black', fill: false, weight: 3, fillOpacity: 0.1 };
                                }
                            })
                            var corner1 = L.latLng(26, 115),
                                corner2 = L.latLng(34, 125),
                                bound = L.latLngBounds(corner1, corner2);


                            var map_zdz = new L.Map('map', {
                                center: new L.LatLng(28.6, 120.9),//110.763, 41.376   39.62353145, 121.9937485
                                crs: L.CRS.EPSG3857,
                                renderer: canvasLabel,
                                zoom: 9, //4
                                maxZoom: 12,
                                minZoom: 8,
                                zoomControl: false,
                                dragging: true,
                                scrollWheelZoom: true,
                                doubleClickZoom: false,
                                attributionControl: false, //是否去除右下角标志
                                bounds: turf.bbox(boundaries),
                                maxBounds: bound,
                                maxBoundsViscosity: 1.0,
                                layers: [lines]
                            });
                            map_toolbox_object.current_map = map_zdz


                            L.TileLayer.Custom = L.TileLayer.extend({
                                getTileUrl: function (coords) {
                                    url = 'static/map_geo/' + coords.z + '/' + coords.x + '/' + coords.y + '.jpg';
                                    return url;
                                }
                            })
                            L.tileLayer.Custom = function () { return new L.TileLayer.Custom(); }
                            var layer_geo = L.tileLayer.Custom()

                            L.TileLayer.Custom = L.TileLayer.extend({
                                getTileUrl: function (coords) {
                                    url = 'static/map_street/' + coords.z + '/' + coords.x + '/' + coords.y + '.png';
                                    return url;
                                }
                            })
                            L.tileLayer.Custom = function () { return new L.TileLayer.Custom(); }
                            var layer_street = L.tileLayer.Custom()

                            //
                            var iconLayersControl = new L.Control.IconLayers(
                                [
                                    {
                                        title: '地形', // use any string
                                        layer: layer_geo, // any ILayer
                                        icon: 'media/img/geo.png' // 80x80 icon
                                    },
                                    {
                                        title: '街道',
                                        layer: layer_street,
                                        icon: 'media/img/street.png'
                                    }
                                ], {
                                position: 'bottomleft',
                                maxLayersInRow: 2
                            }
                            );
                            iconLayersControl.addTo(map_zdz);





                            // L.tileLayer.Custom().addTo(map_zdz);
                            // 

                            // 添加地图上的按钮
                            // L.Control.Logo = L.Control.extend({
                            //     options: {
                            //         position: 'topright' //初始位置

                            //     },

                            //     initialize: function (options) {
                            //         L.Util.extend(this.options, options);

                            //     },
                            //     onAdd: function (map) {
                            //         //创建一个class为 leaflet-control-container的div
                            //         this._container = L.DomUtil.create('div', 'leaflet-control-container');
                            //         this._container.style = "width:150px;height:500px;border: 1px solid black"
                            //         //创建一个图片要素
                            //         var content = L.DomUtil.create('button', 'layui-btn');
                            //         content.setAttribute('type','button')
                            //         content.innerHTML = "666"              
                            //         // img.id = 'leaflet-control-clegend';
                            //         // img.type = 'img';
                            //         // // img.src = "./logo.jpg";
                            //         // this._legendimg = content;

                            //         //创建一个关闭控件的按钮
                            //         // var closeButton = L.DomUtil.create('a', 'leaflet-control-button');
                            //         // closeButton.text = 'X';
                            //         // closeButton.id = 'leaflet-control-geosearch-close';
                            //         // this._closebutton = closeButton;


                            //         this._container.appendChild(content);
                            //         // this._container.appendChild(this._closebutton);

                            //         //注册关闭事件
                            //         // L.DomEvent.addListener(this._closebutton, 'click', this._onCloseControl, this);

                            //         return this._container;
                            //     },
                            //     /**
                            //      *
                            //      * @private
                            //      */
                            //     _onCloseControl: function () {
                            //         this._map.options.Legend = false;
                            //         this.remove(this._map);
                            //     },
                            // });

                            // L.control.logo = function (options) {
                            //     return new L.Control.Logo(options)
                            // };
                            // L.control.logo().addTo(map_toolbox_object.current_map);

                        }
                    },
                    wind_dir: function (dFy) {
                        if (((dFy >= 0) && (dFy < 11.25)) || ((dFy > 348.75) && (dFy <= 360))) {
                            var dfytest = "N"
                        }
                        else if ((dFy >= 11.25) && (dFy < 33.75)) {
                            var dfytest = "NNW"
                        }
                        else if ((dFy >= 33.75) && (dFy < 56.25)) {
                            var dfytest = "NW"
                        }
                        else if ((dFy >= 56.25) && (dFy < 78.75)) {
                            var dfytest = "WNW"
                        }
                        else if ((dFy >= 78.75) && (dFy < 101.25)) {
                            var dfytest = "W"
                        }
                        else if ((dFy >= 101.25) && (dFy < 123.75)) {
                            var dfytest = "WSW"
                        }
                        else if ((dFy >= 123.75) && (dFy < 146.25)) {
                            var dfytest = "SW"
                        } // 
                        else if ((dFy >= 146.25) && (dFy < 168.75)) {
                            var dfytest = "SSW"
                        }
                        else if ((dFy >= 168.75) && (dFy < 191.25)) {
                            var dfytest = "S"
                        }
                        else if ((dFy >= 191.25) && (dFy < 213.75)) {
                            var dfytest = "SSE"
                        }
                        else if ((dFy >= 213.75) && (dFy < 236.25)) {
                            var dfytest = "SE"
                        }
                        else if ((dFy >= 236.25) && (dFy < 258.75)) {
                            var dfytest = "ESE"
                        }
                        else if ((dFy >= 258.75) && (dFy < 281.25)) {
                            var dfytest = "E"
                        }
                        else if ((dFy >= 281.25) && (dFy < 303.75)) {
                            var dfytest = "ENE"
                        }
                        else if ((dFy >= 303.75) && (dFy < 326.25)) {
                            var dfytest = "NE"
                        }
                        else if ((dFy >= 326.25) && (dFy < 348.75)) {
                            var dfytest = "NNE"
                        }
                        return dfytest
                    },
                    plot_layer: function (pointdata, click_type) {
                        // 刷新地图
                        map_toolbox_object.flash_map()
                        //绘制图层
                        var mapdata = map_toolbox_object.current_map.getBounds()
                        // console.log("当前经纬度",mapdata)
                        map_toolbox_object.recv_all_data = pointdata
                        var points = []
                        map_toolbox_object.recv_all_data.forEach(function (item) {
                            // 绘图

                            // if((item.ZoomLevel<=6)){
                            //     var iflabel = false
                            // }
                            // else{
                            //     var iflabel = true
                            // }
                            var tooltips = item.Station_Name + "-" + item.Station_Id_C + "<br>" + "    纬度:" + item.Lat.toFixed(2).toString() + "  " + "经度:" + item.Lon.toFixed(2).toString() + "<br>" + "    " + item.City + "-" + item.Cnty + "-" + item.Town
                            // 添加散点------------
                            if (click_type == "rain" && item.value > 0) {
                                if ($("#real_times").val() == "24hours") {
                                    if (item.value > 0 && item.value <= 1) {
                                        var colors = "white"
                                    }
                                    else if (item.value > 1 && item.value <= 10) {
                                        var colors = "rgb(140,246,130)"
                                    }
                                    else if (item.value > 10 && item.value <= 25) {
                                        var colors = "rgb(0,191,27)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 25 && item.value <= 50) {
                                        var colors = "rgb(62,185,255)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 50 && item.value <= 100) {
                                        var colors = "rgb(25,0,235)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 100 && item.value <= 250) {
                                        var colors = "rgb(255,0,255)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 250) {
                                        var colors = "rgb(140,0,65)"
                                        var iflabel = false
                                    }

                                }
                                else if ($("#real_times").val() == "12hours") {
                                    if (item.value > 0 && item.value <= 1) {
                                        var colors = "white"
                                    }
                                    else if (item.value > 1 && item.value <= 5) {
                                        var colors = "rgb(140,246,130)"
                                    }
                                    else if (item.value > 5 && item.value <= 15) {
                                        var colors = "rgb(0,191,27)"
                                    }
                                    else if (item.value > 15 && item.value <= 30) {
                                        var colors = "rgb(62,185,255)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 30 && item.value <= 70) {
                                        var colors = "rgb(25,0,235)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 70 && item.value <= 140) {
                                        var colors = "rgb(255,0,255)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 140) {
                                        var colors = "rgb(140,0,65)"
                                        var iflabel = false
                                    }
                                }
                                else if ($("#real_times").val() == "6hours") {
                                    if (item.value > 0 && item.value <= 1) {
                                        var colors = "white"
                                    }
                                    else if (item.value > 1 && item.value <= 4) {
                                        var colors = "rgb(140,246,130)"
                                    }
                                    else if (item.value > 4 && item.value <= 13) {
                                        var colors = "rgb(0,191,27)"
                                    }
                                    else if (item.value > 13 && item.value <= 25) {
                                        var colors = "rgb(62,185,255)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 25 && item.value <= 60) {
                                        var colors = "rgb(25,0,235)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 60 && item.value <= 120) {
                                        var colors = "rgb(255,0,255)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 120) {
                                        var colors = "rgb(140,0,65)"
                                        var iflabel = false
                                    }

                                }
                                else if ($("#real_times").val() == "3hours") {
                                    if (item.value > 0 && item.value <= 1) {
                                        var colors = "white"
                                    }
                                    else if (item.value > 1 && item.value <= 3) {
                                        var colors = "rgb(140,246,130)"
                                    }
                                    else if (item.value > 3 && item.value <= 10) {
                                        var colors = "rgb(0,191,27)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 10 && item.value <= 20) {
                                        var colors = "rgb(62,185,255)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 20 && item.value <= 50) {
                                        var colors = "rgb(25,0,235)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 50 && item.value <= 70) {
                                        var colors = "rgb(255,0,255)"
                                        var iflabel = false
                                    }
                                    else if (item.value > 70) {
                                        var colors = "rgb(140,0,65)"
                                        var iflabel = false
                                    }
                                }
                                else if ($("#real_times").val() != "now") {
                                    if (item.value > 0 && item.value <= 1) {
                                        var colors = "white"
                                    }
                                    else if (item.value > 1 && item.value <= 1.5) {
                                        var colors = "rgb(140,246,130)"
                                    }
                                    else if (item.value > 1.5 && item.value <= 7) {
                                        var colors = "rgb(0,191,27)"
                                    }
                                    else if (item.value > 7 && item.value <= 15) {
                                        var colors = "rgb(62,185,255)"
                                    }
                                    else if (item.value > 15 && item.value <= 40) {
                                        var colors = "rgb(25,0,235)"
                                    }
                                    else if (item.value > 40 && item.value <= 50) {
                                        var colors = "rgb(255,0,255)"
                                    }
                                    else if (item.value > 50) {
                                        var colors = "rgb(140,0,65)"
                                    }

                                }
                                else {
                                    if (item.value > 0 && item.value <= 0.1) {
                                        var colors = "white"
                                    }
                                    else if (item.value > 0.1 && item.value <= 0.3) {
                                        var colors = "rgb(140,246,130)"
                                    }
                                    else if (item.value > 0.3 && item.value <= 0.5) {
                                        var colors = "rgb(0,191,27)"
                                    }
                                    else if (item.value > 0.5 && item.value <= 0.7) {
                                        var colors = "rgb(62,185,255)"
                                    }
                                    else if (item.value > 0.7 && item.value <= 1.0) {
                                        var colors = "rgb(25,0,235)"
                                    }
                                    else if (item.value > 1.0 && item.value <= 2) {
                                        var colors = "rgb(255,0,255)"
                                    }
                                    else if (item.value > 2) {
                                        var colors = "rgb(140,0,65)"
                                    }

                                }
                                var latlng = L.latLng(item.Lat, item.Lon);
                                // 添加散点插件
                                var c = L.circleMarker(latlng, {
                                    stationname: item.Station_Name,
                                    stationnum: item.Station_Id_C,
                                    weight: 0,
                                    radius: 8,
                                    opacity: 0,
                                    fill: false,
                                    color: colors,
                                    fillColor: colors,
                                    fillOpacity: 1,
                                    labelStyle: {
                                        text: item.value,
                                        collisionFlg: iflabel,
                                        // offsetY: -25,
                                        scale: 1.5,
                                        weight: 3,
                                        rotation: 0,
                                        fillStyle: colors,
                                        zIndex: 60
                                    }
                                }).bindTooltip(tooltips, {
                                    direction: "top",
                                    offset: L.point(0, -10)
                                }).openTooltip();
                                // map_toolbox_object.current_marker_list.push(marker)
                                map_toolbox_object.current_marker_list.push(c)

                            }
                            else if (click_type == "wind" && item.value > 10.3) {
                                // var latlng = L.latLng(item.Lat, item.Lon);
                                if ((item.value <= 20.6) && (item.value > 17.0)) {
                                    var colors = "#E71FED" // 粉色

                                }
                                else if (item.value > 20.6) {
                                    var colors = "red" // 粉色

                                }
                                else {
                                    var colors = "white"
                                }
                                var latlng = L.latLng(item.Lat, item.Lon);
                                var icon = L.WindBarb.icon({
                                    color: "red",
                                    deg: item.WIN_D_Gust_Max,
                                    pointRadius: 8,
                                    strokeColor: colors,
                                    strokeLength: 25,
                                    forceDir: true,
                                    // barbSpaceing:4,
                                    // barbHeight:20,
                                    fillColor: colors,
                                    speed: (item.value)
                                });
                                var marker = L.marker([item.Lat, item.Lon], {
                                    icon: icon,
                                    name: item.Station_Id_C,
                                    stationname: item.Station_Name,
                                    stationnum: item.Station_Id_C,
                                    deg: item.WIN_D_Gust_Max,
                                    sped: item.value,
                                    station: item.Station_Name
                                }).bindTooltip(tooltips, {
                                    direction: "top",
                                    offset: L.point(0, -10)
                                }).openTooltip();

                                map_toolbox_object.current_marker_list.push(marker)


                            }
                            else if (click_type == "sped") {
                                var wind_dir_text = map_toolbox_object.wind_dir(item.WIN_D_Gust_Max)
                                if ((item.value >= 0) && (item.value <= 5.4)) {
                                    var texts = wind_dir_text + "/" + (item.value).toString()
                                    var colors = "white"
                                }
                                else if ((item.value > 5.4) && (item.value <= 7.9)) {
                                    var texts = wind_dir_text + "/" + (item.value).toString()
                                    var colors = "white"
                                }
                                else if ((item.value > 7.9) && (item.value <= 10.7)) {
                                    var texts = wind_dir_text + "/" + (item.value).toString()
                                    var colors = "white"
                                }
                                else if ((item.value > 10.7) && (item.value <= 13.8)) {
                                    var texts = wind_dir_text + "/" + (item.value).toString()
                                    var colors = "#F3EBAB"
                                }
                                else if ((item.value > 13.8) && (item.value <= 17.1)) {
                                    var texts = wind_dir_text + "/" + (item.value).toString()
                                    var colors = "#ABC1F3"
                                    var iflabel = false

                                }
                                else if ((item.value > 17.1) && (item.value <= 20.7)) {
                                    var texts = wind_dir_text + "/" + (item.value).toString()
                                    var colors = "#F3ABF1"
                                    var iflabel = false
                                }
                                else if ((item.value > 20.7) && (item.value <= 24.4)) {
                                    var texts = wind_dir_text + "/" + (item.value).toString()
                                    var colors = "red"
                                    var iflabel = false
                                }
                                else if ((item.value > 24.4) && (item.value <= 28.4)) {
                                    var texts = wind_dir_text + "/" + (item.value).toString()
                                    var colors = "red"
                                    var iflabel = false
                                }
                                else if ((item.value > 28.4)) {
                                    var texts = wind_dir_text + "/" + (item.value).toString()
                                    var colors = "red"
                                    var iflabel = false
                                }

                                var latlng = L.latLng(item.Lat, item.Lon);
                                // 添加散点插件
                                var c = L.circleMarker(latlng, {
                                    stationname: item.Station_Name,
                                    stationnum: item.Station_Id_C,
                                    weight: 0,
                                    radius: 7,
                                    opacity: 1,
                                    fill: false,
                                    color: colors,
                                    fillColor: colors,
                                    fillOpacity: 1,
                                    labelStyle: {
                                        text: texts,
                                        collisionFlg: iflabel,
                                        fillStyle: colors,
                                        scale: 1.15,
                                        weight: 3,
                                        rotation: 0,
                                        color: "red",
                                        zIndex: 60
                                    }
                                }).bindTooltip(tooltips, {
                                    direction: "top",
                                    offset: L.point(0, -10)
                                }).openTooltip();
                                // map_toolbox_object.current_marker_list.push(marker)
                                map_toolbox_object.current_marker_list.push(c)

                            }
                            else if (click_type == "tmax" || click_type == "tmin") {
                                if (item.value != -9999) {
                                    if (item.value != -9999) {
                                        if (item.value > 35) {
                                            var colors = "red"
                                            var iflabel = false
                                        }
                                        else if (item.value < 3) {
                                            var colors = "blue"
                                            var iflabel = false
                                        }
                                        else {
                                            var colors = "white"
                                        }
                                        var latlng = L.latLng(item.Lat, item.Lon);
                                        var c = L.circleMarker(latlng, {
                                            stationname: item.Station_Name,
                                            stationnum: item.Station_Id_C,
                                            weight: 0,
                                            radius: 7,
                                            opacity: 1,
                                            fill: false,
                                            fillOpacity: 1,
                                            labelStyle: {
                                                text: item.value,
                                                collisionFlg: iflabel,
                                                fillStyle: colors,
                                                scale: 1.5,
                                                weight: 5,
                                                rotation: 0,
                                                zIndex: 60
                                            }
                                        }).bindTooltip(tooltips, {
                                            direction: "top",
                                            offset: L.point(0, -10)
                                        }).openTooltip();
                                        // map_toolbox_object.current_marker_list.push(marker)
                                        map_toolbox_object.current_marker_list.push(c)
                                    }
                                }
                            }
                            else if (click_type == "view" && item.value < 30000) {
                                if ((item.value > 500) && (item.value <= 1000)) {
                                    var colors = "blue"
                                }
                                else if ((item.value > 200) && (item.value <= 500)) {
                                    var colors = "#F8E811"
                                    var iflabel = false
                                }
                                else if ((item.value > 50) && (item.value <= 200)) {
                                    var colors = "#F88109"
                                    var iflabel = false
                                }
                                else if (item.value <= 50) {
                                    var colors = "red"
                                    var iflabel = false
                                }
                                else {
                                    var colors = "white"
                                }
                                var latlng = L.latLng(item.Lat, item.Lon);
                                var c = L.circleMarker(latlng, {
                                    stationname: item.Station_Name,
                                    stationnum: item.Station_Id_C,
                                    weight: 0,
                                    radius: 7,
                                    opacity: 1,
                                    fill: false,
                                    zIndex: 500,
                                    fillOpacity: 1,
                                    labelStyle: {
                                        text: item.value,
                                        collisionFlg: iflabel,
                                        scale: 1.5, // 字体大小
                                        fillStyle: colors,  // 颜色
                                        weight: 2000,
                                        rotation: 0,
                                        zIndex: 200
                                    }
                                }).bindTooltip(tooltips, {
                                    direction: "top",
                                    offset: L.point(0, -10)
                                }).openTooltip();
                                // map_toolbox_object.current_marker_list.push(marker)
                                map_toolbox_object.current_marker_list.push(c)

                            }
                        })
                        // 绘制等值线
                        map_toolbox_object.current_points = points
                        // var intersectionLay = map_toolbox_object.return_shp(map_toolbox_object.boundaries, points, click_type).intersectionLay
                        // intersectionLay.addTo(map_toolbox_object.current_map)
                    },
                    plot_mark: function (click_type) {
                        //添加绘图的相应函数
                        map_toolbox_object.current_marker_list.forEach(function (item) {
                            // item.setZIndex(500)
                            item.addTo(map_toolbox_object.current_map).on("click", function (e) {
                                /// 叠加单机绘图
                                // console.log("散点图的点击",click_type, e.sourceTarget.options.stationnum)
                                // var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                                var plot_type = click_type
                                var plot_num = e.sourceTarget.options.stationnum
                                var plot_name = e.sourceTarget.options.stationname
                                var labels = plot_name + ":" + plot_num
                                var plot_time = map_toolbox_object.get_today()
                                map_toolbox_object.plot_line(plot_type, plot_num, plot_time)
                                layer.open({
                                    type: 1,
                                    title: labels,
                                    maxmin: true,
                                    moveOut: true,
                                    // resize:true,
                                    skin: 'layui-layer-lan', //样式类名
                                    closeBtn: 1, //不显示关闭按钮
                                    area: ['1200px', '600px'],
                                    maxHeight: 600,
                                    maxWidth: 1200,
                                    anim: 0,
                                    shade: 0,
                                    zIndex: 9999,
                                    shadeClose: false, //开启遮罩关闭
                                    content: $("#hidden_station")
                                    // , btn: ['按钮一', '按钮二', '按钮三']
                                    // , yes: function (index, layero) {
                                    //     //按钮【按钮一】的回调
                                    // }
                                    // , btn2: function (index, layero) {
                                    //     //按钮【按钮二】的回调

                                    //     //return false 开启该代码可禁止点击该按钮关闭
                                    // }
                                    // , btn3: function (index, layero) {
                                    //     //按钮【按钮三】的回调

                                    //     //return false 开启该代码可禁止点击该按钮关闭
                                    // }
                                    // , cancel: function () {
                                    //     //右上角关闭回调

                                    //     //return false 开启该代码可禁止点击该按钮关闭
                                    // }
                                    // , success: function (layero, index) {
                                    //     console.log(layero, index);

                                    // }
                                });
                            });
                        })
                        // canvas 的加载方法
                        // var ciLayer = L.canvasMarkerLayer({
                        //     collisionFlg: true
                        // }).addTo(map_toolbox_object.current_map);
                        // ciLayer.addLayers(map_toolbox_object.current_marker_list);



                    },
                    decode_line: function (plot_type, his, now, windhis, windnow) {
                        map_toolbox_object.recv_single_data = []
                        var data_time = []
                        var data_his = [] // 历史数据
                        var data_now = [] // 当前数据
                        now.forEach(function (item, index) {
                            if (plot_type == "rain") {

                                // if ((item[0].substring(14, 16)=="00") || (item[0].substring(14, 16)=="30")){
                                //     data_time.push(item[0].substring(11, 16))
                                // }
                                // else{
                                //     var timestr = " "
                                //     data_time.push(timestr)
                                // }
                                data_time.push(item[0].substring(11, 16))
                                map_toolbox_object.recv_single_data.push(item[2])
                                data_now.push(item[2])
                                data_his.push(null)
                            }
                            else if ((plot_type == "wind") || (plot_type == "sped")) {
                                // if ((item[0].substring(14, 16)=="00")){
                                //     data_time.push(item[0].substring(11, 16))
                                // }
                                // else{
                                //     var timestr = " "
                                //     data_time.push(timestr)
                                // }
                                values = [item[5] / 10, item[6]]
                                map_toolbox_object.recv_single_data.push(item[5] / 10)
                                data_time.push(item[0].substring(11, 16))
                                data_now.push(values)
                                data_his.push([null, null])
                            }
                            else if (plot_type == "tmax" || plot_type == "tmin") {
                                data_time.push(item[0].substring(11, 16))
                                data_now.push(item[3] / 10)
                                data_his.push(null)
                                map_toolbox_object.recv_single_data.push(item[3] / 10)
                            }
                            else if (plot_type == "view") {
                                data_time.push(item[0].substring(11, 16))
                                data_now.push(item[4])
                                map_toolbox_object.recv_single_data.push(item[4])
                                data_his.push(null)
                            }
                        })
                        // 历史数据
                        if (his.length > 1) {
                            his.forEach(function (item, index) {
                                if (plot_type == "rain") {
                                    // if ((item[0].substring(14, 16)=="00") || (item[0].substring(14, 16)=="30")){
                                    //     data_time.push(item[0].substring(11, 16))
                                    // }
                                    // else{
                                    //     var timestr = " "
                                    //     data_time.push(timestr)
                                    // }
                                    data_time.push(item[0].substring(11, 16))
                                    data_now.push(null)
                                    data_his.push(item[2])
                                    map_toolbox_object.recv_single_data.push(item[2])
                                }
                                else if ((plot_type == "wind") || (plot_type == "sped")) {
                                    // if ((item[0].substring(14, 16)=="00")){
                                    //     data_time.push(item[0].substring(11, 16))
                                    //     console.log(item[0].substring(11, 16))
                                    // }
                                    // else{
                                    //     var timestr = " "
                                    //     data_time.push(timestr)
                                    // }
                                    values = [item[5] / 10, item[6]]
                                    data_time.push(item[0].substring(11, 16))
                                    map_toolbox_object.recv_single_data.push(item[5] / 10)
                                    data_now.push([null, null])
                                    data_his.push(values)
                                }
                                else if (plot_type == "tmax" || plot_type == "tmin") {
                                    data_time.push(item[0].substring(11, 16))
                                    data_now.push(null)
                                    data_his.push(item[3] / 10)
                                    map_toolbox_object.recv_single_data.push(item[3] / 10)
                                }
                                else if (plot_type == "view") {
                                    data_time.push(item[0].substring(11, 16))
                                    data_now.push(null)
                                    data_his.push(item[4])
                                    map_toolbox_object.recv_single_data.push(item[4])
                                }
                            })
                        }
                        else {
                            data_his = []
                        }

                        if ((plot_type == "wind") || (plot_type == "sped")) {
                            var wind_time = []
                            var wind_his = []
                            var wind_now = []
                            // console.log(windnow)
                            windnow.forEach(function (item, index) {
                                // console.log(item)
                                wind_time.push(item[0].substring(11, 16))
                                wind_his.push([null, null])
                                wind_now.push([item[2] / 10, item[1]])
                            })
                            windhis.forEach(function (item, index) {
                                wind_time.push(item[0].substring(11, 16))
                                wind_his.push([item[2] / 10, item[1]])
                                wind_now.push([null, null])
                            })
                        }
                        else {
                            var wind_time = undefined
                            var wind_his = undefined
                            var wind_now = undefined
                        }
                        return [data_time, data_now, data_his, wind_time, wind_now, wind_his]


                    },
                    plot_line_opt: function (plot_type, plot_data) {
                        var timeindex = plot_data[0]

                        var now = plot_data[1]
                        var his = plot_data[2]
                        var opt = undefined
                        var hoursindex = ['20:00', '21:00', '22:00', '23:00', '24:00', '01:00', '02:00', '03:00', '04:00', '05:00', '06:00', '07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00']
                        if (plot_type == "rain") {
                            opt = {
                                chart: {
                                    type: 'column',
                                    zoomType: 'x',
                                    events: {
                                        selection: function (e) {
                                            // 事件处理代码，可以通过 console.log(e) 查看更多详细信息
                                            if (e.xAxis) {
                                                var min = Math.ceil(e.xAxis[0].min);
                                                var max = Math.floor(e.xAxis[0].max);
                                                var sum_data = 0
                                                map_toolbox_object.recv_single_data.forEach(function (item, index) {
                                                    if (index > min && index < max) {
                                                        sum_data = sum_data + item
                                                    }
                                                })
                                                var text = {
                                                    text: "累计降水" + sum_data.toString() + "毫米,",
                                                    align: "left",
                                                    x: 50,
                                                    style: {
                                                        color: "black"
                                                    }
                                                }
                                                Highcharts.charts[Highcharts.charts.length - 1].setTitle(text);
                                            }
                                        }
                                    }
                                },
                                credits: {
                                    enabled: false//不显示LOGO
                                },
                                title: {
                                    text: '降水'
                                },
                                xAxis: [{
                                    categories: timeindex,
                                    // type:"linear",
                                    tickInterval: 60,
                                    lineColor: "black",
                                    lineWidth: 1,
                                    labels: {
                                        // step:12,
                                        rotation: 0,
                                        formatter: function () {
                                            // var index = parseInt(this.value)                                          
                                            var labe = this.value
                                            if (this.value.substring(2, 5) == ":00") {
                                                var labe = this.value.substring(0, 2) + "时"
                                                // console.log("---",this.value,labe) 
                                            }
                                            else {
                                                var labe = this.value.substring(0, 2) + "时"
                                                // console.log("---",this.value,labe,this.value.substring(2,4)) 
                                            }
                                            return labe
                                        },
                                        // useHTML: true
                                    },
                                    offset: 0
                                }
                                ],
                                yAxis: {
                                    min: 0,
                                    title: {
                                        text: '降雨量 (mm)'
                                    },
                                    lineColor: "black",
                                    lineWidth: 2,
                                    gridLineColor: 'black',
                                    gridLineDashStyle: 'Dash'
                                    // gridLineWidth:1
                                    // gridLineDashStyle:'Dash'
                                },
                                tooltip: {
                                    useHTML: true,
                                    headerFormat: '<small>{point.key}</small><table>',
                                    pointFormat: '<tr><td style="color: {series.color}">{series.name}: </td>' +
                                        '<td style="text-align: right"><b>{point.y} mm</b></td></tr>',
                                    footerFormat: '</table>',
                                    valueDecimals: 2

                                },
                                series: [
                                    {
                                        name: '昨天',
                                        color: "red",
                                        xAxis: 0,
                                        data: his
                                    }, {
                                        name: '今天',
                                        color: "blue",
                                        xAxis: 0,
                                        data: now
                                    }]
                            }
                        }
                        else if ((plot_type == "wind") || (plot_type == "sped")) {
                            opt = {
                                title: {
                                    text: '风场'
                                },
                                credits: {
                                    enabled: false//不显示LOGO
                                },
                                chart: {
                                    zoomType: 'x',
                                    events: {
                                        selection: function (e) {
                                            // 事件处理代码，可以通过 console.log(e) 查看更多详细信息
                                            if (e.xAxis) {
                                                var min = Math.ceil(e.xAxis[1].min);
                                                var max = Math.floor(e.xAxis[1].max);
                                                var max_data = 0
                                                console.log(min, max)
                                                map_toolbox_object.recv_single_data.forEach(function (item, index) {
                                                    if (index >= min && index <= max) {
                                                        if (item > max_data && item > 0) {
                                                            max_data = item
                                                        }
                                                    }
                                                })

                                                var text = {
                                                    text: "最大瞬时风力" + max_data.toString() + "米/秒",
                                                    align: "left",
                                                    x: 50,
                                                    style: {
                                                        color: "black"
                                                    }
                                                }
                                                // min_data = 0
                                                Highcharts.charts[Highcharts.charts.length - 1].setTitle(text);
                                            }
                                        }
                                    }
                                },
                                yAxis: {
                                    min: 0,
                                    title: {
                                        text: '风力 (m/s)'
                                    },
                                    lineColor: "black",
                                    lineWidth: 2
                                    // gridLineColor: 'black',
                                    // gridLineDashStyle: 'Dash'
                                    // gridLineWidth:1
                                    // gridLineDashStyle:'Dash'
                                },
                                xAxis: [{
                                    categories: plot_data[3],
                                    lineColor: "white",
                                    lineWidth: 0,
                                    offset: 40
                                }, {
                                    categories: timeindex,
                                    lineColor: "black",
                                    tickInterval: 60,
                                    lineWidth: 2,
                                    labels: {
                                        // step:12,
                                        rotation: 0,
                                        formatter: function () {
                                            // var index = parseInt(this.value)                                          
                                            var labe = this.value
                                            if (this.value.substring(2, 5) == ":00") {
                                                var labe = this.value.substring(0, 2) + "时"
                                                // console.log("---",this.value,labe) 
                                            }
                                            else {
                                                var labe = this.value.substring(0, 2) + "时"
                                                // console.log("---",this.value,labe,this.value.substring(2,4)) 
                                            }
                                            return labe
                                        },
                                        // useHTML: true
                                    },
                                    offset: 80
                                }
                                ],
                                // plotOptions: {
                                //     series: {
                                //         pointStart: Date.UTC(2017, 0, 29),
                                //         pointInterval: 36e5
                                //     }
                                // },
                                series: [{
                                    type: 'windbarb',
                                    data: plot_data[4],
                                    // name: 'Wind',
                                    color: "blue",
                                    xAxis: 0,
                                    showInLegend: false,
                                    tooltip: {
                                        valueSuffix: ' m/s'
                                    }
                                },
                                {
                                    type: 'windbarb',
                                    data: plot_data[5],
                                    // name: 'Wind',
                                    color: "red",
                                    xAxis: 0,
                                    showInLegend: false,
                                    tooltip: {
                                        valueSuffix: ' m/s'
                                    }
                                },
                                {
                                    type: 'column',
                                    keys: ['y', 'rotation'], // rotation is not used here
                                    data: now,
                                    xAxis: 1,
                                    color: "blue",
                                    // fillColor: {
                                    //     linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                                    //     stops: [
                                    //         [0, "blue"],
                                    //         [
                                    //             1,
                                    //             "white"
                                    //         ]
                                    //     ]
                                    // },
                                    name: '今天',
                                    tooltip: {
                                        valueSuffix: ' m/s'
                                    }
                                },
                                {
                                    type: 'column',
                                    keys: ['y', 'rotation'], // rotation is not used here
                                    data: his,
                                    xAxis: 1,
                                    color: "red",
                                    // fillColor: {
                                    //     linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                                    //     stops: [
                                    //         [0, "red"],
                                    //         [
                                    //             1,
                                    //             "white"
                                    //         ]
                                    //     ]
                                    // },
                                    name: '昨天',
                                    tooltip: {
                                        valueSuffix: ' m/s'
                                    }
                                },
                                ]
                            }

                        }
                        else if (plot_type == "tmax" || plot_type == "tmin") {
                            opt = {
                                chart: {
                                    type: 'spline',
                                    zoomType: 'x'
                                },
                                credits: {
                                    enabled: false//不显示LOGO
                                },
                                title: {
                                    text: '气温'
                                },
                                // subtitle: {
                                //     text: '数据来源: WorldClimate.com'
                                // },
                                // plotOptions: {
                                //     series: {
                                //         pointStart: Date.UTC(2013, 11, 14, 0, 0, 0, 0),
                                //         pointInterval: 6e5
                                //     }
                                // },
                                xAxis: {
                                    categories: timeindex,
                                    // labels: {
                                    //     step: 12,
                                    // },
                                    lineColor: "black",
                                    lineWidth: 3,
                                    tickInterval: 60,
                                    labels: {
                                        // step:12,
                                        rotation: 0,
                                        formatter: function () {
                                            // var index = parseInt(this.value)                                          
                                            var labe = this.value
                                            if (this.value.substring(2, 5) == ":00") {
                                                var labe = this.value.substring(0, 2) + "时"
                                                // console.log("---",this.value,labe) 
                                            }
                                            else {
                                                var labe = this.value.substring(0, 2) + "时"
                                                // console.log("---",this.value,labe,this.value.substring(2,4)) 
                                            }
                                            return labe
                                        },
                                        // useHTML: true
                                    },
                                    gridLineWidth: 0.2,
                                    gridLineColor: 'black',
                                    gridLineDashStyle: 'Dash'
                                },
                                yAxis: {
                                    // min: 0,
                                    title: {
                                        text: '气温 (mm)'
                                    },
                                    gridLineColor: 'black',
                                    gridLineDashStyle: 'Dash'
                                    // gridLineWidth:1
                                    // gridLineDashStyle:'Dash'
                                },
                                tooltip: {
                                    useHTML: true,
                                    headerFormat: '<small>{point.key}</small><table>',
                                    pointFormat: '<tr><td style="color: {series.color}">{series.name}: </td>' +
                                        '<td style="text-align: right"><b>{point.y} ℃</b></td></tr>',
                                    footerFormat: '</table>',
                                    valueDecimals: 2

                                },
                                series: [{
                                    name: '昨天',
                                    color: "red",
                                    data: his
                                }, {
                                    name: '今天',
                                    color: "blue",
                                    data: now
                                }]
                            }

                        }
                        else if (plot_type == "view") {
                            opt = {
                                chart: {
                                    type: 'spline',
                                    zoomType: 'x'
                                },
                                credits: {
                                    enabled: false//不显示LOGO
                                },
                                title: {
                                    text: '能见度'
                                },
                                // subtitle: {
                                //     text: '数据来源: WorldClimate.com'
                                // },
                                // plotOptions: {
                                //     series: {
                                //         pointStart: Date.UTC(2013, 11, 14, 0, 0, 0, 0),
                                //         pointInterval: 6e5
                                //     }
                                // },
                                xAxis: {
                                    categories: timeindex,
                                    // labels: {
                                    //     step: 12,

                                    // },
                                    gridLineWidth: 0.2,
                                    gridLineColor: 'black',
                                    gridLineDashStyle: 'Dash',
                                    lineColor: "black",
                                    lineWidth: 2,
                                    tickInterval: 20,
                                    labels: {
                                        // step:12,
                                        rotation: 0,
                                        formatter: function () {
                                            // var index = parseInt(this.value)                                          
                                            var labe = this.value
                                            if (this.value.substring(2, 5) == ":00") {
                                                var labe = this.value.substring(0, 2) + "时"
                                                // console.log("---",this.value,labe) 
                                            }
                                            else {
                                                var labe = this.value.substring(0, 2) + "时"
                                                // console.log("---",this.value,labe,this.value.substring(2,4)) 
                                            }
                                            return labe
                                        },
                                        // useHTML: true
                                    }
                                },
                                yAxis: {
                                    min: 0,
                                    title: {
                                        text: '能见度 (m)'
                                    },
                                    gridLineColor: 'black',
                                    gridLineDashStyle: 'Dash'
                                    // gridLineWidth:1
                                    // gridLineDashStyle:'Dash'
                                },
                                tooltip: {
                                    backgroundColor: '#FCFFC5',   // 背景颜色
                                    borderColor: 'black',         // 边框颜色
                                    borderRadius: 10,             // 边框圆角
                                    borderWidth: 3,               // 边框宽度
                                    shadow: true,                 // 是否显示阴影
                                    animation: true,              // 是否启用动画效果
                                    style: {                      // 文字内容相关样式
                                        color: "#ff0000",
                                        fontSize: "12px",
                                        fontWeight: "blod",
                                        fontFamily: "Courir new"
                                    },
                                    pointFormatter: function () {

                                        return '<span style="color: ' + this.series.color + '">\u25CF</span> ' +
                                            this.series.name + ': <b>' + this.y + "米" + '</b><br/>.'
                                    },
                                    dateTimeLabelFormats: {
                                        millisecond: "%A, %b %e, %H:%M:%S.%L",
                                        second: "%A, %b %e, %H:%M:%S",
                                        minute: "%A, %b %e, %H:%M",
                                        hour: "%A, %b %e, %H:%M",
                                        // day: "%A, %b %e, %Y",
                                        // week: "Week from %A, %b %e, %Y",
                                        // month: "%B %Y",
                                        // year: "%Y"
                                    }
                                },
                                series: [{
                                    name: '昨天',
                                    color: "red",
                                    data: his
                                }, {
                                    name: '今天',
                                    color: "blue",
                                    data: now
                                }]
                            }


                        }
                        return opt
                    },
                    plot_line: function (plot_type, plot_name, plot_time) {
                        //绘制站点  
                        map_toolbox_object.single_name = plot_name
                        $("#single_station").val(plot_name)
                        var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                        $.ajax({
                            url: "station_zdz_data",  // 请求的地址
                            type: "post",  // 请求方式
                            timeout: 25000, //设置延迟上限
                            data: {
                                'csrfmiddlewaretoken': csrf,
                                'model': 'single',
                                'click_type': plot_type,
                                'plot_time': plot_time,
                                'button_value': plot_name
                            },
                            dataType: "json",
                            beforeSend: function (XMLHttpRequest) {
                                load = showLoad();
                            },
                            success: function (recvdate) {
                                // var all_data = JSON.parse(recvdate.value)                       
                                var his = JSON.parse(recvdate.his)
                                var now = JSON.parse(recvdate.now)
                                var windhis = JSON.parse(recvdate.windhis)
                                var windnow = JSON.parse(recvdate.windnow)
                                var plot_data = map_toolbox_object.decode_line(plot_type, his, now, windhis, windnow)
                                var option = map_toolbox_object.plot_line_opt(plot_type, plot_data)
                                var chart = Highcharts.chart('hidden_plot', option)
                                map_toolbox_object.current_chart = chart
                                if (plot_type == "wind") {
                                    var nowlist = []
                                    now.forEach(function (item, index) {
                                        nowlist.push(item[2])
                                    })
                                    var nowmax = nowlist.reduce((a, b) => Math.max(a, b))
                                    var text = {
                                        text: "最大风力--" + nowmax.toString() + "15米/秒",
                                        align: "left",
                                        x: 50,
                                        style: {
                                            color: "black"
                                        }
                                    }
                                    Highcharts.charts[Highcharts.charts.length - 1].setTitle(text);

                                }
                                else if (plot_type == "tmax" || plot_type == "tmin" || plot_type == "temp") {
                                    var nowlist = []
                                    now.forEach(function (item, index) {
                                        nowlist.push(item[2])
                                    })
                                    var nowmax = nowlist.reduce((a, b) => Math.max(a, b))
                                    var nowmin = nowlist.reduce((a, b) => Math.min(a, b))
                                    var text = {
                                        text: "最高温度" + nowmax.toString() + "度" + ";" + "最低温度" + nowmin.toString() + "度",
                                        align: "left",
                                        x: 50,
                                        style: {
                                            color: "black"
                                        }
                                    }
                                    Highcharts.charts[Highcharts.charts.length - 1].setTitle(text);

                                }
                                else if (plot_type == "view") {
                                    var nowlist = []
                                    now.forEach(function (item, index) {
                                        nowlist.push(item[2])
                                    })
                                    var nowmax = nowlist.reduce((a, b) => Math.max(a, b))
                                    var nowmin = nowlist.reduce((a, b) => Math.min(a, b))
                                    var text = {
                                        text: "最低能见度" + nowmin.toString() + "米" + ";",
                                        align: "left",
                                        x: 50,
                                        style: {
                                            color: "black"
                                        }
                                    }
                                    Highcharts.charts[Highcharts.charts.length - 1].setTitle(text);

                                }

                                closeLoad(load)

                            }
                        })

                    },
                    get_table: function (tabledata, click_type) {
                        // console.log("---",tabledata)
                        if (click_type != "view") {
                            tabledata.forEach(function (item) {
                                item.value = item.value
                            })
                        }
                        if (click_type == "rain") { var fields = "降水" }
                        else if (click_type == "wind" || click_type == "sped") { var fields = "风力" }
                        else if (click_type == "tmax" || click_type == "sped") { var fields = "气温" }
                        else if (click_type == "view") { var fields = "能见度" }
                        layui.use('table', function () {
                            var table = layui.table;
                            //展示已知数据
                            table.render({
                                elem: '#get_data_table_content'
                                , width: 500
                                , height: 360
                                , cellMinWidth: 80
                                , cols: [[ //标题栏
                                    { field: 'Station_Id_C', title: 'ID', width: 60 }
                                    , { field: 'City', title: '地市', width: 60 }
                                    , { field: 'Cnty', title: '县(市)', width: 80 }
                                    , { field: 'Town', title: '乡镇', width: 100 }
                                    , { field: 'Station_Name', title: '站名', width: 50 }
                                    , { field: 'value', title: fields, sort: true, width: 80 }
                                ]]
                                , data: tabledata
                                , skin: 'line' //表格风格
                                , even: true
                                , id: 'tabledata_real'
                                //,page: true //是否显示分页
                                //,limits: [5, 7, 10]
                                , limit: 300 //每页默认显示的数量
                            });
                            var $ = layui.$, active = {
                                reload: function () {
                                    var SearchReload = $('#SearchReload_real');
                                    // console.log("测试", SearchReload.val())

                                    var returndata = tabledata
                                    var search_data = []
                                    returndata.forEach(function (item) {
                                        if ((item.Station_Id_C == SearchReload.val()) || (item.Station_Name == SearchReload.val()) || (item.City == SearchReload.val()) || (item.Cnty == SearchReload.val()) || (item.Town == SearchReload.val())) {
                                            search_data.push(item)
                                        }
                                    })
                                    //执行重载
                                    table.reload('tabledata_real', {
                                        // page: {
                                        //     curr: 1 //重新从第 1 页开始
                                        // },
                                        // where: {
                                        //     // id : demoReload.val(),
                                        //     key: {
                                        //         id: demoReload.val()
                                        //     }
                                        // },
                                        cols: [[ //标题栏
                                            { field: 'Station_Id_C', title: 'ID', width: 60 }
                                            , { field: 'City', title: '地市', width: 60 }
                                            , { field: 'Cnty', title: '县(市)', width: 80 }
                                            , { field: 'Town', title: '乡镇', width: 100 }
                                            , { field: 'Station_Name', title: '站名', width: 50 }
                                            , { field: 'value', title: fields, sort: true, width: 80 }
                                        ]]
                                        , data: search_data
                                        , skin: 'line'
                                        , id: 'tabledata_real'
                                        , limit: 800
                                    });
                                }
                            };

                            $('#TableSearch_real').on('click', function () {
                                var type = $(this).data('type');
                                active[type] ? active[type].call(this) : '';
                            });
                            $('#TableReload_real').on('click', function () {
                                table.reload('tabledata_real', {
                                    cols: [[ //标题栏
                                        { field: 'Station_Id_C', title: 'ID', width: 60 }
                                        , { field: 'City', title: '地市', width: 60 }
                                        , { field: 'Cnty', title: '县(市)', width: 80 }
                                        , { field: 'Town', title: '乡镇', width: 100 }
                                        , { field: 'Station_Name', title: '站名', width: 50 }
                                        , { field: 'value', title: fields, sort: true, width: 80 }
                                    ]]
                                    , data: tabledata
                                    , skin: 'line'
                                    , id: 'tabledata_real'
                                    , limit: 800
                                });
                            });
                        });
                        layer.open({
                            type: 1,
                            title: "站点数据",
                            maxmin: false,
                            scrollbar: false,
                            fixed: false,
                            offset: 'rt',
                            moveOut: false,
                            resize: false,
                            skin: 'layui-layer-lan', //样式类名
                            closeBtn: 1, //不显示关闭按钮
                            area: ['505px', '400px'],
                            // maxHeight: 600,
                            // maxWidth: 1400,
                            anim: 0,
                            shade: 0,
                            zIndex: 9999,
                            shadeClose: false, //开启遮罩关闭
                            content: $("#get_data_table")
                        });
                    },
                    get_data: function (model, value_index, tables_name, tables_index) {
                        var decode_select = map_toolbox_object.decode_selection()
                        var current_zoom = map_toolbox_object.current_map.getZoom()
                        // 8 为全省  9 为 骨干站  10 为所有站
                        //向服务器要数据model,type,button 对应导航栏目、垂直导航类型、具体按钮
                        var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                        $.ajax({
                            url: "station_zdz_data",  // 请求的地址
                            type: "post",  // 请求方式
                            timeout: 25000, //设置延迟上限
                            data: {
                                'csrfmiddlewaretoken': csrf,
                                'model': model,
                                'table_type': decode_select[1],
                                'table_index': tables_index,
                                'boundary': JSON.stringify(decode_select[0]),
                                'click_type': value_index,
                                'zoom': current_zoom,
                                'button_value': tables_name
                            },
                            dataType: "json",
                            beforeSend: function (XMLHttpRequest) {
                                load = showLoad();
                            },
                            success: function (recvdate) {
                                // 获取数据
                                // console.log("国家站",recvdate.data)
                                var click_type = recvdate.click_type
                                // map_toolbox_object.recv_all_data = JSON.parse(recvdate.data)
                                var pointdata = JSON.parse(recvdate.data)
                                // 绘制等值线
                                map_toolbox_object.plot_layer(pointdata, click_type)
                                // 绘制marker
                                map_toolbox_object.plot_mark(click_type)
                                // console.log(typeof(recvdate.data),map_toolbox_object.recv_all_data )
                                // 图层显示
                                map_toolbox_object.get_table(pointdata, click_type)
                                closeLoad(load)
                            }
                        })
                    },
                    decode_selection: function () {
                        // 收集基础数据
                        var mapdata = map_toolbox_object.current_map.getBounds()
                        var boundary_type = $('input[name="boundary_type"]:checked').val()

                        if (boundary_type == "all") {
                            var boundary = [25, 35, 115, 125]
                        }
                        else {
                            var boundary = [mapdata['_southWest'].lat, mapdata['_northEast'].lat, mapdata['_southWest'].lng, mapdata['_northEast'].lng]
                        }
                        // if ($("#real_class").val()=="rain"){
                        //     var table_type = "all"
                        // }
                        // else{
                        //     var table_type = $("#table_type").val()
                        // }
                        var table_type = $("#table_type").val()
                        // console.log("接收的数据",boundary,boundary_type,table_type)
                        // console.log(boundary_type, boundary, table_type)
                        return [boundary, table_type]

                    }
                }
                // 首页加载地图
                map_toolbox_object.init()
                //按钮组的响应函数


                $('#real_plot').click(function () {


                    var model = "zdz"
                    var value_index = $("#real_class").val()  // "rain"
                    var tables_name = $("#real_times").val()  // this.value
                    if (value_index == "rain") {
                        var tables_index = 0
                        map_toolbox_object.current_data_type = "rain"
                    }
                    else if (value_index == "tmax") {
                        var tables_index = 1
                        map_toolbox_object.current_data_type = "tmax"
                    }
                    else if (value_index == "tmin") {
                        var tables_index = 2
                        map_toolbox_object.current_data_type = "tmin"
                    }
                    else if (value_index == "wind" || value_index == "sped") {
                        var tables_index = 3
                        map_toolbox_object.current_data_type = "wind"
                    }
                    else if (value_index == "view") {
                        var tables_index = 4
                        map_toolbox_object.current_data_type = "view"
                    }
                    map_toolbox_object.get_data(model, value_index, tables_name, tables_index)
                })
                // 单站数据的查询
                $("#real_single").click(function () {
                    var button_value = $("#single_station").val()
                    var plot_time = $("#single_zdz_time").val()
                    var click_type = $("#single_class").val()
                    // console.log(button_value, times, click_type)
                    var labels = "单站"
                    // map_toolbox_object.plot_line(plot_type,plot_num)  
                    layer.open({
                        type: 1,
                        title: labels,
                        maxmin: true,
                        moveOut: true,
                        // resize:true,
                        skin: 'layui-layer-lan', //样式类名
                        closeBtn: 1, //不显示关闭按钮
                        area: ['1200px', '600px'],
                        maxHeight: 600,
                        maxWidth: 1200,
                        anim: 0,
                        shade: 0,
                        zIndex: 9999,
                        shadeClose: false, //开启遮罩关闭
                        content: $("#hidden_station")
                        // , btn: ['按钮一', '按钮二', '按钮三']
                        // , yes: function (index, layero) {
                        //     //按钮【按钮一】的回调
                        // }
                        // , btn2: function (index, layero) {
                        //     //按钮【按钮二】的回调

                        //     //return false 开启该代码可禁止点击该按钮关闭
                        // }
                        // , btn3: function (index, layero) {
                        //     //按钮【按钮三】的回调

                        //     //return false 开启该代码可禁止点击该按钮关闭
                        // }
                        // , cancel: function () {
                        //     //右上角关闭回调

                        //     //return false 开启该代码可禁止点击该按钮关闭
                        // }
                        // , success: function (layero, index) {
                        //     console.log(layero, index);

                        // }
                    });
                })
                // 地图的刷新按钮
                $("#extra_real_plot").click(function () {
                    layer.open({
                        type: 1,
                        title: "绘图",
                        maxmin: true,
                        moveOut: true,
                        // resize:true,
                        skin: 'layui-layer-lan', //样式类名
                        closeBtn: 1, //不显示关闭按钮
                        area: ['800px', '880px'],
                        maxHeight: 600,
                        maxWidth: 1200,
                        anim: 0,
                        shade: 0,
                        zIndex: 9999,
                        shadeClose: false, //开启遮罩关闭
                        content: $("#extra_real_plot_div")
                    });
                })
                // 地图绘制的按钮
                $("#real_contour").click(function () {
                    var plot_opt = $('input[name="plot_opt"]:checked').val();
                    var points = map_toolbox_object.current_points
                    var click_type = $("#real_class").val()
                    if (click_type == "tmax" || (click_type == "tmin")) {
                        click_type = "temp"
                    }
                    // 绘图
                    layer.open({
                        type: 1,
                        title: "快报绘图",
                        maxmin: true,
                        moveOut: true,
                        // resize:true,
                        skin: 'layui-layer-lan', //样式类名
                        closeBtn: 1, //不显示关闭按钮
                        area: ['1600px', '900px'],
                        // maxHeight: 600,
                        // maxWidth: 1400,
                        anim: 0,
                        shade: 0,
                        zIndex: 9999,
                        shadeClose: false, //开启遮罩关闭
                        content: $("#extra_plot")
                    });
                })



                const radar_sec_obj = {
                    p1: undefined,
                    p2: undefined,
                    line: undefined,
                    fclick: function (e) {
                        radar_sec_obj.p1 = e.latlng;//确定起点
                        map_toolbox_object.current_map.off('click', radar_sec_obj.sclick);//关闭slick：第二次鼠标点击事件触发函数
                        map_toolbox_object.current_map.on('mousemove', radar_sec_obj.mmove); //开始监听鼠标移动事件
                    },
                    convert: function (lon, lat) {
                        x = lon * 20037508.34 / 180
                        y = Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180)
                        y = y * 20037508.34 / 180
                        return [x, y]
                    },
                    get_sec: function () {
                        $("#radar_sec_img").html("")
                        var start = radar_sec_obj.p1.lng.toString() + "," + radar_sec_obj.p1.lat.toString()
                        var end = radar_sec_obj.p2.lng.toString() + "," + radar_sec_obj.p2.lat.toString()

                        var result = gcoord.transform(
                            radar_sec_obj.convert(radar_sec_obj.p1.lng, radar_sec_obj.p1.lat),    // 经纬度坐标
                            gcoord.EPSG3857,               // 当前坐标系
                            gcoord.WGS84                 // 目标坐标系
                        );

                        console.log("原始", [radar_sec_obj.p1.lng, radar_sec_obj.p1.lat], "转换后", result);
                        var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                        $.ajax({
                            url: "station_zdz_data",  // 请求的地址
                            type: "post",  // 请求方式
                            timeout: 25000, //设置延迟上限
                            data: {
                                'csrfmiddlewaretoken': csrf,
                                'model': "radar_sec",
                                'click_type': start,
                                'button_value': end
                            },
                            dataType: "json",
                            beforeSend: function (XMLHttpRequest) {
                                load = showLoad();
                            },
                            success: function (recvdate) {
                                // 获取数据
                                // console.log("雷达切面数据",recvdate.img)
                                var img = new Image()
                                img.src = recvdate.img
                                img.style = "max-width: 100%;max-height: 100%;"
                                $("#radar_sec_img").html(img)
                                closeLoad(load)
                            }
                        })
                        layer.open({
                            type: 1,
                            title: "雷达剖面",
                            maxmin: true,
                            scrollbar: false,
                            fixed: false,
                            anim: 0,
                            offset: 'auto',
                            moveOut: false,
                            resize: true,
                            skin: 'layui-layer-lan', //样式类名
                            closeBtn: 1, //不显示关闭按钮
                            area: ['879px', '600px'],
                            // maxHeight: 600,
                            // maxWidth: 1400,
                            anim: 0,
                            shade: 0,
                            zIndex: 9999,
                            shadeClose: false, //开启遮罩关闭
                            content: $("#radar_sec_div")
                        });

                    },
                    sclick: function (e) {
                        map_toolbox_object.current_map.off('mousemove', radar_sec_obj.mmove); //关闭鼠标移动监听事件
                        map_toolbox_object.current_map.off('click', radar_sec_obj.sclick); //关闭第二次点击事件监听
                        map_toolbox_object.current_map.on("click", radar_sec_obj.fclick); //再次开始第一次点击事件监听，准备下次画线
                        radar_sec_obj.get_sec()
                    },
                    mmove: function (e) {
                        if (radar_sec_obj.line) {
                            if (map_toolbox_object.current_map.hasLayer(radar_sec_obj.line)) {//判断之前是否有画线
                                map_toolbox_object.current_map.removeLayer(radar_sec_obj.line);	//清除所有线段
                            }
                        }

                        radar_sec_obj.p2 = e.latlng;//确定线段终点
                        radar_sec_obj.line = new L.polyline([radar_sec_obj.p1, radar_sec_obj.p2], {//画线
                            color: 'red'//线段颜色
                        }).addTo(map_toolbox_object.current_map);
                        map_toolbox_object.current_map.off('click', radar_sec_obj.fclick); //关闭第一次点击事件监听
                        map_toolbox_object.current_map.on('click', radar_sec_obj.sclick); //开始第二次点击事件监听
                    },
                    init: function () {
                        var radar_sec_opt = $('input[name="radar_sec_opt"]:checked').val();
                        if (radar_sec_opt == "plot") {
                            map_toolbox_object.current_map.on('click', radar_sec_obj.fclick)
                        }
                        else {
                            map_toolbox_object.current_map.off('click', radar_sec_obj.fclick);
                            map_toolbox_object.current_map.off('click', radar_sec_obj.sclick);
                            map_toolbox_object.current_map.off('mousemove', radar_sec_obj.mmove);
                            if (radar_sec_obj.line) {
                                if (map_toolbox_object.current_map.hasLayer(radar_sec_obj.line)) { //清除当前折线
                                    map_toolbox_object.current_map.removeLayer(radar_sec_obj.line);
                                }

                            }


                        }
                    }
                }
                $('#radar_sec').click(function () {
                    radar_sec_obj.init()
                })


            </script>
            <!-- 隐藏栏目的设置 -->
        </div>
        <!-- 单站的设置 -->
        <div id="hidden_station" style="width:100%;height:100%;">
            <div style="width:100%;height:50px;">
                <div class="layui-form" style="padding-top:10px;">
                    <div class="layui-inline">
                        <label class="layui-form-label">日期</label>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input" id="single_zdz_time" placeholder="yyyy-MM-dd">
                        </div>
                        <div class="layui-input-inline">
                            <input id="single_station" type="text" class="layui-input" placeholder="请选择站号">
                        </div>
                        <div class="layui-input-inline">
                            <select id="single_class">
                                <option value=""></option>
                                <option value="rain" selected="">降水</option>
                                <option value="wind">风力</option>
                                <option value="tmax">温度</option>
                                <option value="view">能见度</option>
                            </select>
                        </div>
                        <button id="single_compare" type="button" class="layui-btn layui-btn-normal"
                            style="margin-left:320px;">对比线</button>
                        <button id="single_search" type="button" class="layui-btn layui-btn-normal"
                            style="margin-left:10px;">查询</button>
                    </div>
                    <script>
                        layui.use('laydate', function () {
                            var laydate = layui.laydate;
                            laydate.render({
                                elem: '#single_zdz_time'
                                , type: 'datetime'
                                , value: new Date()
                            });
                        })
                    </script>
                </div>
            </div>
            <div id="hidden_plot" style="width:1150px;height: 500px;"></div>
        </div>
        <script>
            $("#single_search").click(function () {
                var button_value = $("#single_station").val()
                var plot_time = $("#single_zdz_time").val()
                var click_type = $("#single_class").val()
                // console.log(map_toolbox_object.get_today())           
                map_toolbox_object.plot_line(click_type, button_value, plot_time)
            })
        </script>
        <!-- 服务快报 -->
        <div id="extra_plot" style="width:100%;height:100%;">
            <div style="width:100%;height:50px;;">
                <div class="layui-form" style="padding-top:10px;">
                    <div class="layui-inline">

                        <label class="layui-form-label">范围</label>
                        <div class="layui-inline" id="extra_download">
                            <div class="layui-input-inline">
                                <input type="text" autocomplete="off" id="extra_download-startDate-1"
                                    class="layui-input" placeholder="开始日期">
                            </div>
                            <div class="layui-form-mid">-</div>
                            <div class="layui-input-inline">
                                <input type="text" autocomplete="off" id="extra_download-endDate-1" class="layui-input"
                                    placeholder="结束日期">
                            </div>
                        </div>

                        <div class="layui-input-inline" style="width:10%">
                            <select id="city" style="width:40%">
                                <option value=""></option>
                                <option value="台州市" selected="">台州</option>
                                <option value="浙江">浙江</option>
                                <!-- <option value="杭州" >杭州</option>
                                <option value="湖州" >湖州</option>
                                <option value="嘉兴" >嘉兴</option>
                                <option value="绍兴">绍兴</option>
                                <option value="舟山">舟山</option>
                                <option value="金华">金华</option>
                                <option value="丽水">丽水</option>
                                <option value="衢州">衢州</option>
                                <option value="宁波">宁波</option> -->
                            </select>
                        </div>
                        <div class="layui-input-inline" style="width:10%">
                            <select id="country" style="width:40%">
                                <option value=""></option>
                                <option value="三门">三门</option>
                                <option value="all" selected="">全市</option>
                                <option value="路桥">路桥</option>
                                <option value="温岭">温岭</option>
                                <option value="椒江">椒江</option>
                                <option value="黄岩">黄岩</option>
                                <option value="仙居">仙居</option>
                                <option value="天台">天台</option>
                                <option value="玉环">玉环</option>
                            </select>
                        </div>
                        <div class="layui-input-inline" style="width:10%">
                            <select id="data_type" style="width:40%">
                                <option value=""></option>
                                <option value="all" selected="">风雨统计</option>
                                <option value="路桥">全要素</option>
                            </select>
                        </div>
                        <div class="layui-inline">
                            <input class="layui-input" name="id" id="SearchReload" autocomplete="off">
                        </div>
                        <button id="TableSearch" class="layui-btn" data-type="reload">搜索</button>
                        <button id="TableReload" class="layui-btn" data-type="reload">重置</button>
                        <button id="get_extra_data" type="button" class="layui-btn layui-btn-normal"
                            style="margin-left: 30px;">下载</button>
                    </div>
                    <script>
                        function getNextDate(date, day) {
                            var dd = new Date(date);
                            dd.setDate(dd.getDate() + day);
                            var y = dd.getFullYear();
                            var m = dd.getMonth() + 1 < 10 ? "0" + (dd.getMonth() + 1) : dd.getMonth() + 1;
                            var d = dd.getDate() < 10 ? "0" + dd.getDate() : dd.getDate();
                            return y + "-" + m + "-" + d
                        };
                        layui.use('laydate', function () {
                            var laydate = layui.laydate;
                            var today = new Date()
                            var y = today.getFullYear();
                            var m = today.getMonth() + 1 < 10 ? "0" + (today.getMonth() + 1) : today.getMonth() + 1;
                            var d = today.getDate() < 10 ? "0" + today.getDate() : today.getDate();
                            var h = today.getHours() < 10 ? "0" + today.getHours() + ":00:00" : today.getHours() + ":00:00";
                            var today_str = y + "-" + m + "-" + d + " " + h;
                            var yestorday = getNextDate(today_str, day = -1)
                            var yes_str = yestorday + " " + h;
                            function date_to_str(date) {
                                var year = date.year
                                var month = date.month < 10 ? "0" + date.month.toString() : date.month.toString()
                                var day = date.date < 10 ? "0" + date.date.toString() : date.date.toString()
                                var hour = date.hours < 10 ? "0" + date.hours.toString() : date.hours.toString()
                                var mins = date.minutes < 10 ? "0" + date.minutes.toString() + ":00" : date.minutes.toString() + ":00"
                                date_str = year + "-" + month + "-" + day + " " + hour + ":" + mins;
                                return date_str
                            }
                            laydate.render({
                                elem: '#extra_download'
                                , type: 'datetime'
                                , theme: 'molv'
                                , value: [yes_str, today_str]
                                //设置开始日期、日期日期的 input 选择器
                                //数组格式为 2.6.6 开始新增，之前版本直接配置 true 或任意分割字符即可
                                , range: ['#extra_download-startDate-1', '#extra_download-endDate-1']
                            });
                        })                      
                    </script>
                </div>
            </div>
            <div style="display: inline-flex;width:100%;height: 93%;;">
                <!-- 存放选项卡嵌套网格 -->
                <div style="width:50%;height: 100%;">
                    <div class="layui-tab" lay-filter="extra_tab" style="height: 50%;">
                        <ul class="layui-tab-title">
                            <li class="layui-this" lay-id="rain">降水</li>
                            <li lay-id="wind">风力</li>
                            <li lay-id="tmax">温度</li>
                            <li lay-id="view">能见度</li>
                        </ul>
                        <div class="layui-tab-content" style="padding: 0;">
                            <div class="layui-tab-item layui-show">
                                <div style="width:100%;height: 100%;;">
                                    <table class="layui-hide" id="extra_rain" style="width: 600px"></table>
                                </div>
                            </div>
                            <div class="layui-tab-item">
                                <div style="width:100%;height: 100%;;">
                                    <table class="layui-hide" id="extra_wind" style="width: 600px"></table>
                                </div>

                            </div>
                            <div class="layui-tab-item">
                                <div style="width:100%;height: 100%;;">
                                    <table class="layui-hide" id="extra_tmax" style="width: 600px"></table>
                                </div>

                            </div>
                            <div class="layui-tab-item">
                                <div style="width:100%;height: 100%;;">
                                    <table class="layui-hide" id="extra_view" style="width: 600px"></table>
                                </div>

                            </div>

                        </div>
                    </div>
                    <div style="height: 45%;" class="layui-tab">
                        <ul class="layui-tab-title">
                            <li class="layui-this">文字</li>
                        </ul>
                        <div class="layui-tab-content" style="padding: 0;">
                            <div id="text_msg" class="layui-tab-item layui-show"
                                style="width:100%;height: 300px;overflow-y:scroll">

                                <!-- <div  class="layui-code" style="width:100%;height: 100%;overflow-y: auto;">
                    
                                </div> -->
                            </div>
                        </div>
                    </div>
                    <script>
                        layui.use('element', function () {
                            var element = layui.element;

                            //获取hash来切换选项卡，假设当前地址的hash为lay-id对应的值
                            var layid = location.hash.replace(/^#extra_tab=/, '');
                            element.tabChange('extra_tab', layid); //假设当前地址为：http://a.com#test1=222，那么选项卡会自动切换到“发送消息”这一项
                            // Tab 切换，以改变地址 hash 值
                            element.on('tab(extra_tab)', function () {
                                location.hash = 'extra_tab=' + this.getAttribute('lay-id');
                                var tab_obj = {
                                    "rain": extra_server_obj.recv_rain,
                                    "wind": extra_server_obj.recv_wind,
                                    "tmax": extra_server_obj.recv_tmax,
                                    "view": extra_server_obj.recv_view,
                                }
                                var tab_id = {
                                    "rain": "extra_rain",
                                    "wind": "extra_wind",
                                    "tmax": "extra_tmax",
                                    "view": "extra_view",
                                }
                                var tab_type = this.getAttribute('lay-id')
                                // console.log(location.hash,"当前id",this.getAttribute('lay-id'),tab_obj[tab_type])
                                extra_server_obj.rander_table(tab_obj[tab_type], tab_type, tab_id[tab_type])
                                extra_server_obj.flush_map()
                                if (tab_type == "rain") { extra_server_obj.plot_rain() }
                                else if (tab_type == "wind") { extra_server_obj.plot_wind() }
                                else if (tab_type == "tmax") { extra_server_obj.plot_tmax() }
                                else if (tab_type == "view") { extra_server_obj.plot_view() }
                            });
                        });
                    </script>
                </div>
                <!-- 存放文字 -->
                <div id="text_div" style="display: inline-block;width:50%;height: 100%;;background-color: white;">
                    <div class="layui-tab">
                        <ul class="layui-tab-title">
                            <!-- <li>文字</li> -->
                            <li class="layui-this" id="extra_tab_map_plot">绘图</li>
                            <!-- <li>短信</li> -->
                        </ul>
                        <div class="layui-tab-content" style="padding: 0;">
                            <!-- <div class="layui-tab-item">
                                <div id="text_msg" class="layui-code" style="width:100%;height: 660px;">
                                    
                                </div> 
                            </div> -->
                            <div class="layui-tab-item layui-show" style="width:100%;height: 660px;">
                                <div id="extra_server_obj_map" style="width:100%;height: 100%"></div>

                            </div>
                            <!-- <div class="layui-tab-item" style="width:100%;height: 660px;">
                                短信内容
                            </div>      -->
                        </div>
                    </div>
                    <!-- 文字 -->

                    <!-- 绘制按钮 -->
                    <div style="width:100%;height: 8%;">
                        <!-- <button type="button" class="layui-btn layui-btn-lg" style="float: right;margin-right: 10px;">发布</button> -->
                        <button id="extra_geojson_remain" type="button" class="layui-btn layui-btn-lg"
                            style="float: right;margin-right: 10px;">复核</button>
                        <button id="extra_geojson_plot" type="button" class="layui-btn layui-btn-lg"
                            style="float: right;margin-right: 10px;">绘图</button>
                        <!-- <button type="button" class="layui-btn layui-btn-lg" style="float: right;"></button>                     -->
                    </div>
                </div>

            </div>



        </div>
        <!-- 请求数据的表格 -->
        <div id="get_data_table" style="width:100%;height:100%;overflow: hidden;">
            <div class="layui-inline" style="width: 500px;">
                <div class="layui-inline" style="width: 250px;">
                    <input class="layui-input" name="id" id="SearchReload_real" autocomplete="off">
                </div>
                <button id="real_redis_plot" class="layui-btn" data-type="reload"
                    style="float: right;margin-left: 10px;">绘图</button>
                <button id="TableSearch_real" class="layui-btn" data-type="reload"
                    style="float: right;margin-left: 10px;">搜索</button>
                <button id="TableReload_real" class="layui-btn" data-type="reload" style="float: right;">重置</button>

            </div>
            <table class="layui-hide" id="get_data_table_content" style="width: 500px;"></table>
        </div>
        <!-- 快报设置的相关 -->
        <script>
            const extra_server_obj = {
                recv_rain: undefined,
                recv_wind: undefined,
                recv_tmax: undefined,
                recv_view: undefined,
                del_rain: function (station_id) {
                    newArray = extra_server_obj.recv_rain.filter(function (item) {
                        return item.IIIII !== station_id
                    });
                    extra_server_obj.recv_rain = undefined
                    extra_server_obj.recv_rain = newArray
                },
                plot_rain: function () {
                    extra_server_obj.recv_rain.forEach(function (item) {
                        var latlng = L.latLng(item.Lat, item.Lon);
                        var tooltips = item.StationName + "-" + item.IIIII + "<br>" + "    纬度:" + item.Lat.toFixed(2).toString() + "  " + "经度:" + item.Lon.toFixed(2).toString() + "<br>" + "    " + item.City + "-" + item.Cnty + "-" + item.Town
                        if (item.rain > 0 && item.rain <= 5) {
                            var colors = "white"
                            var iflabel = false
                        }
                        else if (item.rain > 5 && item.rain <= 17) {
                            var colors = "green"
                            var iflabel = false
                        }
                        else if (item.rain > 17 && item.rain <= 38) {
                            var colors = "blue"
                            var iflabel = false
                        }
                        else if (item.rain > 38 && item.rain <= 74) {
                            
                            var colors = "red"
                            // var colors = "blue"
                            var iflabel = false
                        }
                        else if (item.rain > 74) {
                            var colors = "rgb(210,5,234)"
                            var iflabel = false
                        }
                        if (item.std > 0) {
                            var circle = L.circleMarker(latlng, {
                                stationname: item.StationName,
                                stationnum: item.IIIII,
                                radius: 20,
                                fill: false,
                                color: "red"
                            }).addTo(extra_server_obj.current_map)
                        }

                        // 添加散点插件
                        var c = L.circleMarker(latlng, {
                            stationname: item.StationName,
                            stationnum: item.IIIII,
                            weight: 0,
                            radius: 8,
                            opacity: 0,
                            fill: false,
                            color: colors,
                            fillColor: colors,
                            fillOpacity: 1,
                            labelStyle: {
                                text: item.rain,
                                collisionFlg: false,
                                // offsetY: -25,
                                scale: 1.5,
                                weight: 3,
                                rotation: 0,
                                fillStyle: colors,
                                zIndex: 60
                            }
                        }).bindTooltip(tooltips, {
                            direction: "top",
                            offset: L.point(0, -10)
                        }).openTooltip();
                        c.addTo(extra_server_obj.current_map).on("click", function (e) {
                            extra_server_obj.del_rain(e.sourceTarget.options.stationnum)
                            extra_server_obj.flush_map()
                            extra_server_obj.plot_rain()
                        })
                    })

                },
                plot_wind: function () {
                    extra_server_obj.recv_wind.forEach(function (item) {
                        var tooltips = item.StationName + "-" + item.IIIII + "<br>" + "    纬度:" + item.Lat.toFixed(2).toString() + "  " + "经度:" + item.Lon.toFixed(2).toString() + "<br>" + "    " + item.City + "-" + item.Cnty + "-" + item.Town
                        if (item.wind > 17.3) {
                            var colors = "red"
                            var latlng = L.latLng(item.Lat, item.Lon);
                            // 添加散点插件
                            var c = L.circleMarker(latlng, {
                                stationname: item.StationName,
                                stationnum: item.IIIII,
                                weight: 0,
                                radius: 8,
                                opacity: 0,
                                fill: false,
                                color: colors,
                                fillColor: colors,
                                fillOpacity: 1,
                                labelStyle: {
                                    text: item.wind,
                                    collisionFlg: false,
                                    // offsetY: -25,
                                    scale: 1.5,
                                    weight: 3,
                                    rotation: 0,
                                    fillStyle: colors,
                                    zIndex: 60
                                }
                            }).bindTooltip(tooltips, {
                                direction: "top",
                                offset: L.point(0, -10)
                            }).openTooltip();
                            c.addTo(extra_server_obj.current_map)
                        }

                    })

                },
                plot_tmax: function () {
                    extra_server_obj.recv_tmax.forEach(function (item) {
                        var latlng = L.latLng(item.Lat, item.Lon);
                        var tooltips = item.StationName + "-" + item.IIIII + "<br>" + "    纬度:" + item.Lat.toFixed(2).toString() + "  " + "经度:" + item.Lon.toFixed(2).toString() + "<br>" + "    " + item.City + "-" + item.Cnty + "-" + item.Town

                        if (item.tmax > 37 && item.tmax < 40) {
                            var colors = "pink"
                            var iflabel = false
                            // 添加散点插件
                            var c = L.circleMarker(latlng, {
                                stationname: item.StationName,
                                stationnum: item.IIIII,
                                weight: 0,
                                radius: 8,
                                opacity: 0,
                                fill: false,
                                color: colors,
                                fillColor: colors,
                                fillOpacity: 1,
                                labelStyle: {
                                    text: item.tmax,
                                    collisionFlg: false,
                                    // offsetY: -25,
                                    scale: 1.5,
                                    weight: 3,
                                    rotation: 0,
                                    fillStyle: colors,
                                    zIndex: 60
                                }
                            }).bindTooltip(tooltips, {
                                direction: "top",
                                offset: L.point(0, -10)
                            }).openTooltip();
                            c.addTo(extra_server_obj.current_map)
                        }
                        else if (item.tmax >= 40) {
                            var colors = "red"
                            var iflabel = false
                            // 添加散点插件
                            var c = L.circleMarker(latlng, {
                                stationname: item.StationName,
                                stationnum: item.IIIII,
                                weight: 0,
                                radius: 8,
                                opacity: 0,
                                fill: false,
                                color: colors,
                                fillColor: colors,
                                fillOpacity: 1,
                                labelStyle: {
                                    text: item.tmax,
                                    collisionFlg: false,
                                    // offsetY: -25,
                                    scale: 1.5,
                                    weight: 3,
                                    rotation: 0,
                                    fillStyle: colors,
                                    zIndex: 60
                                }
                            }).bindTooltip(tooltips, {
                                direction: "top",
                                offset: L.point(0, -10)
                            }).openTooltip();
                            c.addTo(extra_server_obj.current_map)
                        }
                    })

                },
                plot_view: function () {
                    extra_server_obj.recv_view.forEach(function (item) {
                        var latlng = L.latLng(item.Lat, item.Lon);
                        var tooltips = item.StationName + "-" + item.IIIII + "<br>" + "    纬度:" + item.Lat.toFixed(2).toString() + "  " + "经度:" + item.Lon.toFixed(2).toString() + "<br>" + "    " + item.City + "-" + item.Cnty + "-" + item.Town
                        if (item.view > 500 && item.view <= 1000) {
                            var colors = "blue"
                            // 添加散点插件
                            var c = L.circleMarker(latlng, {
                                stationname: item.StationName,
                                stationnum: item.IIIII,
                                weight: 0,
                                radius: 8,
                                opacity: 0,
                                fill: false,
                                color: colors,
                                fillColor: colors,
                                fillOpacity: 1,
                                labelStyle: {
                                    text: item.view,
                                    collisionFlg: true,
                                    // offsetY: -25,
                                    scale: 1.5,
                                    weight: 3,
                                    rotation: 0,
                                    fillStyle: colors,
                                    zIndex: 60
                                }
                            }).bindTooltip(tooltips, {
                                direction: "top",
                                offset: L.point(0, -10)
                            }).openTooltip();
                            c.addTo(extra_server_obj.current_map)
                        }
                        else if (item.view > 200 && item.view < 500) {
                            var colors = "orange"
                            var iflabel = false
                            // 添加散点插件
                            var c = L.circleMarker(latlng, {
                                stationname: item.StationName,
                                stationnum: item.IIIII,
                                weight: 0,
                                radius: 8,
                                opacity: 0,
                                fill: false,
                                color: colors,
                                fillColor: colors,
                                fillOpacity: 1,
                                labelStyle: {
                                    text: item.view,
                                    collisionFlg: true,
                                    // offsetY: -25,
                                    scale: 1.5,
                                    weight: 3,
                                    rotation: 0,
                                    fillStyle: colors,
                                    zIndex: 60
                                }
                            }).bindTooltip(tooltips, {
                                direction: "top",
                                offset: L.point(0, -10)
                            }).openTooltip();
                            c.addTo(extra_server_obj.current_map)
                        }
                        else if (item.view < 50 && item.view > 0) {
                            var colors = "red"
                            var iflabel = false
                            // 添加散点插件
                            var c = L.circleMarker(latlng, {
                                stationname: item.StationName,
                                stationnum: item.IIIII,
                                weight: 0,
                                radius: 8,
                                opacity: 0,
                                fill: false,
                                color: colors,
                                fillColor: colors,
                                fillOpacity: 1,
                                labelStyle: {
                                    text: item.view,
                                    collisionFlg: true,
                                    // offsetY: -25,
                                    scale: 1.5,
                                    weight: 3,
                                    rotation: 0,
                                    fillStyle: colors,
                                    zIndex: 60
                                }
                            }).bindTooltip(tooltips, {
                                direction: "top",
                                offset: L.point(0, -10)
                            }).openTooltip();
                            c.addTo(extra_server_obj.current_map)
                        }
                    })

                },
                current_data: undefined,
                current_map: undefined,
                upload_data: undefined,
                remain:function(){
                    if (extra_server_obj.recv_rain) {
                        var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                        var send_rain = JSON.stringify(extra_server_obj.recv_rain)
                        var send_wind = JSON.stringify(extra_server_obj.recv_wind)
                        var send_tmax = JSON.stringify(extra_server_obj.recv_tmax)
                        var send_view = JSON.stringify(extra_server_obj.recv_view)
                        $.ajax({
                            url: "station_zdz_data",  // 请求的地址
                            type: "post",  // 请求方式
                            timeout: 25000, //设置延迟上限
                            data: {
                                'csrfmiddlewaretoken': csrf,
                                'model': "extra_geojosn_remain",
                                'rain': send_rain, // 降水
                                'wind': send_wind, // 风力
                                'city_code': "331000",
                                'tmax': send_tmax, // 高温
                                'view': send_view // 能见度
                            },
                            dataType: "json",
                            beforeSend: function (XMLHttpRequest) {
                                load = showLoad();
                            },
                            success: function (recvdate) {
                                // 获取数据
                                // console.log(recvdate)
                                var data_text = recvdate.extra_text
                                $("#text_msg").html("")
                                $("#text_msg").html(data_text)
                                var tab_type = "rain"
                                var tab_id = "extra_rain"
                                extra_server_obj.rander_table(JSON.parse(recvdate.extra_rain), tab_type, tab_id)
                                extra_server_obj.recv_rain = JSON.parse(recvdate.extra_rain)
                                extra_server_obj.recv_wind = JSON.parse(recvdate.extra_wind)
                                extra_server_obj.recv_tmax = JSON.parse(recvdate.extra_tmax)
                                extra_server_obj.recv_view = JSON.parse(recvdate.extra_view)
                                extra_server_obj.flush_map()
                                extra_server_obj.plot_rain()
                                closeLoad(load)
                            }
                        })

                    }

                },
                geojson_plot: function () {
                    if (extra_server_obj.recv_rain) {
                        var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                        var send_data = JSON.stringify(extra_server_obj.recv_rain)
                        var send_type = "rain"
                        $.ajax({
                            url: "station_zdz_data",  // 请求的地址
                            type: "post",  // 请求方式
                            timeout: 25000, //设置延迟上限
                            data: {
                                'csrfmiddlewaretoken': csrf,
                                'model': "extra_geojosn_plot",
                                'start': $("#extra_download-startDate-1").val(),
                                'end': $("#extra_download-endDate-1").val(),
                                'city_code': "331000",
                                'click_type': send_type, // 绘图类型
                                'button_value': send_data // 绘图数据
                            },
                            dataType: "json",
                            beforeSend: function (XMLHttpRequest) {
                                load = showLoad();
                            },
                            success: function (recvdate) {
                                // 获取数据
                                contourf = JSON.parse(recvdate.contour)
                                extra_server_obj.flush_map()
                                var reallayer = L.geoJSON(contourf, {
                                    style: function (feature) {
                                        return { color: feature.properties.stroke, weight: 1, fill: true, fillColor: feature.properties.stroke, fillOpacity: 1 };
                                    }
                                }).addTo(extra_server_obj.current_map)
                                L.mask(taizhou_map, {
                                    // fitBounds:true,
                                    fitBounds: false,
                                    restrictBounds: false,
                                    color: "black",
                                    fillColor: "white",// 边框颜色
                                    fillOpacity: 1,
                                }).addTo(extra_server_obj.current_map);
                                closeLoad(load)
                            }
                        })
                    }
                    else {
                        var send_data = "none"
                        var send_type = "rain"
                    }

                },
                flush_map: function () {
                    if (extra_server_obj.current_map) {
                        extra_server_obj.current_map.eachLayer(function (layer) {
                            if (!layer._container || ('' + jQuery(layer._container).attr('class')).replace(/\s/g, '') != 'leaflet-layer') {
                                layer.remove();
                            }
                        });
                    }
                    var boundaries = map_toolbox_object.return_boundaries(zhejianglist[0].features).boundaries
                    var canvasLabel = new L.CanvasLabel({
                        defaultLabelStyle: {
                            collisionFlg: true,
                            scale: 1,
                            strokeStyle: "#000",
                            fillStyle: "#fff",
                            lineWidth: 3
                        }
                    });
                    var lines = L.geoJSON(boundaries, {
                        style: function (feature) {
                            return { color: 'black', fill: false, weight: 3, fillOpacity: 0.1 };
                        }
                    }).addTo(extra_server_obj.current_map)

                },
                init_map: function () {
                    //地图初始化
                    if (extra_server_obj.current_map) {

                        extra_server_obj.current_map.eachLayer(function (layer) {
                            if (!layer._container || ('' + jQuery(layer._container).attr('class')).replace(/\s/g, '') != 'leaflet-layer') {
                                layer.remove();
                            }
                        });
                        // console.log("flush",extra_server_obj.current_map)
                        var boundaries = map_toolbox_object.return_boundaries(zhejianglist[0].features).boundaries
                        // map_toolbox_object.boundaries = boundaries
                        var canvasLabel = new L.CanvasLabel({
                            defaultLabelStyle: {
                                collisionFlg: true,
                                scale: 1,
                                strokeStyle: "#000",
                                fillStyle: "#fff",
                                lineWidth: 3
                            }
                        });
                        var lines = L.geoJSON(boundaries, {
                            style: function (feature) {
                                return { color: 'black', weight: 3, fill: false };
                            }
                        }).addTo(extra_server_obj.current_map)
                        var corner1 = L.latLng(26, 115),
                            corner2 = L.latLng(34, 125),
                            bound = L.latLngBounds(corner1, corner2);

                    }
                    else {
                        var boundaries = map_toolbox_object.return_boundaries(zhejianglist[0].features).boundaries
                        // map_toolbox_object.boundaries = boundaries
                        var canvasLabel = new L.CanvasLabel({
                            defaultLabelStyle: {
                                collisionFlg: true,
                                scale: 1,
                                strokeStyle: "#000",
                                fillStyle: "white",
                                lineWidth: 3
                            }
                        });
                        var lines = L.geoJSON(boundaries, {
                            style: function (feature) {
                                return { color: 'black',fill:false,  weight: 1, fillOpacity: 0.1 };
                            }
                        })
                        var corner1 = L.latLng(26, 115),
                            corner2 = L.latLng(34, 125),
                            bound = L.latLngBounds(corner1, corner2);
                        var map_extra = new L.Map('extra_server_obj_map', {
                            center: new L.LatLng(28.6, 121.3),//110.763, 41.376   39.62353145, 121.9937485
                            crs: L.CRS.EPSG3857,
                            renderer: canvasLabel,
                            zoom: 9, //4
                            maxZoom: 12,
                            minZoom: 8,
                            zoomControl: false,
                            dragging: true,
                            scrollWheelZoom: true,
                            doubleClickZoom: false,
                            attributionControl: false, //是否去除右下角标志
                            bounds: turf.bbox(boundaries),
                            maxBounds: bound,
                            maxBoundsViscosity: 1.0,
                            layers: [lines]
                        });
                        extra_server_obj.current_map = map_extra
                    }
                },
                rander_table: function (data_table, tab_type, tabid) {
                    if (tab_type == "rain") {
                        var cols_arr = [[ //标题栏
                            { field: 'IIIII', title: 'ID', width: 100, sort: true }
                            , { field: 'Province', title: '省', width: 100 }
                            , { field: 'City', title: '地市', width: 100 }
                            , { field: 'Cnty', title: '县', width: 100 }
                            , { field: 'Town', title: '乡镇', width: 100 }
                            , { field: 'StationName', title: '站名', width: 100 }
                            , { field: 'rain', title: '雨量', width: 150, sort: true }
                            // , { field: 'wind', title: '风力', width: 50, sort: true }
                            // , { field: 'tmax', title: '高温', width: 50, sort: true }
                            // , { field: 'tmin', title: '低温', width: 50, sort: true }
                            // , { field: 'view', title: '能见度', sort: true, width: 50 }                    
                        ]]
                    }
                    else if (tab_type == "wind") {
                        var cols_arr = [[ //标题栏
                            { field: 'IIIII', title: 'ID', width: 100, sort: true }
                            , { field: 'Province', title: '省', width: 100 }
                            , { field: 'City', title: '地市', width: 100 }
                            , { field: 'Cnty', title: '县', width: 100 }
                            , { field: 'Town', title: '乡镇', width: 100 }
                            , { field: 'StationName', title: '站名', width: 100 }
                            // , { field: 'rain', title: '雨量', width: 100, sort: true }
                            , { field: 'wind', title: '风力', width: 150, sort: true }
                            // , { field: 'tmax', title: '高温', width: 50, sort: true }
                            // , { field: 'tmin', title: '低温', width: 50, sort: true }
                            // , { field: 'view', title: '能见度', sort: true, width: 50 }                    
                        ]]

                    }
                    else if (tab_type == "tmax") {
                        var cols_arr = [[ //标题栏
                            { field: 'IIIII', title: 'ID', width: 100, sort: true }
                            , { field: 'Province', title: '省', width: 100 }
                            , { field: 'City', title: '地市', width: 100 }
                            , { field: 'Cnty', title: '县', width: 100 }
                            , { field: 'Town', title: '乡镇', width: 100 }
                            , { field: 'StationName', title: '站名', width: 100 }
                            // , { field: 'rain', title: '雨量', width: 100, sort: true }
                            // , { field: 'wind', title: '风力', width: 50, sort: true }
                            , { field: 'tmax', title: '高温', width: 150, sort: true }
                            // , { field: 'tmin', title: '低温', width: 50, sort: true }
                            // , { field: 'view', title: '能见度', sort: true, width: 50 }                    
                        ]]

                    }
                    else if (tab_type == "view") {
                        var cols_arr = [[ //标题栏
                            { field: 'IIIII', title: 'ID', width: 100, sort: true }
                            , { field: 'Province', title: '省', width: 100 }
                            , { field: 'City', title: '地市', width: 100 }
                            , { field: 'Cnty', title: '县', width: 100 }
                            , { field: 'Town', title: '乡镇', width: 100 }
                            , { field: 'StationName', title: '站名', width: 100 }
                            // , { field: 'rain', title: '雨量', width: 100, sort: true }
                            // , { field: 'wind', title: '风力', width: 50, sort: true }
                            // , { field: 'tmax', title: '高温', width: 50, sort: true }
                            // , { field: 'tmin', title: '低温', width: 50, sort: true }
                            , { field: 'view', title: '能见度', sort: true, width: 150 }
                        ]]

                    }
                    layui.use('table', function () {
                        var table = layui.table;
                        //展示已知数据
                        table.render({
                            elem: '#' + tabid
                            , width: 790
                            , height: 350
                            , totalRow: true
                            , cellMinWidth: 80
                            , cols: cols_arr
                            , data: data_table
                            , skin: 'line' //表格风格
                            , even: true
                            , id: 'tabledata'
                            //,page: true //是否显示分页
                            //,limits: [5, 7, 10]
                            , limit: 800  //每页默认显示的数量
                        });
                        var $ = layui.$, active = {
                            reload: function () {
                                var SearchReload = $('#SearchReload');
                                // console.log("测试", SearchReload.val())
                                var returndata = data_table
                                var search_data = []
                                returndata.forEach(function (item) {
                                    if ((item.IIIII == SearchReload.val()) || (item.StationName == SearchReload.val()) || (item.City == SearchReload.val()) || (item.Cnty == SearchReload.val()) || (item.Town == SearchReload.val())) {
                                        search_data.push(item)
                                    }
                                })
                                //执行重载
                                table.reload('tabledata', {
                                    // page: {
                                    //     curr: 1 //重新从第 1 页开始
                                    // },
                                    // where: {
                                    //     // id : demoReload.val(),
                                    //     key: {
                                    //         id: demoReload.val()
                                    //     }
                                    // },
                                    cols: cols_arr
                                    , data: search_data
                                    , skin: 'line'
                                    , id: 'tabledata'
                                    , limit: 800
                                });
                            }
                        };
                        $('#TableSearch').on('click', function () {
                            var type = $(this).data('type');
                            active[type] ? active[type].call(this) : '';
                        });
                        $('#TableReload').on('click', function () {
                            table.reload('tabledata', {
                                cols: cols_arr
                                , data: data_table
                                , skin: 'line'
                                , id: 'tabledata'
                                , limit: 800
                            });
                        });
                    });

                },
                get_data: function () {

                    var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                    $.ajax({
                        url: "station_zdz_data",  // 请求的地址
                        type: "post",  // 请求方式
                        timeout: 25000, //设置延迟上限
                        data: {
                            'csrfmiddlewaretoken': csrf,
                            'model': "extra_download",
                            'start': $("#extra_download-startDate-1").val(),
                            'end': $("#extra_download-endDate-1").val(),
                            'click_type': $("#city").val(), // 城市
                            'button_value': $("#country").val() // 乡镇
                        },
                        dataType: "json",
                        beforeSend: function (XMLHttpRequest) {
                            load = showLoad();
                        },
                        success: function (recvdate) {
                            // 获取数据
                            var data_table = JSON.parse(recvdate.extra_rain)
                            var data_text = recvdate.extra_text
                            $("#text_msg").html("")
                            $("#text_msg").html(data_text)
                            var tab_type = "rain"
                            var tab_id = "extra_rain"
                            extra_server_obj.rander_table(data_table, tab_type, tab_id)

                            extra_server_obj.recv_rain = data_table
                            extra_server_obj.recv_wind = JSON.parse(recvdate.extra_wind)
                            extra_server_obj.recv_tmax = JSON.parse(recvdate.extra_tmax)
                            extra_server_obj.recv_view = JSON.parse(recvdate.extra_view)
                            // console.log(data_table)
                            extra_server_obj.flush_map()
                            extra_server_obj.plot_rain()



                            closeLoad(load)
                        }
                    })


                }
            }
            // 快报以及绘图
            extra_server_obj.init_map()

            $("#extra_geojson_plot").click(function () {
                extra_server_obj.geojson_plot()

            })

            $("#extra_geojson_remain").click(function () {
                extra_server_obj.remain()

            })

            $("#get_extra_data").click(function () {
                extra_server_obj.get_data()
            })

        </script>
        <!-- 报警参数设置 -->
        <!-- 开始报警相关的设置 -->
        <div id="warring_ui" style="width:100%;height:100%;overflow: hidden;">
            <div style="width:100%;height:100%;">
                <div style="width:100%;height:100%;">
                    <div class="layui-bg-gray" style="padding: 30px;">
                        <div class="layui-row layui-col-space15">
                            <!-- 区域范围 -->
                            <div class="layui-col-md12">
                                <div class="layui-panel" style="height:100px">
                                    <div class="layui-form" style="padding: 30px 10px;">
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">报警</label>
                                            <div class="layui-input-inline">
                                                <select>
                                                    <option value="taizhou" selected="">10分钟降水</option>
                                                    <option value="">1小时分钟降水</option>
                                                    <option value="">3小时分钟降水</option>
                                                    <option value="">6小时分钟降水</option>
                                                    <option value="">12小时分钟降水</option>
                                                    <option value="">24小时分钟降水</option>
                                                </select>
                                            </div>
                                            <div class="layui-input-inline">
                                                <select>
                                                    
                                                    <option value="全市" selected="">台州市</option>
                                                </select>
                                            </div>
                                            <div class="layui-input-inline">
                                                <select>
                                                    <option value="">全市</option>
                                                    <option value="10">玉环</option>
                                                </select>
                                            </div>
                                            <div class="layui-input-inline" style="width:80px;">
                                                <select id="warring_class" style="width:50px;">
                                                    <!-- <option value="none" >静音</option> -->
                                                    <option value="notification" selected="">通知</option>
                                                    <option value="warring">警报</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 报警参数 -->
                            <div class="layui-col-md12">
                                <div class="layui-panel" style="height:400px">
                                    <div class="layui-form" style="padding: 50px 10px;">
                                        <div class="layui-input-inline" style="margin-bottom:20px">
                                            <div class="layui-input-inline" style="margin-left:15px">
                                                <select id="rain_10min" style="width:50px">

                                                    <option value="2" select="">5毫米</option>
                                                    <option value="20">10毫米</option>
                                                    <option value="30">30毫米</option>
                                                    <option value="30">40毫米</option>
                                                    <option value="30">50毫米</option>
                                                    <option value="30">80毫米</option>
                                                    <option value="30">90毫米</option>
                                                </select>
                                            </div>
                                            <input type="checkbox" name="warring_check" value="rain_10min"
                                                lay-skin="primary" checked="" title="降水报警">
                                        </div>

                                        <div class="layui-input-inline" style="margin-bottom:20px">
                                            <div class="layui-input-inline" style="margin-left:15px">
                                                <select id="wind_10min" style="width:50px">
                                                    <option value="9" select="">9级风</option>
                                                    <option value="10">10级风</option>
                                                    <option value="20">11级风</option>
                                                    <option value="30">12级风</option>
                                                </select>
                                            </div>
                                            <input type="checkbox" name="warring_check" value="wind_10min"
                                                lay-skin="primary" checked="" title="风力报警">
                                        </div>

                                        <div class="layui-input-inline" style="margin-bottom:20px">
                                            <div class="layui-input-inline" style="margin-left:15px">
                                                <select id="windave_10min" style="width:50px">
                                                    <option value="" select="">1000米</option>
                                                    <option value="10">500米</option>
                                                    <option value="20">200米</option>
                                                    <option value="30">50米</option>
                                                </select>
                                            </div>
                                            <input type="checkbox" name="warring_check" value="windave_10min"
                                                lay-skin="primary" title="浓雾报警">
                                        </div>

                                        <div class="layui-input-inline" style="margin-bottom:20px">
                                            <div class="layui-input-inline" style="margin-left:15px">
                                                <select id="view_10min" style="width:50px">
                                                    <option value="">37度</option>
                                                    <option value="10">40度</option>
                                                    <option value="20">0度</option>
                                                    <option value="30">30公里</option>
                                                </select>
                                            </div>
                                            <input type="checkbox" name="warring_check" value="view_10min"
                                                lay-skin="primary" title="温度报警">
                                        </div>


                                    </div>
                                </div>
                            </div>
                            <!-- 报警地图 -->
                            <!-- <div class="layui-col-md6">
                                <div class="layui-panel" style="height:400px">
                                    <div class="layui-form" style="padding: 50px 10px;">
                                        
                                    </div>
                                </div>
                            </div> -->

                        </div>
                    </div>

                </div>


            </div>


        </div>
        <!-- 设置 -->
        <div id="station_setting" style="width:100%;height:100%;">
            <ul class="layui-nav layui-nav-tree layui-inline scrollbar"
                style="width:100%;height: 100%;background-color: rgb(40,43,51);overflow-y: scroll;overflow-x: hidden;">
                <li class="layui-nav-item layui-nav-itemed">
                    <button type="button" class="layui-btn layui-btn-fluid ">数据设置</button>
                    <dl class="layui-nav-child">
                        <!-- 数据设置 -->
                        <dd style="height:180px">
                            <div style="height:100%;width:100%;" class="layui-form">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">绘图选项</label>
                                    <div class="layui-input-block">
                                        <input type="radio" name="plot_opt" value="local" title="地图">
                                        <input type="radio" name="plot_opt" value="extra" checked="" title="窗口">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">地图界线</label>
                                    <div class="layui-input-block" style="background-color:rgb(28,30,36);width:49%;">
                                        <select id="village_line">
                                            <option value=""></option>
                                            <option value="taizhou" selected="">台州</option>
                                            <option value="yuhuan">玉环</option>
                                            <option value="wenling">温岭</option>
                                            <option value="huangyan">黄岩</option>
                                            <option value="luqiao">路桥</option>
                                            <option value="jiaojiang">椒江</option>
                                            <option value="xianju">仙居</option>
                                            <option value="linhai">临海</option>
                                            <option value="tiantai">天台</option>
                                            <option value="sanmen">三门</option>
                                        </select>
                                    </div>
                                </div>
                            </div>


                        </dd>
                    </dl>

                </li>
            </ul>
        </div>

        <!-- 雷达剖面 -->
        <div id="radar_sec_div" style="width:100%;height:100%;">
            <div id="radar_sec_img" style="width:100%;height:100%;"></div>
        </div>

        <!-- 提醒文字 -->
        <div id="notice_alert" style="width:100%;height:100%;">
            <table class="layui-hide" id="notice_alert_table" style="width: 280px;"></table>
            <!-- <div id="notice_alert_table" style="width:100%;height:100%;">          
            </div> -->
        </div>

        <!-- 画图的设置 -->
        <div id="extra_real_plot_div" style="width:100%;height:100%;">
            <div style="width:100%;height:50px;">
                <div class="layui-form" style="padding-top:10px;">
                    <div class="layui-inline">
                        <label class="layui-form-label">范围</label>
                        <div class="layui-inline" id="plot_img">
                            <div class="layui-input-inline">
                                <input type="text" autocomplete="off" id="plot_img-startDate-1" class="layui-input"
                                    placeholder="开始日期">
                            </div>
                            <div class="layui-form-mid">-</div>
                            <div class="layui-input-inline">
                                <input type="text" autocomplete="off" id="plot_img-endDate-1" class="layui-input"
                                    placeholder="结束日期">
                            </div>
                        </div>
                        <div class="layui-input-inline" style="width:15%">
                            <select id="color_label" style="width:40%">
                                <option value=""></option>
                                <option value="rain" selected="">降水</option>
                                <option value="wind">风力</option>
                                <option value="tmax">高温</option>
                                <option value="tmin">低温</option>
                            </select>
                        </div>
                        <div class="layui-input-inline" style="width:10%">
                            <select id="extra_real_plot_city" style="width:40%">
                                <option value=""></option>
                                <option value="taizhou" selected="">台州</option>
                                <!-- <option value="sanmen" >三门</option>
                                <option value="linhai" >临海</option>
                                <option value="luqiao" >路桥</option>
                                <option value="wenling">温岭</option>
                                <option value="jiaojiang">椒江</option>
                                <option value="huangyan">黄岩</option>
                                <option value="xianju">仙居</option>
                                <option value="tiantai">天台</option>
                                <option value="yuhuan">玉环</option> -->
                            </select>
                        </div>
                        <button id="plot_image" type="button" class="layui-btn layui-btn-normal">查询</button>
                    </div>
                    <script>
                        function getNextDate(date, day) {
                            var dd = new Date(date);
                            dd.setDate(dd.getDate() + day);
                            var y = dd.getFullYear();
                            var m = dd.getMonth() + 1 < 10 ? "0" + (dd.getMonth() + 1) : dd.getMonth() + 1;
                            var d = dd.getDate() < 10 ? "0" + dd.getDate() : dd.getDate();
                            return y + "-" + m + "-" + d
                        };
                        layui.use('laydate', function () {
                            var laydate = layui.laydate;
                            var today = new Date()
                            var y = today.getFullYear();
                            var m = today.getMonth() + 1 < 10 ? "0" + (today.getMonth() + 1) : today.getMonth() + 1;
                            var d = today.getDate() < 10 ? "0" + today.getDate() : today.getDate();
                            var h = today.getHours() < 10 ? "0" + today.getHours() + ":00:00" : today.getHours() + ":00:00";
                            var today_str = y + "-" + m + "-" + d + " " + h;
                            var yestorday = getNextDate(today_str, day = -1)
                            var yes_str = yestorday + " " + h;
                            function date_to_str(date) {
                                var year = date.year
                                var month = date.month < 10 ? "0" + date.month.toString() : date.month.toString()
                                var day = date.date < 10 ? "0" + date.date.toString() : date.date.toString()
                                var hour = date.hours < 10 ? "0" + date.hours.toString() : date.hours.toString()
                                var mins = date.minutes < 10 ? "0" + date.minutes.toString() + ":00" : date.minutes.toString() + ":00"
                                date_str = year + "-" + month + "-" + day + " " + hour + ":" + mins;
                                return date_str
                            }
                            laydate.render({
                                elem: '#plot_img'
                                , type: 'datetime'
                                , theme: 'molv'
                                , value: [yes_str, today_str]
                                //设置开始日期、日期日期的 input 选择器
                                //数组格式为 2.6.6 开始新增，之前版本直接配置 true 或任意分割字符即可
                                , range: ['#plot_img-startDate-1', '#plot_img-endDate-1']
                            });
                        })                      
                    </script>
                </div>
            </div>
            <div id="extra_label"
                style="width: 100%;height: 5%;color: white;background-color: blue;text-align: center;padding-top:10px;font-family:STKaiti,KaiTi;font-size: medium;">
            </div>
            <div id="extra_map" style="width:100%;height: 88.5%;background-color: white;"></div>
            <!-- <div id="extra_table" style="width:100%;height: 10.5%;background-color: white;justify-content: center;"> 
            </div> -->

            <script>
                const extra_plot_obj = {
                    current_shp:undefined,
                    current_map: undefined,
                    recvdate: undefined,
                    init: function () {
                        // var boundaries = map_toolbox_object.return_boundaries(zhejianglist[0].features).boundaries
                        var boundaries = map_toolbox_object.return_boundaries(taizhou_map).boundaries
                        var canvasLabel = new L.CanvasLabel({
                            defaultLabelStyle: {
                                collisionFlg: true,
                                scale: 1,
                                strokeStyle: "#000",
                                fillStyle: "black",
                                lineWidth: 3
                            }
                        });
                        var lines = L.geoJSON(boundaries, {
                            style: function (feature) {
                                return { color: 'black', weight: 0.8, fill: false };
                            }
                        })
                        extra_plot_obj.current_shp = lines
                        var map_image = new L.Map('extra_map', {
                            center: new L.LatLng(28.5, 122.7),//110.763, 41.376   39.62353145, 121.9937485
                            renderer: canvasLabel,
                            zoom: 9, //4
                            maxZoom: 12,
                            minZoom: 8,
                            zoomControl: false,
                            dragging: false,
                            scrollWheelZoom: false,
                            doubleClickZoom: false,
                            attributionControl: false, //是否去除右下角标志
                            bounds: turf.bbox(boundaries),
                            // maxBounds: bound,
                            maxBoundsViscosity: 1.0,
                            layers: [lines]
                        });
                        extra_plot_obj.current_map = map_image
                        //  logo
                        // var imagurl = "http://172.21.158.40:9001/media/logo/tzlogo.jpg"
                        // var imageBounds = [[29.10, 120.1], [29.41, 120.5]];//图片的经纬度范围，西南角点,东北角点(纬度、经度)
                        // var imageLayer = L.imageOverlay(imagurl, imageBounds, { opacity: 1 });//opacity是透明度
                        // map_image.addLayer(imageLayer);

                    },
                    flash_map: function () {
                        if (extra_plot_obj.current_map) {
                            extra_plot_obj.current_map.eachLayer(function (layer) {
                                if (!layer._container || ('' + jQuery(layer._container).attr('class')).replace(/\s/g, '') != 'leaflet-layer') {
                                    layer.remove();
                                }
                            });
                        }
                    },
                    plot_mark:function(plot_type,plot_data){
                        if(plot_type=="wind"){
                            plot_data.forEach(function (item) {
                                if (item.value >0 ) {
                                    var colors = "red" // 粉色
                                    var latlng = L.latLng(item.Lat, item.Lon);
                                    var icon = L.WindBarb.icon({
                                        color: "red",
                                        deg: item.WIN_D_Gust_Max,
                                        pointRadius: 8,
                                        strokeColor: colors,
                                        strokeLength: 25,
                                        forceDir: true,
                                        // barbSpaceing:4,
                                        // barbHeight:20,
                                        fillColor: colors,
                                        speed: (item.value*2.5)
                                    });
                                    var marker = L.marker([item.Lat, item.Lon], {
                                        icon: icon,
                                        name: item.Station_Id_C,
                                        stationname: item.Station_Name,
                                        stationnum: item.Station_Id_C,
                                        deg: item.WIN_D_Gust_Max,
                                        sped: item.value*2.5,
                                        station: item.Station_Name
                                    })

                                    marker.addTo(extra_plot_obj.current_map) 

                                }

                            })

                        }

                    },
                    get_image: function (js_status,current_data) {
                        var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                        if (js_status=="none"){ 
                            var senddata="none"
                            var ajaxdata = {
                                'csrfmiddlewaretoken': csrf,
                                'model': 'plot_image',
                                'click_type': $("#color_label").val(),// plot_type 风雨温
                                'button_value': $("#extra_real_plot_city").val(),// 城市
                                'start': $("#plot_img-startDate-1").val(),
                                'end': $("#plot_img-endDate-1").val(),
                                'current_data':senddata,
                                'js_status':js_status
                            }
                        }
                        else { 
                            // js 的基本数据
                            var senddata = current_data
                            var ajaxdata = {
                                'csrfmiddlewaretoken': csrf,
                                'model': 'plot_image',
                                'click_type': map_toolbox_object.current_data_type,// plot_type 风雨温
                                'button_value': $("#extra_real_plot_city").val(),// 城市
                                'start': $("#plot_img-startDate-1").val(),
                                'end': $("#plot_img-endDate-1").val(),
                                'current_data':senddata,
                                'js_status':js_status
                            }
                        }
                        $.ajax({
                            url: "station_zdz_data",  // 请求的地址
                            type: "post",  // 请求方式
                            timeout: 25000, //设置延迟上限
                            data: ajaxdata,
                            dataType: "json",
                            beforeSend: function (XMLHttpRequest) {
                                load = showLoad();
                            },
                            success: function (recvdate) {
                                console.log(JSON.parse(recvdate.mark));  
                                // 直接加载图片的方法                      
                                // var imags = new Image()
                                // imags.src = recvdate.imgs
                                // var imageBounds = [[27.8, 120.2], [29.5, 122]];//图片的经纬度范围，西南角点,东北角点(纬度、经度)
                                // var imageLayer = L.imageOverlay(imags, imageBounds, { opacity: 1 });//opacity是透明度
                                // extra_plot_obj.current_map.addLayer(imageLayer);
                                extra_plot_obj.flash_map()
                                contourf = JSON.parse(recvdate.contour)
                                var reallayer = L.geoJSON(contourf, {
                                    style: function (feature) {
                                        return { color: feature.properties.stroke, weight: 1, fill: true, fillColor: feature.properties.stroke, fillOpacity: 1 };
                                    }
                                }).addTo(extra_plot_obj.current_map)
                                extra_plot_obj.plot_mark(recvdate.plot_type,JSON.parse(recvdate.mark))
                                L.mask(taizhou_map, {
                                    // fitBounds:true,
                                    fitBounds: false,
                                    restrictBounds: false,
                                    color: "black",
                                    fillColor: "white",// 边框颜色
                                    fillOpacity: 1,
                                }).addTo(extra_plot_obj.current_map);
                                
                                closeLoad(load)
                            }
                        })
                    }
                }
                extra_plot_obj.init()
                extra_plot_obj.current_map.on('click', function (e) {
                    console.log(e.latlng)
                });
                map_toolbox_object.current_map.on('click', function (e) {
                    console.log(e.latlng)
                });
                $("#real_redis_plot").click(function () {
                    var js_status = "True"
                    var current_data = JSON.stringify(map_toolbox_object.recv_all_data)
                    extra_plot_obj.get_image(js_status,current_data)
                    layer.open({
                        type: 1,
                        title: "绘图",
                        maxmin: true,
                        moveOut: true,
                        // resize:true,
                        skin: 'layui-layer-lan', //样式类名
                        closeBtn: 1, //不显示关闭按钮
                        area: ['800px', '880px'],
                        maxHeight: 600,
                        maxWidth: 1200,
                        anim: 0,
                        shade: 0,
                        zIndex: 9999,
                        shadeClose: false, //开启遮罩关闭
                        content: $("#extra_real_plot_div")
                    });

                })
                $("#plot_image").click(function () {
                    $("#extra_label").html("")
                    var values = {
                        "rain": " 累积雨量（毫米）",
                        "wind": " 最大风力",
                        "tmax": " 最高气温",
                        "tmin": " 最低气温",
                    }
                    // console.log($("#plot_img-startDate-1").val(), $("#plot_img-endDate-1").val())
                    var label = $("#plot_img-startDate-1").val().substring(5, 7) + "月" + $("#plot_img-startDate-1").val().substring(8, 10) + "日" + $("#plot_img-startDate-1").val().substring(11, 13) + "时" + "～"
                    label = label + $("#plot_img-endDate-1").val().substring(5, 7) + "月" + $("#plot_img-endDate-1").val().substring(8, 10) + "日" + $("#plot_img-endDate-1").val().substring(11, 13) + "时"
                    label = label + values[$("#color_label").val()]
                    $("#extra_label").html(label)
                    extra_plot_obj.flash_map()
                    var js_status = "False"
                    var current_data = "none"
                    extra_plot_obj.get_image(js_status,current_data)
                })               
            </script>
        </div>

    </div>

    {% csrf_token %}
</body>

</html>