<!DOCTYPE html>
<html lang="en" class="scrollbar_self">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0, user-scalable=yes" />
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" /> -->
    <script src="static/js/jquery.min.js"></script>
    <script src="static/js/popper.min.js"></script>
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <script src="static/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="static/css/jquery.datetimepicker.css" />
    <script src="static/js/jquery.datetimepicker.full.min.js"></script>
    <!-- echart -->
    <script type="text/javascript" src="static/js/echarts.min.js"></script>
    <script type="text/javascript" src="static/js/echarts-gl.min.js"></script>
    <script type="text/javascript" src="static/js/ecStat.min.js"></script>
    <script type="text/javascript" src="static/js/dataTool.min.js"></script>
    <script type="text/javascript" src="static/js/china.js"></script>
    <script type="text/javascript" src="static/js/world.js"></script>
    <!-- hightchart -->
    <script src="static/js/highcharts.js"></script>
    <script src="static/js/windbarb.js"></script>
    <script src="static/js/exporting.js"></script>
    <script src="static/js/export-data.js"></script>
    <script src="static/js/accessibility.js"></script>
    <!-- leaflet -->
    <link rel="stylesheet" href="static/css/leaflet.css" />
    <script src="static/js/leaflet.js"></script>
    <script type="text/javascript" src="static/js/leaflet-windbarb.js"></script>
    <script src="static/js/leaflet.canvaslabel.js"></script>
    <!-- 使用turf -->
    <script src="static/js/turf.min.js"></script>
    <!-- tinymce -->
    <script src="static/editor/tinymce.min.js"></script>
    <script src="static/editor/vendor/FileSaver.js"></script>
    <script src="static/editor/html-docx.js"></script>
    <script src="static/js/pdfobject.js"></script>
    <!-- 数据 -->
    <script src='static/js/taizhou.js'></script>
    <script src='static/js/taizhoulist.js'></script>
    <script src='static/js/taizhouxiangzhen.js'></script>
    <script type="text/javascript" src="static/js/乡镇名称.js"></script>
    <!-- 引入 layui.css -->
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.7.6/css/layui.css" rel="stylesheet"> -->
    <!-- 引入 layui.js -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/layui/2.7.6/layui.js"></script> -->

    <!-- 引入 layui.css -->
    <link href="static/layui/css/layui.css" rel="stylesheet">
    <!-- 引入 layui.js -->
    <script src="static/layui/layui.js"></script>



    <!-- 颜色选择器 -->
    <script src="static/js/colorpicker.js"></script>
    <link rel="stylesheet" href="static/css/colorpicker.css">
    <style type="text/css">
        .scrollbar_self::-webkit-scrollbar {
            display: none;
        }

        .menu-ui {
            background: #fff;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 999;
            border-radius: 3px;
            width: 120px;
            border: 1px solid rgba(0, 0, 0, 0.4);
        }

        .menu-self-ui {
            background: #fff;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 999;
            border-radius: 3px;
            width: 120px;
            border: 1px solid rgba(0, 0, 0, 0.4);
        }

        .my-div-icon {
            font-size: 20px;
            /* border:1px solid black; */
            /* width: 600px;
            height:150px; */
            /*background:red;*/
            /*width:5px;*/
            color: rgb(22, 21, 21);
        }

        .label_plot_rain {
            font-size: 15px;
            /* border:1px solid black; */
            /* width: 600px;
            height:150px; */
            /*background:red;*/
            /*width:5px;*/
            color: rgb(22, 21, 21);
        }
        .label_plot_temp {
            font-size: 5px;
            /* border:1px solid black; */
            /* width: 600px;
            height:150px; */
            /*background:red;*/
            /*width:5px;*/
            color: rgb(22, 21, 21);
        }

        .chartecmap {
            width: 880px;
            height: 400px;
            background-color: white;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        .chartzdzmap {
            width: 600px;
            height: 440px;
            /* background-color: white; */
            /* border-radius: 15px; */
        }
        
    </style>
    <title>决策服务模板平台</title>

</head>

<body>
    <!-- 全局布局 -->
    <div
        style="display: flex;align-content:flex-start;position: absolute; justify-content: center; flex-wrap: wrap; width: 100%;height: 100%;  background-color: rgb(243, 244, 247)">
        <!-- 导航栏 -->
        {% csrf_token %}
        <div style="background-color:rgba(57,61,73); width: 100%; height: 4%;">
            <div class="tabbable" id="tabs-01" style="display:flex;width: 100%; height: 100%;">
                <ul class="nav nav-tabs" style="border-bottom: 0px;;font-size: 14px;font-weight:900;font-family:'宋体';width: 100%;">
                    <li class="active">
                        <a href="#panel-1" data-toggle="tab" style="height:35px;color: red">材料制作</a>
                    </li>
                    <li>
                        <a id="toolbox" href="#panel-2" data-toggle="tab" style="height:35px;color: red;">工具箱</a>
                    </li>
                    <!-- <li>

                        <a href="#panel-3" data-toggle="tab">画图</a>
                    </li> -->
                    <li>
                        <!-- 另外添加一个说明文档 -->
                        <a id="awebsite" href="#panel-5" data-toggle="tab" style="height:35px;color: red;">快捷网址</a>
                    </li>
                    <li style="float: right;">
                        <!-- 另外添加一个说明文档 -->
                        <a href="#panel-4" data-toggle="tab" style="height:35px;color: red;">帮助</a>
                    </li>                 
                </ul>
            </div>
        </div>
        <div id="index_main"
            style="background-color:rgb(220, 222, 226);width: 100%; height: 96%;display:flex;overflow-y: hidden; ">
            <!-- 决策材料类型 -->
            <div style=" width: 50%; height: 100%">
                <!-- 文件头 -->
                <div style=" width: 100%; height: 100%;">
                    <!-- 材料类型选项卡 -->
                    <div class="tab-content" style="display:block;width: 100%; height: 100%;">
                        <!-- tinymce -->
                        <div class="tab-pane active" id="panel-1" style="width:100%;height:100%;">
                            <div style="display:inline-block;width:100%;height:100%">
                                <!-- 打开功能的实现 -->
                                <div style="width: 100%; height: 0px;">
                                    <a id="modal-000001" href="#modal-container-000001" role="button" class="btn"
                                        data-toggle="modal">新建</a>
                                    <a id="modal-000002" href="#modal-container-000002" role="button" class="btn"
                                        data-toggle="modal">打开</a>
                                    <a id="modal-000003" href="#modal-container-000003" role="button" class="btn"
                                        data-toggle="modal">删除</a>
                                    <a id="modal-000004" href="#modal-container-000004" role="button" class="btn"
                                        data-toggle="modal">配置</a>
                                    <!-- <div id="button_type_list" style="display: inline-flex;width:50%;height:80%"></div> -->

                                    <!-- 新建 -->
                                    <div class="modal fade" id="modal-container-000001" role="dialog"
                                        aria-labelledby="myModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content" style="background-color:rgb(57,61,73);">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal"
                                                        aria-hidden="true"></button>
                                                    <h4 class="modal-title" id="myModalLabel" style="font-size: 20px; font-weight:800;color:white">
                                                        新建材料
                                                    </h4>
                                                </div>
                                                <div class="modal-body" style="height: 400px;background-color: rgb(57,61,73);">
                                                    <!-- 新建材料的内容展示区 -->
                                                    <div style="display: inline-flex;width:100%;height:100%;">
                                                        <div style="width:15%;height:100%;">

                                                        </div>
                                                        <!-- 新建材料的内容展示区 -->
                                                        <div style="width:70%;height:100%;border: 1px solid rgb(243, 244, 247);border-radius: 15px;background-color:white">
                                                            <div style="width:100%;height:15%;"></div>
                                                            <div style="display:inline-block; ;width:100%;height:15%;">
                                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;材料种类:
                                                                <select id="new_document_type"
                                                                    style="width:60%;height:80%;border:0">
                                                                </select>
                                                            </div>
                                                            <div style="display:inline-block; ;width:100%;height:15%;">
                                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;撰稿人:&nbsp;&nbsp;&nbsp;&nbsp;
                                                                <select id="new_document_writer"
                                                                    style="width:20%;height:80%;border:0"></select>
                                                                &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;签发人:
                                                                <select id="new_document_publisher"
                                                                    style="width:20%;height:80%;border:0"></select>
                                                            </div>
                                                            <div style="display:inline-block; ;width:100%;height:15%;">
                                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;发布单位:
                                                                <select id="new_document_unity"
                                                                    style="width:36%;height:80%;border:0"></select>
                                                                期数:&nbsp;&nbsp;&nbsp;<input type="number" id="document_item" style="width:10%;border:0">
                                                                
                                                            </div>
                                                            <div style="display:inline-block; ;width:100%;height:15%;">
                                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;发布日期:
                                                                <input id="create_doc_date" type="text"
                                                                    placeholder="请选择日期"
                                                                    style="width:60%;height:50%;border:1px solid black;text-align: center;"
                                                                    ;>
                                                            </div>
                                                            <div style="display:inline-block;;width:100%;height:10%;">
                                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;模块类型:
                                                                <div style="display:inline-flex;width:60%;height:80%">
                                                                    <div
                                                                        style="width:10%;height:100%;;border:1px solid black">
                                                                        <div style=";width:100%;height:40%">
                                                                            <select id="png_text_add" autocomplete="off"
                                                                                style="appearance:none;border: none;width:100%;height:100%;background-image: url(static/src/加.png);background-size: 50%;background-repeat: no-repeat;">
                                                                                <option style="display:none;" selected></option>
                                                                                <option value="段落">段落</option>
                                                                                <option value="图表">图表</option>
                                                                                <option value="列表">列表</option>
                                                                                <option value="短期">短期</option>
                                                                                <option value="十天">七天</option>
                                                                                <option value="建议">建议</option>
                                                                            </select>

                                                                        </div>
                                                                        <div style=";width:100%;height:50%;padding-top:1px">
                                                                            <button id="delete_png_text"
                                                                                style=";width:100%;border: none;background-color:white;height:100%;background-image: url(static/src/减.png);background-size: 60%;background-repeat: no-repeat;"></button>
                                                                        </div>

                                                                    </div>
                                                                    <div id="png_add_list"
                                                                        style="display:flex;width:90%;height:100%;padding-top: 3px;;border:1px solid black">

                                                                    </div>
                                                                    <script>
                                                                        let png_add_list = []
                                                                        // <span class="layui-badge layui-bg-green">绿</span>
                                                                        $('#png_text_add').change(function () {
                                                                            var select_span = document.createElement('span');
                                                                            select_span.setAttribute("class","layui-badge layui-bg-green")
                                                                            select_span.innerText = $('#png_text_add').val()
                                                                            select_span.style = "margin-right:5px"
                                                                            $('#png_add_list').append(select_span)
                                                                            png_add_list.push($('#png_text_add').val())
                                                                            // 取消select 文字
                                                                            $('#png_text_add').prop('selectedIndex', 0);
                                                                        })
                                                                        $('#delete_png_text').click(function () {
                                                                            $('#png_add_list').children().eq(-1).remove()
                                                                            png_add_list.pop()
                                                                            // console.log(png_add_list)

                                                                        })


                                                                    </script>
                                                                </div>

                                                            </div>
                                                            <script>
                                                                $('#create_doc_date').datetimepicker({                                                                    
                                                                    format: 'Y-m-d H:i'
                                                                }
                                                                );
                                                            </script>
                                                        </div>
                                                        
                                                    </div>
                                             
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-default"
                                                        data-dismiss="modal">返回
                                                    </button>
                                                    <button id="new_document_post" type="button" class="btn btn-primary"
                                                        data-dismiss="modal">创建
                                                    </button>
                                                </div>
                                                <script>
                                                    // 后端数据的传输
                                                    const list_button_object = {
                                                        type_list: ['段落', '图表'],
                                                        type: "一周天气预测",
                                                        data: [],
                                                        item: 47,
                                                        year: 2022,
                                                        unity: "台州市气象局",
                                                        writer: "翁之梅",
                                                        publisher: "冯坚",
                                                        time: "2022年8月12日15时",
                                                        localitem: undefined,
                                                        cerate_div_button: function () {
                                                            $('#button_type_list').html("")
                                                            for (var i = 0; i < this.type_list.length; i++) {
                                                                this.data.push(this.render_data_list(i))
                                                                // var div_single = document.createElement("div")
                                                                // div_single.style = "width: 15%; height: 30px;;padding-top:6px"
                                                                var button_single = document.createElement("button")
                                                                button_single.style = "margin-top:1px;border-radius:5px;"
                                                                button_single.setAttribute("class", "layui-btn layui-btn-sm layui-btn-radius layui-btn-danger")
                                                                button_single.value = i
                                                                button_single.innerText = this.type_list[i]
                                                                // button_single.style = "border-radius:10px;margin-right:5px"

                                                                // div_single.append(button_single)
                                                                button_single.addEventListener("click", function (doc) {
                                                                    // console.log('内容', doc,this)
                                                                    var item = Number(this.value)
                                                                    var content = list_button_object.data[item]
                                                                    list_button_object.localitem = item
                                                                    tinymce.remove('#content');
                                                                    tinymce.init({
                                                                        selector: '#content',
                                                                        language: 'zh_CN',
                                                                        branding: false,
                                                                        skin: 'oxide-dark',
                                                                        promotion: false,
                                                                        plugin_plothtml_width: "300%",
                                                                        menubar: false,
                                                                        plugins: "newfile openfile advlist anchor autolink autosave charmap code codesample emoticons footer fullscreen help image importcss indent2em insertdatetime link lists media nonbreaking pagebreak plothtml preview quickbars save searchreplace table template visualblocks wordcount",
                                                                        toolbar: [
                                                                            "newfile openfile urldialog",
                                                                            "insertfile undo redo bold italic underline hr |alignleft aligncenter alignright formatselect fontselect fontsizeselect removeformat subscript superscript charmap searchreplace insertdatetime forecolor backcolor fontsize fontfamily",//段落
                                                                            "image code link unlink rotateleft rotateright flipv fliph editimage imageoptions quickimage | table | bullist numlist| | footer plothtml"
                                                                        ],
                                                                        font_family_formats: "宋体='宋体';仿宋='仿宋';微软雅黑='微软雅黑';楷体='楷体';;隶书='隶书';幼圆='幼圆';Andale Mono=andale mono,times;Arial=arial,helvetica,sans-serif;Arial Black=arial black,avant garde;Book Antiqua=book antiqua,palatino;Comic Sans MS=comic sans ms,sans-serif;Courier New=courier new,courier;Georgia=georgia,palatino;Helvetica=helvetica;Impact=impact,chicago;Symbol=symbol;Tahoma=tahoma,arial,helvetica,sans-serif;Terminal=terminal,monaco;Times New Roman=times new roman,times;Trebuchet MS=trebuchet ms,geneva;Verdana=verdana,geneva;Webdings=webdings;Wingdings=wingdings",
                                                                        font_size_formats: '12px 14px 16px 18px 20px 24px 26px 28px 30px 32px 34px 36px 38px',
                                                                        setup: (editor) => {
                                                                            editor.ui.registry.addButton('urldialog', {
                                                                                // icon: 'code',
                                                                                text: '快速画图',
                                                                                onAction: () => editor.windowManager.openUrl({
                                                                                    title: '画图页面',
                                                                                    url: 'http://127.0.0.1:9991/canvas_plot',
                                                                                    height: 820,
                                                                                    width: 1300,
                                                                                })
                                                                            })
                                                                        },


                                                                    });
                                                                    // var contentDocument = tinymce.get('content').getContent();
                                                                    // if(content==contentDocument){
                                                                    //     console.log("有内容")

                                                                    // }
                                                                    // else{
                                                                    //     console.log("无内容")
                                                                    // }
                                                                    $('#content').val(content)

                                                                })
                                                                $('#button_type_list').append(button_single)
                                                                // $('#button_type_list').append(div_single)
                                                            }

                                                        },
                                                        render_data_list: function (item) {
                                                            var doc_type = this.type_list[item]
                                                            var id_number = item
                                                            var doc_data_obj = {
                                                                type: doc_type,
                                                                id: id_number,
                                                                content: ""
                                                            }
                                                            return doc_data_obj
                                                        },
                                                        render_head_info: function () {

                                                            var line1 = '<p style="text-align: center;"><span style="font-size: 36pt; color: rgb(224, 62, 45);">' + this.type + '</span></p>'
                                                            var line2 = '<p style="text-align: center;"><span style="font-size: 12pt; color: rgb(0, 0, 0); font-family: \'times new roman\', times, serif;">第' + this.item.toString() + '期</span></p>'
                                                            var line3 = '<table style=" width: 100%;border:none;"><colgroup><col style="width: 33.3333%;"><col style="width: 33.3333%;"><col style="width: 33.3333%;"></colgroup>'
                                                            var line4 = '<tbody><tr><td style="border-width: 1px;">&nbsp;</td><td style="border-width: 1px;">&nbsp;</td>'
                                                            var line5 = '<td style="border-width: 1px; text-align: right;"><span style="font-family: "times new roman", times, serif;">撰稿人：' + this.writer + '</span></td>'
                                                            var line6 = '</tr><tr>'
                                                            var line7 = '<td style="border-width: 1px;"><span style="font-family: \'times new roman\', times, serif;">' + this.time + '</span></td>'
                                                            var line8 = '<td style="border-width: 1px; text-align: center;">' + this.unity + '</td>'
                                                            var line9 = '<td style="border-width: 1px; text-align: right;">签发人：' + this.publisher + '</td>'
                                                            var line10 = '</tr></tbody></table>'
                                                            var line11 = '<hr style="background-color:  #FF0000;">'
                                                            var headerInfo = line1 + line2 + line3 + line4 + line5 + line6 + line7 + line8 + line9 + line10 + line11
                                                            return headerInfo
                                                        }
                                                    }


                                                    $('#new_document_post').click(function () {

                                                        var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                                                        // console.log("向后端传输创建信息", png_add_list)
                                                        var content_doc = ""
                                                        for (var i = 0; i < png_add_list.length; i++) {
                                                            content_doc = content_doc + png_add_list[i] + ","

                                                        }

                                                        // 告诉后端创建一个新的数据，并在前端修改文档标识
                                                        $.ajax({
                                                            url: "create_doc_data",  // 请求的地址
                                                            type: "post",  // 请求方式
                                                            timeout: 250, //设置延迟上限
                                                            data: {
                                                                'csrfmiddlewaretoken': csrf,
                                                                'doc_type': $('#new_document_type').val(),
                                                                'doc_writer': $('#new_document_writer').val(),
                                                                'doc_publisher': $('#new_document_publisher').val(),
                                                                'doc_unity': $('#new_document_unity').val(),
                                                                'doc_date': $('#create_doc_date').val(),
                                                                'doc_list': content_doc
                                                            },
                                                            dataType: "json",
                                                            success: function (data) {
                                                                // 返回以后创建一个对象实例
                                                                // console.log("返回成功", data)
                                                                $('#doc_type').text(data.doc_unity)
                                                                $('#doc_info').text("第" + data.doc_item + "期:  " + data.doc_type)
                                                                list_button_object.year = data.doc_year
                                                                list_button_object.item = data.doc_item
                                                                list_button_object.type = data.doc_type
                                                                list_button_object.type_list = png_add_list
                                                                list_button_object.unity = data.doc_unity
                                                                list_button_object.cerate_div_button()
                                                            }
                                                        })

                                                    })
                                                </script>
                                            </div>

                                        </div>

                                    </div>
                                    <script type="text/javascript">
                                        $('#modal-000001').click(function () {
                                            // console.log('新建文档')
                                            png_add_list = []
                                            $('#png_add_list').html("")
                                            var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                                            $.ajax({
                                                url: "create_new_doc",  // 请求的地址
                                                type: "post",  // 请求方式
                                                timeout: 250, //设置延迟上限
                                                data: {
                                                    'csrfmiddlewaretoken': csrf
                                                },
                                                dataType: "json",
                                                success: function (data) {
                                                    // 'data_publisher': data_publisher,
                                                    // 'data_writers': data_writers,
                                                    // 'data_unity': data_unity,
                                                    // 'data_documenttype': data_documenttype
                                                    $('#new_document_publisher').html("")
                                                    $('#new_document_writer').html("")
                                                    $('#new_document_unity').html("")
                                                    $('#new_document_type').html("")
                                                    for (i = 0; i < data.data_publisher.length; i++) {
                                                        var option_publisher = document.createElement('option');
                                                        option_publisher.value = data.data_publisher[i]
                                                        option_publisher.innerText = data.data_publisher[i]
                                                        $('#new_document_publisher').append(option_publisher)
                                                    }
                                                    for (j = 0; j < data.data_writers.length; j++) {
                                                        var option_writers = document.createElement('option');
                                                        option_writers.value = data.data_writers[j]
                                                        option_writers.innerText = data.data_writers[j]
                                                        $('#new_document_writer').append(option_writers)
                                                    }
                                                    for (k = 0; k < data.data_unity.length; k++) {
                                                        var option_unity = document.createElement('option');
                                                        option_unity.value = data.data_unity[k]
                                                        option_unity.innerText = data.data_unity[k]
                                                        option_unity.style.textAlign = 'center'
                                                        $('#new_document_unity').append(option_unity)
                                                    }
                                                    for (m = 0; m < data.data_documenttype.length; m++) {
                                                        var option_documenttype = document.createElement('option');
                                                        option_documenttype.value = data.data_documenttype[m]
                                                        option_documenttype.innerText = data.data_documenttype[m]
                                                        option_documenttype.style.textAlign = 'center'
                                                        $('#new_document_type').append(option_documenttype)
                                                    }


                                                }

                                            })
                                        })

                                        $('#modal-000002').click(function () {
                                            // console.log('打开文档')
                                            $('#open_item_list').html('')
                                            var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                                            $.ajax({
                                                url: "open_old_doc",  // 请求的地址
                                                type: "post",  // 请求方式
                                                timeout: 250, //设置延迟上限
                                                data: {
                                                    'csrfmiddlewaretoken': csrf
                                                },
                                                dataType: "json",
                                                success: function (data) {
                                                    // console.log(data.type,data.year,data.unity)
                                                    $('#open_select_type').html("")
                                                    for (i = 0; i < data.type.length; i++) {
                                                        var option_type = document.createElement('option');
                                                        option_type.value = data.type[i]
                                                        option_type.innerText = data.type[i]
                                                        $('#open_select_type').append(option_type)
                                                    }
                                                    $('#open_select_year').html("")
                                                    for (i = 0; i < data.year.length; i++) {
                                                        var option_year = document.createElement('option');
                                                        option_year.value = data.year[i]
                                                        option_year.innerText = data.year[i]
                                                        $('#open_select_year').append(option_year)
                                                    }
                                                    $('#open_select_unity').html("")
                                                    for (i = 0; i < data.unity.length; i++) {
                                                        var option_unity = document.createElement('option');
                                                        option_unity.value = data.unity[i]
                                                        option_unity.innerText = data.unity[i]
                                                        $('#open_select_unity').append(option_unity)
                                                    }

                                                }
                                            })
                                        })
                                    </script>
                                    <!-- 打开 -->
                                    <div class="modal fade" id="modal-container-000002" role="dialog"
                                        aria-labelledby="myModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content"  style="background-color:rgb(57,61,73);">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal"
                                                        aria-hidden="true"></button>
                                                    <h4 class="modal-title" id="myModalLabel" style="font-size: 20px; font-weight:800;color:white">
                                                        打开材料
                                                    </h4>
                                                </div>
                                                <div class="modal-body" style="height: 300px;">
                                                    <div
                                                        style="display:inline-block;width:100%;height: 100%;border: 1px solid rgb(243, 244, 247);background-color: white;">
                                                        <!-- <div style="width:100%;height: 25%">
                                                        </div> -->
                                                        <!-- 选项栏 -->
                                                        <div style="display: inline-block;width:100%;height: 12%;">
                                                            <select id="open_select_type"
                                                                style="width: 35%;height:100%;border:0;padding-left:10px;">
                                                            </select>                                                            
                                                            <select id="open_select_year"
                                                                style="width: 15%;height:100%;;border:0;">
                                                            </select>                                                        
                                                            <select id="open_select_unity"
                                                                style="width: 35%;height:100%;;border:0;;padding-left:10px">
                                                            </select>
                                                            <input id="open_document_post" type="button" value="查询"
                                                                style="width:10%;height:90%;background-color: rgb(17, 147, 223);color: white;border:0;border-radius:5px;">
                                                        </div>
                                                        <script type="text/javascript">
                                                            $('#open_document_post').click(function () {
                                                                // console.log($('#open_select_type').val())
                                                                var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                                                                // 告诉后端打开一个新的数据，并在前端修改文档标识
                                                                $.ajax({
                                                                    url: "open_doc_data",  // 请求的地址
                                                                    type: "post",  // 请求方式
                                                                    timeout: 250, //设置延迟上限
                                                                    data: {
                                                                        'csrfmiddlewaretoken': csrf,
                                                                        'type': $('#open_select_type').val(),
                                                                        'unity': $('#open_select_unity').val(),
                                                                        'year': $('#open_select_year').val(),
                                                                    },
                                                                    dataType: "json",
                                                                    success: function (data) {
                                                                        // 返回以后创建一个对象实例
                                                                        // console.log("返回成功", data)
                                                                        $('#open_item_list').html("")
                                                                        for (i = 0; i < data.item.length; i++) {
                                                                            var div_label = document.createElement('div');
                                                                            div_label.style = "width:100%;height:8%;border-radius:5px;margin-top:5px;;margin-bottom:5px;background-color:rgb(0,150,136);padding-left:10%;color:white"
                                                                            var label = document.createElement('label');
                                                                            label.setAttribute("for", "item" + i.toString())
                                                                            label.setAttribute("class", "single_load_document")                                                        
                                                                            label.innerText = "第" + data.item[i] + "期" + "\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0" + data.type[i] 
                                                                            div_label.addEventListener('click',function(){
                                                                                for (var i=0; i<$('#open_item_list').children().length; i++){
                                                                                    var child = $('#open_item_list').children()[i]
                                                                                    child.style = "width:100%;height:8%;border-radius:5px;margin-top:5px;;margin-bottom:5px;background-color:rgb(0,150,136);padding-left:10%;color:white"
                                                                                }
                                                                                this.style = "width:100%;height:8%;border-radius:5px;margin-top:5px;;margin-bottom:5px;background-color:rgb(255,87,34);padding-left:10%;color:white"
                                                                            })
                                                                            var checkitem = document.createElement('input')
                                                                            checkitem.setAttribute("type", "radio")
                                                                            checkitem.setAttribute("name", "load_doc_list")
                                                                            checkitem.id = "item" + i.toString()
                                                                            checkitem.style = "display:none"
                                                                            checkitem.value = i.toString() + "-" + data.year + "-" + data.unity + "-" + data.type[i]
                                                                            div_label.append(label, checkitem)
                                                                            $('#open_item_list').append(div_label)
                                                                        }
                                                                    }
                                                                })
                                                            })
                                                            $(".single_load_document").click(function(){
                                                                this.style = "width:100%;height:8%;border-radius:5px;margin-top:5px;;margin-bottom:5px;background-color:rgb(255,87,34);padding-left:10%;color:white"
                                                            })                                                    
                                                        </script>
                                                        <!-- 加载的栏目 -->
                                                        <div id="open_item_list" class="scrollbar_self"
                                                            style="width:100%;height: 87%;border-top: 1px solid black;;overflow-x: hidden;overflow-y:scroll;">
                                                        </div>

                                                    </div>

                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-default"
                                                        data-dismiss="modal">关闭
                                                    </button>
                                                    <button id="open_load_object" type="button" class="btn btn-primary"
                                                        data-dismiss="modal">加载
                                                    </button>
                                                </div>
                                                <script type="text/javascript">
                                                    $('#open_load_object').click(function () {
                                                        // console.log($('#load_open_object').val())
                                                        var upload_data = $("input[name='load_doc_list']:checked").val()
                                                        // console.log("返回", $("input[name='load_doc_list']:checked").val())
                                                        var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                                                        // 告诉后端打开一个新的数据，并在前端修改文档标识
                                                        $.ajax({
                                                            url: "open_load_object",  // 请求的地址
                                                            type: "post",  // 请求方式
                                                            timeout: 250, //设置延迟上限
                                                            data: {
                                                                'csrfmiddlewaretoken': csrf,
                                                                'info': upload_data
                                                            },
                                                            dataType: "json",
                                                            success: function (res) {
                                                                // 返回以后创建一个对象实例
                                                                // console.log("返回成功", res)
                                                                $('#doc_type').text(res.type)
                                                                $('#doc_info').text("第" + res.item + "期:  " + res.type)
                                                                list_button_object.year = res.year
                                                                list_button_object.item = res.item
                                                                list_button_object.type = res.type
                                                                list_button_object.type_list = res.type_list
                                                                list_button_object.unity = res.unity
                                                                list_button_object.cerate_div_button()
                                                                list_button_object.data = res.content_list
                                                                list_button_object.localitem = 0
                                                                tinymce.get('content').setContent(list_button_object.data[0]);


                                                            }
                                                        })

                                                    })

                                                </script>
                                            </div>

                                        </div>

                                    </div>
                                    <!-- 删除 -->
                                    <div class="modal fade" id="modal-container-000003" role="dialog"
                                        aria-labelledby="myModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal"
                                                        aria-hidden="true"></button>
                                                    <h4 class="modal-title" id="myModalLabel">
                                                        删除材料
                                                    </h4>
                                                </div>
                                                <div class="modal-body" style="height: 600px;">

                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-default"
                                                        data-dismiss="modal">关闭
                                                    </button>
                                                    <button type="button" class="btn btn-primary">保存
                                                    </button>
                                                </div>
                                            </div>

                                        </div>

                                    </div>
                                    <!-- 配置 -->
                                    <div class="modal fade" id="modal-container-000004" role="dialog"
                                        aria-labelledby="myModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal"
                                                        aria-hidden="true"></button>
                                                    <h4 class="modal-title" id="myModalLabel">
                                                        标题
                                                    </h4>
                                                </div>
                                                <div class="modal-body" style="height: 600px;">
                                                    <input type="button" value="模块自定义" style="width:100%;height:10%">
                                                    <input type="button" value="文档种类" style="width:100%;height:10%">
                                                    <input type="button" value="参考网页" style="width:100%;height:10%">
                                                    <input type="button" value="密码账号" style="width:100%;height:10%">
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-default"
                                                        data-dismiss="modal">关闭
                                                    </button>
                                                    <button type="button" class="btn btn-primary">保存
                                                    </button>
                                                </div>
                                            </div>

                                        </div>

                                    </div>
                                    <!-- 文件头 -->
                                </div>
                                <div style="display:inline-flex;width: 100%; height: 96%">
                                    <textarea id="content" style="width:100%;height: 100%;">
                                    </textarea>
                                </div>
                                <div style="display: inline-flex;width:100%;height: 5%;background-color: rgb(247, 248, 248);">
                                    <div style="width:85%;height: 100%">
                                        <div
                                            style="display: inline-flex;width:43%;height: 70%;border: 2px solid black;padding-top: 7px;border-radius:15px;padding-left:5px;margin-top:3px;">
                                            <h4 id="doc_unity"
                                                style="display:block;width:40%;font-size: 15px;font-weight:900;font-family:'宋体';;">
                                                台州市气象局</h4>
                                            <h4 id="doc_info"
                                                style="display:block;width:60%;font-size: 15px;font-weight:900;font-family:'宋体';;">
                                                第47期:一周天气</h4>

                                        </div>
                                        <!-- <h4 id="doc_unity" style="float:left;width:15%;padding-top:10px;font-size: 15px;font-weight:900;font-family:'宋体';;">
                                            台州市气象局</h4>
                                        <h4 id="doc_info" style="float:left;width:20%;padding-top:10px;font-size: 15px;font-weight:900;font-family:'宋体';;">
                                            第47期:一周天气</h4>
                                         -->
                                        <div id="button_type_list" class="layui-btn-group"
                                            style="display: inline-flex;width:55%;height:80%">
                                        </div>
                                    </div>
                                    <!-- <button type="button" class="layui-btn layui-btn-normal">按钮</button> -->
                                    <!-- <button id="convert3"
                                        style="width:40px;height:40px;background-image: url(static/src/合并.png);background-size: 100%;background-repeat: no-repeat;"></button> -->
                                    <!-- <div style="width:2%;height: 100%;"></div> -->
                                    <button id="preview_save" type="button"
                                        class="layui-btn  layui-btn-sm layui-btn-radius layui-btn-normal"
                                        style="margin-top:5px">保存当前</button>
                                    <!-- <button id="preview_save"
                                        style="width:40px;height:40px;background-image: url(static/src/保存.png);background-size: 100%;background-repeat: no-repeat;"></button> -->
                                    <!-- <div style="width:2%;height: 100%;"></div> -->
                                    <button id="save_doc_all" type="button"
                                        class="layui-btn  layui-btn-sm layui-btn-radius layui-btn-normal"
                                        style="margin-top:5px">保存所有</button>
                                    <!-- <button id="save_doc_all"
                                        style="width:40px;height:40px;background-image: url(static/src/发布.png);background-size: 100%;background-repeat: no-repeat;"></button> -->
                                    <!-- <div style="width:2%;height: 100%;"></div> -->
                                    <button id="convert" type="button"
                                        class="layui-btn  layui-btn-sm layui-btn-radius layui-btn-normal"
                                        style="margin-top:5px;margin-right:15px;">预览</button>
                                    <!-- <button id="convert"
                                        style="width:40px;height:40px;background-image: url(static/src/预览.png);background-size: 100%;background-repeat: no-repeat;"></button> -->
                                </div>

                                <script>
                                    tinymce.init({
                                        selector: '#content',
                                        language: 'zh_CN',
                                        branding: false,
                                        skin: 'oxide-dark',
                                        promotion: false,
                                        plugin_plothtml_width: "300%",
                                        menubar: false,
                                        plugins: "newfile openfile advlist anchor autolink autosave charmap code codesample emoticons footer fullscreen help image importcss indent2em insertdatetime link lists media nonbreaking pagebreak shortmet longmet advicemet preview quickbars save searchreplace table template visualblocks wordcount lineheight",
                                        toolbar: [
                                            "newfile openfile urldialog",
                                            "insertfile undo redo bold italic underline hr |alignleft aligncenter alignright formatselect fontselect fontsizeselect styleselect removeformat subscript superscript charmap searchreplace insertdatetime forecolor backcolor fontsize fontfamily",//段落
                                            "image code link unlink rotateleft rotateright flipv fliph editimage imageoptions quickimage | table | bullist numlist lineheight| | footer shortmet longmet advicemet"
                                        ],
                                        font_family_formats: "宋体='宋体';仿宋='仿宋';微软雅黑='微软雅黑';楷体='楷体';;隶书='隶书';幼圆='幼圆';Andale Mono=andale mono,times;Arial=arial,helvetica,sans-serif;Arial Black=arial black,avant garde;Book Antiqua=book antiqua,palatino;Comic Sans MS=comic sans ms,sans-serif;Courier New=courier new,courier;Georgia=georgia,palatino;Helvetica=helvetica;Impact=impact,chicago;Symbol=symbol;Tahoma=tahoma,arial,helvetica,sans-serif;Terminal=terminal,monaco;Times New Roman=times new roman,times;Trebuchet MS=trebuchet ms,geneva;Verdana=verdana,geneva;Webdings=webdings;Wingdings=wingdings",
                                        font_size_formats: '12px 14px 16px 18px 20px 24px 26px 28px 30px 32px 34px 36px 38px',
                                        style_formats: [
                                            {
                                                title: "行高",
                                                items: [
                                                    { title: "1", block: "p", styles: { "line-height": "1.0" } },

                                                    { title: "1.5", block: "p", styles: { "line-height": "1.5" } },

                                                    { title: "1.75", block: "p", styles: { "line-height": "1.75" } },

                                                    { title: "2", block: "p", styles: { "line-height": "2" } },

                                                    { title: "3", block: "p", styles: { "line-height": "3" } },

                                                    { title: "4", block: "p", styles: { "line-height": "4" } },

                                                    { title: "5", block: "p", styles: { "line-height": "5" } },
                                                ],
                                            },
                                        ],
                                        setup: (editor) => {
                                            editor.ui.registry.addButton('urldialog', {
                                                // icon: 'code',
                                                text: '快速画图',
                                                onAction: () => editor.windowManager.openUrl({
                                                    title: '画图页面',
                                                    url: 'http://127.0.0.1:9991/canvas_plot',
                                                    height: 820,
                                                    width: 1300,
                                                })
                                            })
                                        },


                                    });

                                    // tinymce接收数据
                                    window.addEventListener('message', function (event) {
                                        var data = event.data;
                                        // console.log('message received from TinyMCE', data);
                                    });

                                    //仅预览内容
                                    document.getElementById('convert').addEventListener('click', function () {
                                        //获取html的内容
                                        if (list_button_object.data.length > 0) {
                                            var contentDocument = ""
                                            for (var i = 0; i < list_button_object.data.length; i++) {
                                                if (i == list_button_object.localitem) {
                                                    list_button_object.data[i] = tinymce.get('content').getContent()
                                                    contentDocument = contentDocument + list_button_object.data[i]
                                                } else {
                                                    contentDocument = contentDocument + list_button_object.data[i]
                                                }

                                                // contentDocument = contentDocument + list_button_object.data[i]
                                            }
                                        } else {
                                            var contentDocument = tinymce.get('content').getContent();
                                        }
                                        // 加载文件头
                                        var hearder = list_button_object.render_head_info()
                                        contentDocument = hearder + contentDocument
                                        //console.log(contentDocument)
                                        var formData = new FormData();
                                        formData.append("document", contentDocument);

                                        $.ajax({
                                            url: "file/pdf",  // 请求的地址
                                            type: "POST",  // 请求方式
                                            headers: { "Token": "Bearer " + localStorage.getItem("token") },// {#设置token#}
                                            data: formData,
                                            processData: false,
                                            contentType: false,
                                            enctype: "multipart/form-data",
                                            responseType: "arraybuffer",
                                            mimeType: "text/plain; charset=x-user-defined",
                                            success: function (data) {
                                                // console.log(data)
                                                var rawLength = data.length;
                                                var array = new Uint8Array(new ArrayBuffer(rawLength));
                                                for (i = 0; i < rawLength; i++) {
                                                    array[i] = data.charCodeAt(i) & 0xff;
                                                }

                                                var pdfBlob = new Blob([array], { type: "application/pdf;charset=utf-8" })
                                                var pdfFile = URL.createObjectURL(pdfBlob)
                                                const options_pdf = {
                                                    forcePDFJS: true,
                                                    pdfOpenParams: {
                                                        pagemode: "thumbs",
                                                        navpanes: 0,
                                                        toolbar: 0,
                                                        scrollbar: 0,
                                                        statusbar: 0,
                                                        view: "FitV"
                                                    }
                                                }


                                                PDFObject.embed(pdfFile, "#product_view", options_pdf);
                                            }

                                        })
                                    });

                                    // 全部保存
                                    document.getElementById('save_doc_all').addEventListener('click', function () {
                                        //保存所有内容
                                        if (list_button_object.type_list.length > 0) {
                                            var data_list = [];
                                            var contentDocument = "";
                                            for (var i = 0; i < list_button_object.type_list.length; i++) {
                                                if (i == list_button_object.localitem) {
                                                    list_button_object.data[i] = tinymce.get('content').getContent()
                                                    contentDocument = contentDocument + list_button_object.data[i]

                                                } else {
                                                    contentDocument = contentDocument + list_button_object.data[i]
                                                }
                                                data_list.push(list_button_object.data[i])

                                            }

                                            var data = {
                                                "document": list_button_object.render_head_info() + contentDocument,
                                                "document_type": list_button_object.type,
                                                "name": list_button_object.type_list,
                                                "year": list_button_object.year,
                                                "data": data_list,
                                                "item": list_button_object.item,
                                                "unity": list_button_object.unity
                                            }

                                            $.ajax({
                                                url: "file/preview_all",
                                                type: "POST",
                                                headers: { "Token": "Bearer " + localStorage.getItem("token") },
                                                data: JSON.stringify(data),
                                                contentType: "application/json",
                                                responseType: "arraybuffer",
                                                mimeType: "text/plain; charset=x-user-defined",
                                                success: function (data) {
                                                    let rawLength = data.length;
                                                    let array = new Uint8Array(new ArrayBuffer(rawLength));
                                                    for (let i = 0; i < rawLength; i++) {
                                                        array[i] = data.charCodeAt(i) & 0xff;
                                                    }
                                                    let pdfBlob = new Blob([array], { type: "application/pdf;charset=utf-8" })
                                                    let pdfFile = URL.createObjectURL(pdfBlob)
                                                    const options_pdf = {
                                                        forcePDFJS: true,
                                                        pdfOpenParams: {
                                                            pagemode: "thumbs",
                                                            navpanes: 0,
                                                            toolbar: 0,
                                                            scrollbar: 0,
                                                            statusbar: 0,
                                                            view: "FitV"
                                                        }
                                                    }
                                                    PDFObject.embed(pdfFile, "#product_view", options_pdf);
                                                }
                                            })

                                        }

                                    })
                                    //保存并预览单个模块的内容
                                    document.getElementById('preview_save').addEventListener('click', function () {
                                        //保存并预览单个模块的内容
                                        var contentDocument = tinymce.get('content').getContent();
                                        //收集上传的数据

                                        var item = list_button_object.localitem
                                        list_button_object.data[item] = contentDocument
                                        var types = list_button_object.type
                                        var name = list_button_object.type_list[item]
                                        var year = list_button_object.year
                                        var data = contentDocument
                                        var items = list_button_object.item
                                        var unity = list_button_object.unity
                                        var hearder = list_button_object.render_head_info()
                                        contentDocument = hearder + contentDocument
                                        var formData = new FormData();
                                        formData.append("document", contentDocument);
                                        formData.append("item", item);
                                        formData.append("types", types);
                                        formData.append("name", name);
                                        formData.append("year", year);
                                        formData.append("data", data);
                                        formData.append("items", items);
                                        formData.append("unity", unity);
                                        $.ajax({
                                            url: "file/preview_save",  // 请求的地址
                                            type: "POST",  // 请求方式
                                            headers: { "Token": "Bearer " + localStorage.getItem("token") },
                                            data: formData,
                                            processData: false,
                                            contentType: false,
                                            enctype: "multipart/form-data",
                                            responseType: "arraybuffer",
                                            mimeType: "text/plain; charset=x-user-defined",
                                            success: function (data) {
                                                var rawLength = data.length;
                                                var array = new Uint8Array(new ArrayBuffer(rawLength));
                                                for (i = 0; i < rawLength; i++) {
                                                    array[i] = data.charCodeAt(i) & 0xff;
                                                }

                                                var pdfBlob = new Blob([array], { type: "application/pdf;charset=utf-8" })
                                                var pdfFile = URL.createObjectURL(pdfBlob)
                                                const options_pdf = {
                                                    forcePDFJS: true,
                                                    pdfOpenParams: {
                                                        pagemode: "thumbs",
                                                        navpanes: 0,
                                                        toolbar: 0,
                                                        scrollbar: 0,
                                                        statusbar: 0,
                                                        view: "FitV"
                                                    }
                                                }

                                                PDFObject.embed(pdfFile, "#product_view", options_pdf);
                                            }

                                        })
                                    });

                                </script>

                            </div>

                        </div>
                        <div class="tab-pane scrollbar_self" id="panel-2" style="width:100%;height:100%;overflow-x: hidden;overflow-y:scroll;">
                            <div id="history_file" style="width:100%;height:45%;;padding: 15px;">
                                <div style="display:inline-block;width:100%;height:100%">
                                    <div id="history_button"
                                        style="display:inline-block;width:100%;height:10%;background-color:rgb(220, 222, 226);">

                                    </div>

                                    <div id="history_view" class="scrollbar_self"
                                        style="display:inline-block;width:100%;height:85%;background-color: white;overflow-x: hidden;overflow-y:scroll;">
                                        <div class="tool_history_button"
                                            style="display: inline-block;font-size: 20px;font-weight:900;font-family:'宋体';;height: 15%;width:100%;;vertical-align: middle;text-align:center;;padding:1px;;border-bottom: 1px solid black;padding-top:10px; ">
                                            <label
                                                style="width:10%;text-align:center;;vertical-align: middle">第1期</label>
                                            <label
                                                style="width:65%;text-align:center;vertical-align: middle;">一周天气预测</label>
                                            <label
                                                style="width:15%;text-align:center;vertical-align: middle;">翁之梅</label>
                                        </div>

                                        <div class="tool_history_button"
                                            style="display: inline-block;font-size: 20px;font-weight:900;font-family:'宋体';;height: 15%;width:100%;;vertical-align: middle;;text-align:center;padding:1px;;border-bottom: 1px solid black;padding-top:10px; ">
                                            <label
                                                style="width:10%;text-align:center;;vertical-align: middle;">第1期</label>
                                            <label
                                                style="width:65%;text-align:center;vertical-align: middle;">一周天气预测</label>
                                            <label
                                                style="width:15%;text-align:center;vertical-align: middle;">翁之梅</label>
                                        </div>

                                        <div class="tool_history_button"
                                            style="display: inline-block;font-size: 20px;font-weight:900;font-family:'宋体';;height: 15%;width:100%;;vertical-align: middle;;text-align:center;padding:1px;border-bottom: 1px solid black;padding-top:10px;">
                                            <label
                                                style="width:10%;text-align:center;;vertical-align: middle;">第1期</label>
                                            <label
                                                style="width:65%;text-align:center;vertical-align: middle;">一周天气预测</label>
                                            <label
                                                style="width:15%;text-align:center;vertical-align: middle;">翁之梅</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="padding: 15px;">
                                <div class="layui-row layui-col-space12">
                                    <div class="layui-col-md12">
                                        <div class="layui-card" style="height: 120px">
                                            <div class="layui-card-header" style="border-bottom: 1px solid rgb(220, 222, 226);"><h3 style="text-align:center;;padding-top: 5px;width:120px;font-size: 23px;font-weight:900;font-family:'宋体';color:blue">市台短期</h3></div>
                                            <div class="layui-card-body" style="padding-left: 150px;padding-top: 17px;">                                              
                                                <button type="button" data-method="product_date" value="T" id="T_short" class="layui-btn layui-btn-radius tool_prodict_product">短期气温</button>
                                                <button type="button" data-method="product_date" value="Pr01" id="Pr01_short" class="layui-btn layui-btn-radius tool_prodict_product">短期降水</button>
                                                <button type="button" data-method="product_date" value="Pr12" id="Pr24_short" class="layui-btn layui-btn-radius tool_prodict_product">降水</button>
                                                <button type="button" data-method="product_date" id="TMax24_short" value="TMax24"  class="layui-btn layui-btn-radius tool_prodict_product">高温</button>
                                                <button type="button" data-method="product_date" id="TMin24_short" value="TMin24"  class="layui-btn layui-btn-radius tool_prodict_product">低温</button>             
                                            </div>

                                        </div>
                                        <div class="layui-card" style="height: 120px">
                                            <div class="layui-card-header" style="border-bottom: 1px solid rgb(220, 222, 226);">
                                                <h3
                                                    style="text-align:center;;padding-top: 5px;width:120px;font-size: 23px;font-weight:900;font-family:'宋体';color:blue">
                                                    周报查询</h3>
                                            </div>
                                            <div class="layui-card-body" style="padding-left: 120px;padding-top: 12px;">                                                                                    
                                                <label class="layui-form-label" style="width: 100px;margin-right: 15px;">日期范围</label>                                             
                                                <div class="layui-inline" id="zdz_date_range" style="margin-right: 100px;">
                                                    <div class="layui-input-inline">
                                                        <input type="text" autocomplete="off" id="zdz-startDate-1" class="layui-input" placeholder="开始日期">
                                                    </div>
                                                    <div class="layui-form-mid">:</div>
                                                    -
                                                    <div class="layui-input-inline">
                                                        <input type="text" autocomplete="off" id="zdz-endDate-1" class="layui-input" placeholder="结束日期">
                                                    </div>
                                                    
                                                </div>
                                                <button id="tool_zdz_button" type="button" class="layui-btn layui-btn-radius" style="float: right;margin-right:45px">
                                                    <i class="layui-icon layui-icon-search"></i>
                                                </button>                                                                    
                                            </div>
                                        </div>

                                        <div class="layui-card" style="height: 120px">
                                            <div class="layui-card-header" style="border-bottom: 1px solid rgb(220, 222, 226);">
                                                <h3
                                                    style="text-align:center;;padding-top: 5px;width:120px;font-size: 23px;font-weight:900;font-family:'宋体';color:blue">
                                                    十天预测</h3>
                                            </div>
                                            <div class="layui-card-body" style="padding-left: 120px;padding-top: 12px;">                                                                                    
                                                <label class="layui-form-label" style="width: 100px;margin-right: 15px;">日期范围</label>                                             
                                                <div class="layui-inline" id="ec_date_range" style="margin-right: 100px;">
                                                    <div class="layui-input-inline">
                                                        <input type="text" autocomplete="off" id="ec-startDate-1" class="layui-input" placeholder="开始日期">
                                                    </div>
                                                    <div class="layui-form-mid">:</div>
                                                    -
                                                    <div class="layui-input-inline">
                                                        <input type="text" autocomplete="off" id="ec-endDate-1" class="layui-input" placeholder="结束日期">
                                                    </div>
                                                </div>
                                                <button id="tool_ec_button" type="button" class="layui-btn layui-btn-radius" style="float: right;margin-right:45px">
                                                    <i class="layui-icon layui-icon-search"></i>
                                                </button>                                                                   
                                            </div>
                                        </div>
                                        <div class="layui-card" style="height: 120px">
                                            <div class="layui-card-header" style="border-bottom: 1px solid rgb(220, 222, 226);">
                                                <h3
                                                    style="text-align:center;;padding-top: 5px;width:120px;font-size: 23px;font-weight:900;font-family:'宋体';color:blue">
                                                    降水订正</h3>
                                            </div>
                                            <div class="layui-card-body" style="padding-left: 120px;padding-top: 12px;">
                                                <label class="layui-form-label" style="width: 100px;margin-right: 15px;">市台降水</label> 
                                                <div class="layui-form-mid">:</div>
                                                <select id="select_self_plot" type="text"
                                                    style="width: 46%;height:35px; text-align:center;vertical-align: middle;align-items: center;margin-top:3px;margin-right: 100px;">
                                                </select>
                                                <button id="tool_selfplot_button" type="button" class="layui-btn layui-btn-radius" style="float: right;margin-right:45px">
                                                    <i class="layui-icon layui-icon-search"></i>
                                                </button> 
                                            </div>
                                        </div>
                                    </div>
                                
                                </div>
                                <script>
                                    // 周报日期 
                                    function getNextDate(date, day) {
                                            var dd = new Date(date);
                                            dd.setDate(dd.getDate() + day);
                                            var y = dd.getFullYear();
                                            var m = dd.getMonth() + 1 < 10 ? "0" + (dd.getMonth() + 1) : dd.getMonth() + 1;
                                            var d = dd.getDate() < 10 ? "0" + dd.getDate() : dd.getDate();
                                            return y + "-" + m + "-" + d;
                                        };                           
                                    layui.use('laydate', function () {
                                        var laydate = layui.laydate;
                                        //日期范围
                                        var today = new Date()
                                        var y = today.getFullYear();
                                        var m = today.getMonth() + 1 < 10 ? "0" + (today.getMonth() + 1) : today.getMonth() + 1;
                                        var d = today.getDate() < 10 ? "0" + today.getDate() : today.getDate();
                                        var h = today.getHours() < 10 ? "0" + today.getHours() + ":00:00" : today.getHours() + ":00:00";
                                        var today_str = y + "-" + m + "-" + d + " " + h;
                                        var seven_day = getNextDate(today_str, day=-7) 
                                        seven_day = seven_day + " " + h
                                        function date_to_str(date){
                                            var year = date.year 
                                            var month = date.month < 10 ? "0" +date.month.toString(): date.month.toString()
                                            var day = date.date < 10 ? "0" +date.date.toString(): date.date.toString()
                                            var hour = date.hours < 10 ? "0" +date.hours.toString()+ ":00:00": date.hours.toString()+ ":00:00"
                                            date_str = year + "-" + month + "-" + day + " " + hour;
                                            return date_str 
                                        }
                                        laydate.render({
                                            elem: '#zdz_date_range'
                                            //设置开始日期、日期日期的 input 选择器
                                            //数组格式为 2.6.6 开始新增，之前版本直接配置 true 或任意分割字符即可
                                            ,type:'datetime'
                                            ,theme: 'molv'
                                            ,max:today_str
                                            ,min:seven_day
                                            ,value: [seven_day,today_str]
                                            ,isInitValue: true
                                            ,done:function (value, date, endDate){                                                   
                                                zdz_recdata_obj.start_date = date_to_str(date)
                                                zdz_recdata_obj.end_date = date_to_str(endDate)
                                                // console.log(seven_day)
                                            }
                                            , range: ['#zdz-startDate-1', '#zdz-endDate-1']
                                        });
                                    })
                                    // 十天
                                    layui.use('laydate', function () {
                                        var laydate = layui.laydate;
                                        //日期范围
                                        
                                        var today = new Date()
                                        var y = today.getFullYear();
                                        var m = today.getMonth() + 1 < 10 ? "0" + (today.getMonth() + 1) : today.getMonth() + 1;
                                        var d = today.getDate() < 10 ? "0" + today.getDate() : today.getDate();
                                        var h = today.getHours() < 16 ? "20:00:00" : "08:00:00";
                                        var today_str = y + "-" + m + "-" + d + " " + h;
                                        var yestorday = getNextDate(today_str, day=-1) 
                                        var init_day =  today.getHours() < 16? yestorday + " 20:00:00": today_str ;
                                        var ten_day = getNextDate(init_day, day=10) 
                                        ten_day = today.getHours() < 16? ten_day + " 20:00:00":ten_day + " 08:00:00"
                                        function date_to_str(date){
                                            var year = date.year 
                                            var month = date.month < 10 ? "0" +date.month.toString(): date.month.toString()
                                            var day = date.date < 10 ? "0" +date.date.toString(): date.date.toString()
                                            var hour = date.hours < 10 ? "0" +date.hours.toString()+ ":00:00": date.hours.toString()+ ":00:00"
                                            date_str = year + "-" + month + "-" + day + " " + hour;
                                            return date_str 
                                        }
                                        function date_to_index(date) { 
                                            var hours_list = [
                                                0, 3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69, 72,
                                                78, 84, 90, 96, 102, 108, 114, 120, 126, 132, 138, 144, 150, 156, 162, 168, 174, 180, 186, 192, 198, 204, 210, 216, 222, 228, 234, 240
                                            ]
                                            var date_str = date_to_str(date)
                                            var date_dt = new Date(date_str)
                                            var init_dt = new Date(init_day)
                                            var totle_hour = parseInt(date_dt - init_dt) / 1000 / 60 /60;
                                            var del_hours = []
                                            for (var i = 0; i < hours_list.length; i++){
                                                var single = totle_hour - hours_list[i]
                                                if (single<0){
                                                    single = -single
                                                }
                                                del_hours.push(single)
                                            }
                                            var min_hour = del_hours.reduce((a,b) => a>b?b:a) 
                                            var index_min = del_hours.findIndex(x => x === min_hour)
                                            return index_min
                                        }
                                        laydate.render({
                                            elem: '#ec_date_range'
                                            //设置开始日期、日期日期的 input 选择器
                                            //数组格式为 2.6.6 开始新增，之前版本直接配置 true 或任意分割字符即可
                                            ,type:'datetime'
                                            ,theme: 'molv'
                                            ,max:ten_day
                                            ,min:init_day
                                            ,value: [init_day,ten_day]
                                            ,isInitValue: true
                                            ,done:function (value, startDate, endDate){  
                                                var start_item = date_to_index(startDate)
                                                var end_item = date_to_index(endDate)
                                                // 传数据就好了
                                                // console.log(seven_day)
                                            }
                                            , range: ['#ec-startDate-1', '#ec-endDate-1']
                                        });
                                    })
                                </script>
                            </div>                                        
                        </div>
                        <script>
                            $('#toolbox').click(function () {
                                // $('#history_file').html(" ")
                                // $("select_self_plot").html(" ")
                                var select_plot = document.getElementById("select_self_plot")
                                if (select_plot.children.length > 0) {
                                    for (var i = 0; i < select_plot.children.length; i++) {
                                        select_plot.children[i].remove()
                                    }
                                }
                                $('#history_button').html(" ")
                                $('#history_view').html(" ")
                                var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                                $.ajax({
                                    url: "history_file",  // 请求的地址
                                    type: "post",  // 请求方式
                                    timeout: 250, //设置延迟上限
                                    data: {
                                        'csrfmiddlewaretoken': csrf
                                    },
                                    dataType: "json",
                                    success: function (data) {
                                        var self_title = data.self_title
                                        var view_first = data.doc_list[0]
                                        for (i = 0; i < view_first['filelist'].length; i++) {
                                            var divcontenter = document.createElement('div')
                                            divcontenter.style = "display: inline-block;font-size: 20px;font-weight:900;font-family:'宋体';;height: 10%;width:98%;text-align:center;;padding-top:1px;border-radius:5px;margin:5px;background-color:rgb(0,150,136);"
                                            divcontenter.setAttribute("class", "tool_history_button")
                                            var labelitem = document.createElement('label')
                                            labelitem.style = "width:15%;text-align:center;;vertical-align: middle;color:white"
                                            labelitem.innerText = "第" + view_first['filelist'][i]['item'].toString() + "期"
                                            var labeltype = document.createElement('label')
                                            labeltype.style = "width:55%;text-align:center;;vertical-align: middle;color:white"
                                            labeltype.innerText = view_first['filelist'][i]['type'].toString()
                                            var labelwriter = document.createElement('label')
                                            labelwriter.style = "width:15%;text-align:center;;vertical-align: middle;color:white"
                                            labelwriter.innerText = view_first['filelist'][i]['year']
                                            divcontenter.append(labelitem, labeltype, labelwriter)
                                            $('#history_view').append(divcontenter)
                                        }
                                        var button_list = data.doc_list
                                        // 材料类型
                                        for (var i = 0; i < button_list.length; i++) {
                                            var button = document.createElement('button')
                                            button.style = "display:inline-flex;height:100%;width:15%;padding-top:3px;text-align:center;;background-color:rgb(45, 104, 221);border-top-left-radius: 5px;border-top-right-radius:5px;;font-size: 20px;font-weight:900;font-family:'宋体';color:white;border:none;margin-right:3px;"
                                            button.id = "history" + i.toString()
                                            button.innerText = button_list[i]['name']
                                            button.addEventListener("click", function (e) {
                                                $('#history_view').html(" ")
                                                var item = parseInt(e.path[0].id[7])

                                                for (i = 0; i < button_list[item]['filelist'].length; i++) {
                                                    var divcontenter = document.createElement('div')
                                                    divcontenter.style = "display: inline-block;font-size: 20px;font-weight:900;font-family:'宋体';;height: 10%;width:100%;text-align:center;padding-top:10px; "
                                                    divcontenter.setAttribute("class", "tool_history_button")
                                                    var labelitem = document.createElement('label')
                                                    labelitem.style = "width:15%;text-align:center;;vertical-align: middle;color:white"
                                                    labelitem.innerText = "第" + button_list[item]['filelist'][i]['item'].toString() + "期"
                                                    var labeltype = document.createElement('label')
                                                    labeltype.style = "width:55%;text-align:center;;vertical-align: middle"
                                                    labeltype.innerText = button_list[item]['filelist'][i]['type'].toString()
                                                    var labelwriter = document.createElement('label')
                                                    labelwriter.style = "width:15%;text-align:center;;vertical-align: middle"
                                                    labelwriter.innerText = button_list[item]['filelist'][i]['year']
                                                    divcontenter.append(labelitem, labeltype, labelwriter)
                                                    $('#history_view').append(divcontenter)
                                                }
                                                $('.tool_history_button').click(function () {
                                                    var type = "tool_history"
                                                    console.log(this.attr)
                                                    product_view_show(type)
                                                })
                                            })
                                            $('#history_button').append(button)
                                        }
                                        $('.tool_history_button').click(function () {
                                            var type = "tool_history"
                                            console.log("tool_history_button")
                                            product_view_show(type)
                                        })
                                        
                                        var select_self_plot = document.getElementById("select_self_plot")                               
                                        for (var i = 0; i < self_title.length; i++) {
                                            var option_plot = document.createElement("option")
                                            option_plot.innerText = self_title[i].document_type
                                            option_plot.value = self_title[i].id
                                            select_self_plot.append(option_plot)
                                        }
                                    }
                                })
                            })
                        </script>
                        <div class="tab-pane" id="panel-4"
                            style="width:100%;height:100%;background-color:rgb(8, 116, 167)">
                            <p>
                                帮助
                            </p>
                        </div>
                        <div class="tab-pane" id="panel-5"
                            style="width:100%;height:100%;background-color:rgb(220,222,226);overflow: auto ;">
                            <div id="website"
                                style="display:flex;flex-wrap: wrap;align-content:flex-start;width:100%;height:100%;justify-content: center;align-items: center;;border-right: 1px solid white;;">
                                <div id="webbutton"
                                    style="width:100%;height:5%;margin-bottom: 1px;;padding-top:3px;border-bottom: 1px solid white;">

                                </div>
                                <div id="webview" class="layui-row layui-col-space15"
                                    style="width:100%;height:94%;padding-top:10px;">

                                </div>
                            </div>
                        </div>
                        <script>
                            layui.config({
                                base: 'static/layui/' //假设这是你存放拓展模块的根目录
                            }).extend({ //设定模块别名
                                drawer: 'drawer/drawer'
                            });
                            //快捷网址
                            $('#awebsite').click(function () {
                                // $('#website').html(" ")
                                var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                                $.ajax({
                                    url: "website",  // 请求的地址
                                    type: "post",  // 请求方式
                                    timeout: 250, //设置延迟上限
                                    data: {
                                        'csrfmiddlewaretoken': csrf
                                    },
                                    dataType: "json",
                                    success: function (data) {
                                        $('#webbutton').html("")
                                        $('#webview').html("")
                                        for (i = 0; i < data.first.length; i++) {
                                            var imgsrc = "media/" + data.first[i]['src']
                                            var singleimg = document.createElement('button')
                                            singleimg.style = "display:inline-block;width:100%;height:100%;background-image: url(" + imgsrc + ");font-size: 25px;color:black;text-align:center;line-height: 180px; ;background-repeat: no-repeat;border:1px solid rgb(220, 222, 226)"
                                            singleimg.setAttribute("class", "drawerIframe")
                                            singleimg.value = data.first[i]['url']
                                            singleimg.innerText = data.first[i]['name']
                                            var continer = document.createElement('div')
                                            continer.setAttribute("class", "layui-col-md3")
                                            var inside = document.createElement('div')
                                            inside.setAttribute("class", "layui-panel")
                                            inside.style = "height:200px;"
                                            inside.append(singleimg)
                                            continer.append(inside)
                                            $('#webview').append(continer)
                                        }
                                        layui.use(['drawer', 'jquery', 'layer', 'element', 'form'], function () {
                                            var layer = layui.layer;
                                            var element = layui.element;
                                            var drawer = layui.drawer;
                                            var $ = layui.jquery;
                                            var form = layui.form;
                                            $('.drawerIframe').click(function () {
                                                // console.log("打印测试抽屉传值", this.value)
                                                drawer.open({
                                                    title: [this.innerText, 'font-size:16px;color:#2d8cf0'],
                                                    closeBtn: 1,
                                                    offset: "r",
                                                    area: "90%",
                                                    iframe: "home/?url=" + this.value
                                                })
                                            })
                                        })                                                                    
                                        var button_list = data.class_dir
                                        for (i = 0; i < button_list.length; i++) {
                                            var singlebutton = document.createElement('button')
                                            singlebutton.setAttribute("class", "layui-btn")
                                            singlebutton.style = "margin-left:5px";
                                            singlebutton.innerText = button_list[i]['name']
                                            singlebutton.id = "buttonweb" + i.toString()
                                            singlebutton.addEventListener("click", function (e) {
                                            $('#webview').html("")
                                            var item = this.id.substring(9, this.id.length) //this.id[9]//parseInt(e.path[0].id[9])
                                            var imglist = data.class_dir[item]["img_list"]
                                            for (i = 0; i < imglist.length; i++) {
                                                var imgsrc = "media/" + imglist[i]['src']
                                                var singleimg = document.createElement('button')
                                                singleimg.style = "display:inline-block;width:100%;height:100%;background-image: url(" + imgsrc + ");font-size: 25px;color:black;text-align:center;line-height: 180px; ;background-repeat: no-repeat;border:1px solid rgb(220, 222, 226)"
                                                singleimg.setAttribute("class", "drawerIframe")
                                                singleimg.value = data.first[i]['url']
                                                singleimg.innerText = data.first[i]['name']
                                                var continer = document.createElement('div')
                                                continer.setAttribute("class", "layui-col-md3")
                                                var inside = document.createElement('div')
                                                inside.setAttribute("class", "layui-panel")
                                                inside.style = "height:200px;"
                                                inside.append(singleimg)
                                                continer.append(inside)
                                                $('#webview').append(continer)
                                                }
                                            layui.use(['drawer', 'jquery', 'layer', 'element', 'form'], function () {
                                                var layer = layui.layer;
                                                var element = layui.element;
                                                var drawer = layui.drawer;
                                                var $ = layui.jquery;
                                                var form = layui.form;
                                                $('.drawerIframe').click(function () {
                                                    drawer.open({
                                                        title: [this.innerText, 'font-size:16px;color:#2d8cf0'],
                                                        closeBtn: 1,
                                                        offset: "r",
                                                        area: "90%",
                                                        iframe: "home/?url=" + this.value
                                                    })
                                                })
                                            })
                                            })
                                            $('#webbutton').append(singlebutton)                                            
                                        }
                                    }
                                })
                            })
                            
                        </script>

                    </div>


                </div>


            </div>


            <!-- 预览界面 -->
            <div style="width: 50%; height: 100%;overflow: hidden;">
                <!-- 产品图片 -->
                <div id="product_view" style="background-color:rgb(239, 243, 237); width: 100%; height: 100%;">
                    <!-- 文件头 -->
                    <div style="height:27%;width:100%;position: relative;background-color:white;">
                        <div
                            style="top:30%;height:10%;width:100%;position: absolute;text-align: center;font-size:50px ;font-family:'宋体';color:red">
                            一周天气预测(样板)
                        </div>
                        <div
                            style="top:60%;height:10%;width:100%;position: absolute;text-align: center;font-size:20px ;font-family:'宋体';">
                            第15期
                        </div>
                        <div
                            style="top:80%;;height:10%;width:100%;position: absolute;text-align: center;font-size:20px ;font-family:'宋体';">
                            台州市气象局
                        </div>
                        <div
                            style="top:80%;left:10% ;height:10%;width:100%;position: absolute;font-size:20px ;font-family:'宋体';">
                            2022年3月01日19时
                        </div>
                        <div
                            style="top:65%;left:80%;height:10%;width:100%;position: absolute;font-size:20px ;font-family:'宋体';">
                            撰稿人:翁之梅
                        </div>
                        <div
                            style="top:80%;left:80%;height:10%;width:100%;position: absolute;font-size:20px ;font-family:'宋体';">
                            签发人:高丽
                        </div>
                        <div style="top:95%;left:8%;height:1%;width:88%;;position: absolute;border: 2px solid red;">
                        </div>

                    </div>
                    <!-- 文件段落 -->

                    <div
                        style="display:flex; justify-content:center align-items:center;height:auto;width:100%;background-color:white;font-size:20px ;font-family:'宋体';color:black;">
                        <div style="width: 10%;"></div>
                        <div style="width:80%;">
                            <p
                                style=";width:100% ;line-height:50px;font-size:25px ;font-family:'宋体';color:black;text-align: center;font-weight:bold">
                                本周前期天气阴沉，周后期强冷空气影响转晴冷天气
                            </p>
                            <p style=";width:100%;font-size:20px ;font-family:'宋体';color:black;">
                                一、短期预报
                            </p>
                            <p style="text-indent:2em;width:100% ;line-height:50px;;font-size:20px">
                                本周前期天气阴沉，周后期强冷空气影响转晴冷天气，全市有严重冰冻。今天、明天阴有分散性小雨，最高气温12～14度；后天多云到阴，夜里～周四受强冷空气影响有明显降温、大风和弱雨雪过程。，全市有严重冰冻。今天、明天阴有分散性小雨，最高气温12～14度；后天多云到阴，夜里～周四受强冷空气影响有明显降温、大风和弱雨雪过程。
                                本周前期天气阴沉，周后期强冷空气影响转晴冷天气，全市有严重冰冻。今天、明天阴有分散性小雨，最高气温12～14度；后天多云到阴，夜里～周四受强冷空气影响有明显降温、大风和弱雨雪过程。，全市有严重冰冻。今天、明天阴有分散性小雨，最高气温12～14度；后天多云到阴，夜里～周四受强冷空气影响有明显降温、大风和弱雨雪过程。
                            </p>

                        </div>
                    </div>
                    <!-- 文档列表  -->
                    <div
                        style="display:flex; justify-content:center align-items:center;height:auto;width:100%;background-color:white;font-size:20px ;font-family:'宋体';color:black;line-height:50px;">
                        <div style="width: 10%;"></div>
                        <div style="width:80%;">
                            <p style=";width:100%;font-size:20px ;font-family:'宋体';color:black;;font-weight:bold">
                                台州市主城区具体天气预报如下：
                            </p>
                            <div
                                style="display:inline-block;text-indent:1.5em;width:100%;height: 40% ;line-height:50px;;font-size:20px;">
                                <p style="float:left;line-height:40px;">
                                    4日（周一）：阴，部分地区有时有小雨区有时
                                </p>
                                <p style="float:right;line-height:40px;">
                                    9～14度
                                </p>
                                <p style="float:left;line-height:40px;">
                                    4日（周一）：阴，部分地区有时有小雨区有时
                                </p>
                                <p style="float:right;line-height:40px;">
                                    9～14度
                                </p>
                                <p style="float:left;line-height:40px;">
                                    4日（周一）：阴，部分地区有时有小雨区有时
                                </p>
                                <p style="float:right;line-height:40px;">
                                    9～14度
                                </p>
                                <p style="float:left;line-height:40px;">
                                    4日（周一）：阴，部分地区有时有小雨区有时
                                </p>
                                <p style="float:right;line-height:40px;">
                                    9～14度
                                </p>

                            </div>


                        </div>
                    </div>
                    <!-- 文档图片  单图 -->
                    <!-- 文档结尾 -->
                </div>
                <!-- ec十天面板 -->
                <div id="product_zdz"
                    style="display:none;background-color:rgb(239, 243, 237); width: 100%; height: 100%;padding:50px;">
                    <div style="width: 100%;height:100%;">
                        <!-- 地图 -->
                        <div id="zdz_webgis"
                            style="width: 100%;height:53%;border: 1px solid rgb(75, 73, 73);margin-bottom:15px;border-radius:15px;">

                        </div>
                        <!-- 固定栏目 -->
                        <div
                            style="display: inline-flex;;width: 100%;height:46%;border: 1px solid rgb(75, 73, 73);;border-radius:15px;">
                            <!-- 时间线 -->
                            <div class="scrollbar_self"
                                style="width: 20%;height:93%;;border-radius:5px;margin:15px;overflow-x: hidden; overflow-y: scroll; padding-top:10px; padding-left:10px;background-color: white;">
                                <ul id="ul_time_zdz" class="layui-timeline">
                                    <li class="layui-timeline-item">
                                        <i class="layui-icon layui-timeline-axis"></i>
                                        <div class="layui-timeline-content layui-text">
                                            <h3 class="layui-timeline-title">概况</h3>
                                            <div class="layui-btn-group">
                                                <button type="button" value="wind_all"
                                                    class="layui-btn layui-btn-xs wind">风</button>
                                                <button type="button" value="rain_all"
                                                    class="layui-btn layui-btn-xs rain">雨</button>
                                                <button type="button" value="temp_all"
                                                    class="layui-btn layui-btn-xs temp">温</button>
                                                <button type="button" value="view_all"
                                                    class="layui-btn layui-btn-xs view">雾</button>
                                            </div>
                                        </div>
                                    </li>

                                </ul>
                            </div>
                            <!-- 卡片栏目 -->
                            <div style="width: 75%;height:93%;;margin:15px;margin-left: 0px;padding: 0px;">
                                <div class="layui-tab layui-tab-card"
                                    style="background-color: white;width:100%;height:100%;margin:0px;">
                                    <ul class="layui-tab-title" style="margin: 0px;">
                                        <li class="layui-this" style="margin: 0px;">文字统计</li>
                                        <li id = "datatable" data-method="confirmTrans" style="margin: 0px;">数据表</li>
                                        <li id="li_zdz_line_chart" style="margin: 0px;">单站曲线</li>
                                    </ul>
                                    <script>
                                        layui.use('layer', function () { //独立版的layer无需执行这一句
                                            var $ = layui.jquery, layer = layui.layer; //独立版的layer无需执行这一句

                                            //触发事件
                                            var active = {
                                                confirmTrans: function () {
                                                    //配置一个透明的询问框
                                                    layer.msg('请选择数据类型', {
                                                        time: 20000, //20s后自动关闭
                                                        btn: ['大风', '降水', '气温', '能见度'],
                                                        btn1:function (index, layero){
                                                            var type = "wind"
                                                            zdz_recdata_obj.randar_single_table(type)
                                                            layer.closeAll();
                                                        },
                                                        btn2:function (index, layero){
                                                            var type = "rain"
                                                            zdz_recdata_obj.randar_single_table(type)
                                                        },
                                                        btn3:function (index, layero){
                                                            var type = "temp"
                                                            zdz_recdata_obj.randar_single_table(type)
                                                        },
                                                        btn4:function (index, layero){
                                                            var type = "view"
                                                            zdz_recdata_obj.randar_single_table(type)
                                                        },
                                                    });
                                                },
                                                
                                            };

                                            $('#datatable').on('click', function () {
                                                var othis = $(this), method = othis.data('method');
                                                active[method] ? active[method].call(this, othis) : '';
                                            });
                                        });

                                    </script>
                                    <div class="layui-tab-content" style="padding:0px">
                                        <div class="layui-tab-item layui-show">
                                            <div class="layui-bg-gray" style="padding: 20px;">
                                                <div class="layui-row layui-col-space15">
                                                    <div class="layui-col-md12">
                                                        <div class="layui-card">
                                                            <!-- <div class="layui-card-header">实况统计:</div> -->
                                                            <div id="zdz_text_info" class="layui-card-body scrollbar_self"
                                                                style="height:250px;overflow-x: hidden;overflow-y: scroll;">
                                                                【风雨情通报】:2022-01-25 20:00到2022-02-10
                                                                06:00各县市面雨量分别为:仙居县78.82毫米;天台县75.02毫米;三门县68.45毫米;临海市62.95毫米;黄岩区62.64毫米;温岭市47.34毫米;路桥区46.94毫米;椒江区40.8毫米;玉环市38.36毫米;玉环县23.84毫米;单站前五：K8914：127.4毫米,K8785：120.2毫米,K8709：115.0毫米,K8774：114.5毫米,K8924：110.0毫米.乡镇前五：浦坝港镇：814.1毫米,街头镇：808.2毫米,横溪镇：661.7毫米,健跳镇：631.2毫米,白水洋镇：619.9毫米.其中:大于250毫米有338站,大于100毫米有15站,大于50毫米有346站,大于25毫米有434站,大于10毫米有435站,大于5毫米有435站,大于1毫米有435站,沿海出现8~16级大风.风力较大的有：K8629：23.9米/秒,K8546：21.0米/秒,K8627：21.0米/秒,K8304：20.9米/秒,K8407：20.8米/秒.沿海出现小于200米的强浓雾。主城区最高温度：129度。主城区最低温度：28度。其中全市小于-3度的有18站。小于0度的有16站。小于3度的有146站。

                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-tab-item">
                                            <table class="layui-hide" id="zdz_table"></table>
                                        </div>
                                        <div id="continer_zdz_line_chart" class="layui-tab-item"
                                            style="padding: 0px;height: 310px;">

                                        </div>
                                    </div>
                                </div>


                            </div>

                        </div>
                    </div>

                </div>

                <!-- 预览界面数据交互的核心代码 -->
                <script type="text/javascript" src='static/js/save_and_vue.js'></script>
                <script src='static/js/taizhou_village.js'></script>
                
                <script>
                    // 等待加载时间
                    function showLoad() {
                        return layer.msg('程序加载....', { icon: 16, shade: [0.5, '#f5f5f5'], scrollbar: false, offset: 'auto', time: 100000 });
                    }
                    // 关闭等待加载时间
                    function closeLoad(index) {
                        layer.close(index);
                    }


                    const map_toolbox_object = {
                        label_map:function(isobands_options, map,plot_type){
                            if (plot_type=="rain"){
                                var colorinitlat = 28.4
                                var colorinitlon = 120.5
                                var labellist = ["0","0.1","10","25","50","100","250"]
                                var coloritem = isobands_options.breaksProperties.length
                                var colorwidth = 0.1
                                var colorheight = 0.4 / coloritem                            
                                for (var i = 0; i < isobands_options.breaksProperties.length; i++) {
                                    var textIcon = L.divIcon({
                                        html: labellist[i],
                                        className: 'label_plot_rain'
                                    });
                                    var colorlat = colorinitlat - i * colorheight
                                    var colorlon = colorinitlon
                                    var latlngs = [[colorlat, colorlon], [colorlat, colorlon + colorwidth], [colorlat - colorheight, colorlon + colorwidth], [colorlat - colorheight, colorlon]]
                                    var colorstr = isobands_options.breaksProperties[i].fill
                                    var polygon = L.polygon(latlngs, {
                                        color: "black",
                                        fillColor: colorstr,
                                        fillOpacity: 0.8,
                                        weight: 1
                                    }).addTo(map)
                                    L.marker([colorlat - colorheight / 3, colorlon + colorwidth + 0.05], { icon: textIcon }).addTo(map);
                                }

                            }
                            else if (plot_type=="temp"){
                                var labellist = ["-10","-8","-6","-4","-2","0","2","4","6","8","10"
                                    ,"12","14","16","18","20","22","24","26","28","30","32","34","35","37","40","41"
                                ]
                                var colorinitlat = 28.4
                                var colorinitlon = 120.1
                                var coloritem = isobands_options.breaksProperties.length
                                var colorwidth = 0.1
                                var colorheight = 0.8 / coloritem                            
                                for (var i = 0; i < isobands_options.breaksProperties.length; i++) {
                                    var textIcon = L.divIcon({
                                        html: labellist[i],
                                        className: 'label_plot_temp'
                                    });
                                    var colorlat = colorinitlat - i * colorheight
                                    var colorlon = colorinitlon
                                    var latlngs = [[colorlat, colorlon], [colorlat, colorlon + colorwidth], [colorlat - colorheight, colorlon + colorwidth], [colorlat - colorheight, colorlon]]
                                    var colorstr = isobands_options.breaksProperties[i].fill
                                    var polygon = L.polygon(latlngs, {
                                        color: "black",
                                        fillColor: colorstr,
                                        fillOpacity: 0.8,
                                        weight: 1
                                    }).addTo(map)
                                    L.marker([colorlat - colorheight / 3, colorlon + colorwidth + 0.05], { icon: textIcon }).addTo(map);
                                }


                            }

                        },
                        color_level:function (plot_type) {
                            // 降水
                            var rain_options = {
                                zProperty: "value",
                                commonProperties: {
                                    "fill-opacity": 1
                                },
                                breaksProperties: [
                                    { fill: "rgb(255,255,255)" },// 0 mm
                                    { fill: "rgb(140,246,130)" },// 0.1
                                    { fill: "rgb(0,191,27)" },// 10
                                    { fill: "rgb(62,185,255)" },// 25
                                    { fill: "rgb(25,0,235)" },// 50
                                    { fill: "rgb(255,0,255)" },// 100
                                    { fill: "rgb(140,0,65)" } //250
                                ]
                            };
                            // 气温
                            var temp_options = {
                                zProperty: "value",
                                commonProperties: {
                                    "fill-opacity": 1
                                },
                                breaksProperties: [
                                    { fill: "rgb(141,172,216)" },// -10
                                    { fill: "rgb(147,178,205)" },// -8
                                    { fill: "rgb(144,187,206)" },// -6
                                    { fill: "rgb(147,194,199)" },// -4
                                    { fill: "rgb(150,209,187)" },// -2
                                    { fill: "rgb(199,199,141)" },// 0
                                    { fill: "rgb(208,206,132)" }, // 2 
                                    { fill: "rgb(207,207,132)" },// 4
                                    { fill: "rgb(214,205,117)" },// 6
                                    { fill: "rgb(215,195,108)" },// 8 
                                    { fill: "rgb(210,177,80)" },// 10 
                                    { fill: "rgb(203,155,58)" },// 12
                                    { fill: "rgb(206,139,45)" },// 14
                                    { fill: "rgb(206,139,45)" }, // 16
                                    { fill: "rgb(211,116,59)" },//  18
                                    { fill: "rgb(197,99,49)" },// 20
                                    { fill: "rgb(205,89,61)" },// 22
                                    { fill: "rgb(205,63,53)" },// 24
                                    { fill: "rgb(190,70,50)" },// 26
                                    { fill: "rgb(204,62,59)" },// 28
                                    { fill: "rgb(170,54,54)" }, // 30
                                    { fill: "rgb(165,41,51)" },// 32
                                    { fill: "rgb(158,37,50)" },// 34
                                    { fill: "rgb(153,35,54)" },// 35
                                    { fill: "rgb(122,36,65)" },// 37
                                    { fill: "rgb(93,38,67)" },// 40
                                    { fill: "rgb(63,38,67)" }                           
                                ]
                            };
                            // 能见度
                            var view_options = {
                                zProperty: "value",
                                commonProperties: {
                                    "fill-opacity": 0.9
                                },
                                breaksProperties: [
                                    { fill: "rgb(58,88,148)" },// 50
                                    { fill: "rgb(75,111,159)" },// 200
                                    { fill: "rgb(104,135,161)" },// 500
                                    { fill: "rgb(145,161,174)" },// 1000
                                    { fill: "rgb(147,186,149)" }// 2000
                                ]
                            };
                            
                            // 风力
                            var wind_options = {
                                zProperty: "value",
                                commonProperties: {
                                    "fill-opacity": 0.9
                                },
                                breaksProperties: [
                                    { fill: "rgb(219,212,204)" },// 0 
                                    { fill: "rgb(193,192,198)" },// 0.3
                                    { fill: "rgb(167,210,203)" },// 1.6
                                    { fill: "rgb(219,220,162)" },// 3.4 
                                    { fill: "rgb(223,193,155)" },// 5.5
                                    { fill: "rgb(217,158,115)" },// 8 
                                    { fill: "rgb(226,106,78)" },// 10.8
                                    { fill: "rgb(217,64,64)" },// 13.9
                                    { fill: "rgb(190,47,574)" }// 17.2
                                ]
                            };
                            if(plot_type=="rain"){
                                return {
                                    levelV:[0, 0.1, 10, 25, 50, 100, 250],
                                    isobands_options:rain_options
                                }
                            }
                            else if (plot_type=="temp"){
                                return {
                                    levelV:[-10,-8, -6, -4, -2, 0, 2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,35,37,40],
                                    isobands_options:temp_options
                                }
                            }
                            else if (plot_type=="wind"){
                                return {
                                    levelV:[0, 0.3, 1.6, 3.4, 5.5, 8, 10.8,13.9,17.2],
                                    isobands_options:wind_options
                                }
                            }
                            else if (plot_type=="view"){
                                return {
                                    levelV:[50, 200, 500, 1000, 2000],
                                    isobands_options:view_options
                                }
                            }

                        },
                        getMaxAttribute: function (inLevelV, inGrid, inBreaksProperties) {
                            //定义变量
                            let levelArray = [];
                            let levelLength = inLevelV.length;
                            inLevelV.forEach(function (item, index) {
                                if (index < levelLength - 2) levelArray.push(0);
                            });
                            //统计每个等级中网格点数量
                            inGrid.features.map((i) => {
                                inLevelV.forEach(function (item, index) {
                                    if (index < levelLength - 3) {
                                        if (i.properties.value >= inLevelV[index] && i.properties.value < inLevelV[index + 1]) levelArray[index]++;
                                    }
                                    if (index == levelLength - 2) {
                                        if (i.properties.value >= inLevelV[index]) levelArray[index]++;
                                    }
                                });
                            });
                            //取等级中网格点最多的值
                            let maxIndex = -1;
                            let maxV = 0;
                            levelArray.forEach(function (item, index) {
                                if (maxV < item) { maxV = item; maxIndex = index; }
                            });
                            let value = '';
                            let fill = '';
                            if (maxIndex != -1) {
                                value = inLevelV[maxIndex] + '-' + inLevelV[maxIndex + 1];
                                fill = inBreaksProperties[maxIndex].fill;
                            }
                            return [value, fill]
                        },
                        return_shp: function (boundaries, data,plot_type) {
                            // data 为poin需要用turf的featureCollection(data)加载
                            var points = turf.featureCollection(data);
                            var interpolate_options = {
                                gridType: "points",
                                property: "value",
                                units: "degrees",
                                weight: 10
                            };
                            var isobands_options = map_toolbox_object.color_level(plot_type).isobands_options 
                            var levelV = map_toolbox_object.color_level(plot_type).levelV;         
                            // var isobands_options = {
                            //     zProperty: "value",
                            //     commonProperties: {
                            //         "fill-opacity": 0.9
                            //     },
                            //     breaksProperties: [
                            //         { fill: "rgb(255,255,255)" },
                            //         { fill: "rgb(140,246,130)" },
                            //         { fill: "rgb(0,191,27)" },
                            //         { fill: "rgb(62,185,255)" },
                            //         { fill: "rgb(25,0,235)" },
                            //         { fill: "rgb(255,0,255)" },
                            //         { fill: "rgb(140,0,65)" }
                            //     ]
                            // };
                            var grid = turf.interpolate(points, 0.05, interpolate_options);
                            
                            // var levelV = [0, 1, 18, 19, 20, 21, 100];
                            var isobands = turf.isobands(
                                grid,
                                levelV,
                                isobands_options
                            );
                            var isobandsLay = L.geoJSON(isobands, {
                                style: function (feature) {
                                    return {
                                        color: '#4264fb',
                                        fillColor: feature.properties.fill,
                                        weight: 0.1,
                                        fillOpacity: 0.8
                                    };
                                }
                            });
                            var features = [];//裁剪后的结果集
                            isobands.features.forEach(function (feature1) {
                                boundaries.features.forEach(function (feature2) {
                                    var intersection = null;
                                    try {
                                        intersection = turf.intersect(feature1, feature2);
                                    } catch (e) {
                                        try {
                                            //色斑图绘制之后，可能会生成一些非法 Polygon ，例如 在 hole 里存在一些形状（听不懂？去查一下 GeoJSON 的规范），
                                            //我遇到的一个意外情况大概是这样，这种 Polygon 在做 intersect() 操作的时候会报错，所以在代码中做了个容错操作。
                                            //解决的方法通常就是做一次 turf.buffer() 操作，这样可以把一些小的碎片 Polygon 清理掉。
                                            feature1 = turf.buffer(feature1, 0);
                                            intersection = turf.intersect(feature1, feature2);
                                        } catch (e) {
                                            intersection = feature1;//实在裁剪不了就不裁剪了,根据业务需求自行决定
                                        }
                                    }
                                    if (intersection != null) {
                                        intersection.properties = feature1.properties;
                                        intersection.id = (Math.random() * 100000).toFixed(0);
                                        features.push(intersection);
                                    }
                                });
                            });
                            //turf.isobands有点不符合业务预期,只有一个等级时,结果集可能为空,无图形显示,写点程序(找出那一个等级，并添加进结果集)补救下
                            if (features.length == 0) {
                                var maxAttribute = map_toolbox_object.getMaxAttribute(levelV, grid, isobands_options.breaksProperties);
                                var value = maxAttribute[0];
                                var fill = maxAttribute[1];
                                if (value != '' && fill != '') {
                                    //获取网格点Box
                                    var gridBox = turf.bbox(grid);
                                    //生成网格点范围的面
                                    var gridBoxPolygon = [[[gridBox[0], gridBox[1]], [gridBox[0], gridBox[3]], [gridBox[2], gridBox[3]], [gridBox[2], gridBox[1]], [gridBox[0], gridBox[1]]]];
                                    //获取网格范围的面与行政边界的交集 Polygon
                                    var intersectPolygon = null;
                                    var gridoxFeature = {
                                        "type": "Feature",
                                        "properties": { "fill-opacity": 0.8 },
                                        "geometry": { "type": "Polygon", "coordinates": gridBoxPolygon },
                                        "id": 10
                                    };
                                    try {
                                        intersectPolygon = turf.intersect(gridoxFeature, boundaries.features[0]);
                                    } catch (e) {
                                        try {
                                            //色斑图绘制之后，可能会生成一些非法 Polygon ，例如 在 hole 里存在一些形状（听不懂？去查一下 GeoJSON 的规范），
                                            //我遇到的一个意外情况大概是这样，这种 Polygon 在做 intersect() 操作的时候会报错，所以在代码中做了个容错操作。
                                            //解决的方法通常就是做一次 turf.buffer() 操作，这样可以把一些小的碎片 Polygon 清理掉。
                                            gridoxFeature = turf.buffer(gridoxFeature, 0);
                                            intersectPolygon = turf.intersect(gridoxFeature, boundaries.features[0]);
                                        } catch (e) {
                                            intersectPolygon = gridoxFeature;//实在裁剪不了就不裁剪了,根据业务需求自行决定
                                        }
                                    }
                                    //结果添加到结果数组
                                    if (intersectPolygon != null) {
                                        features.push({
                                            "type": "Feature",
                                            "properties": { "fill-opacity": 0.8, "fill": fill, "value": value },
                                            "geometry": intersectPolygon.geometry,
                                            "id": 0
                                        });
                                    }
                                }
                            }
                            var intersection = turf.featureCollection(features);
                            var intersectionLay = L.geoJSON(intersection, {
                                style: function (feature) {
                                    return {
                                        color: 'black',
                                        fillColor: feature.properties.fill,
                                        weight: 0.1,
                                        zIndex: 800,
                                        fillOpacity: 0.7
                                    };
                                }
                            })
                            return {
                                intersectionLay: intersectionLay
                            }
                        },
                        return_boundaries: function (shpdata) {
                            var bounddata = {
                                type: "FeatureCollection",
                                name: "boundaries",
                                crs: { type: "name", properties: { name: "urn:ogc:def:crs:OGC:1.3:CRS84" } },
                                features: shpdata
                            }
                            return {
                                boundaries: bounddata
                            }
                        },
                        return_colormap: function (isobands_options, map) {
                            var coloritem = isobands_options.breaksProperties.length
                            var colorinitlat = 28.4
                            var colorinitlon = 120.5
                            var colorwidth = 0.1
                            var colorheight = 0.4 / coloritem
                            var labellist = ['0~0.1', '0.1~1', '1~10', '10~25', '25~50', '50~100', '100']
                            for (var i = 0; i < isobands_options.breaksProperties.length; i++) {
                                var textIcon = L.divIcon({
                                    html: labellist[i],
                                    className: 'label_plot_rain'
                                });
                                var colorlat = colorinitlat - i * colorheight
                                var colorlon = colorinitlon
                                var latlngs = [[colorlat, colorlon], [colorlat, colorlon + colorwidth], [colorlat - colorheight, colorlon + colorwidth], [colorlat - colorheight, colorlon]]
                                var colorstr = isobands_options.breaksProperties[i].fill
                                var polygon = L.polygon(latlngs, {
                                    color: "black",
                                    fillColor: colorstr,
                                    fillOpacity: 0.8,
                                    weight: 1
                                }).addTo(map)
                                L.marker([colorlat - colorheight / 3, colorlon + colorwidth + 0.05], { icon: textIcon }).addTo(map);
                            }
                            var data = ""
                            return {
                                data: data
                            }
                        }
                    }



                    // id为product_view的数据交互渲染函数
                    function product_view_show(type) {
                        if (type == "plot_self") {
                            console.log("---------------绘图--------------------------")
                            $('#product_view').html(" ")
                            var self_plot_div = document.createElement('div')
                            self_plot_div.style = "width:100%;height:70%;"
                            self_plot_div.id = "self_plot_div"
                            $('#product_view').append(self_plot_div)

                            var analyze_div = document.createElement('div')
                            analyze_div.style = "display:inline-flex;width:100%;height:30%;overflow:auto"
                            canvas_bar = document.createElement('div')
                            canvas_bar.style = "width:60%;height:100%;overflow:auto"
                            canvas_bar.id = "canvas_bar"
                            analyze_div.append(canvas_bar)
                            // 表格数据
                            var table_div = document.createElement('div');
                            table_div.style = "width:40%;height:100%;overflow:auto"
                            var table = document.createElement('table');
                            table.setAttribute("class", "table table-bordered")

                            var caption = document.createElement('caption')
                            caption.innerText = "乡镇排行"
                            table_div.append(table)
                            table.append(caption)
                            table.innerHTML = "<thead><tr><th>排名</th><th>名称</th><th>降水</th></tr></thead><tbody>\
                                                                                                                                <tr><td>1</td><td>坎门</td><td>30mm</td></tr>\
                                                                                                                                <tr><td>2</td><td>淡竹</td><td>15mm</td></tr>\
                                                                                                                                <tr><td>3</td><td>淡竹</td><td>15mm</td></tr>\
                                                                                                                                <tr><td>3</td><td>淡竹</td><td>15mm</td></tr>\
                                                                                                                                <tr><td>3</td><td>淡竹</td><td>15mm</td></tr>\
                                                                                                                                <tr><td>3</td><td>淡竹</td><td>15mm</td></tr>\
                                                                                                                                </tbody>"

                            analyze_div.append(table_div)
                            $('#product_view').append(analyze_div)
                            var chartDom = document.getElementById('canvas_bar');
                            var myChart_bar = echarts.init(chartDom);
                            var option;

                            option = {
                                tooltip: {
                                    trigger: 'axis',
                                    axisPointer: {
                                        type: 'cross'
                                    }
                                },
                                toolbox: {
                                    feature: {
                                        dataView: { show: true, readOnly: false },
                                        restore: { show: true },
                                        saveAsImage: { show: true }
                                    }
                                },
                                xAxis: {
                                    type: 'category',
                                    data: ['仙居', '玉环', '三门', '临海', '椒江', '临海', '黄岩']
                                },
                                yAxis: {
                                    type: 'value'
                                },
                                series: [
                                    {
                                        data: [120, 200, 150, 80, 70, 110, 130],
                                        type: 'bar'
                                    }
                                ]
                            };

                            option && myChart_bar.setOption(option);
                            // 添加表格数据
                            var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                            $.ajax({
                                url: "upload_selfplot_data",  // 请求的地址
                                type: "post",  // 请求方式
                                data: {
                                    "plot_self_data": JSON.stringify(data_canvas),
                                    'csrfmiddlewaretoken': csrf
                                },
                                dataType: "json",
                                success: function (data) {
                                    // 得到请求的数据
                                    var plotImg = new Image();
                                    plotImg.src = data.img
                                    plotImg.style = "width:100%;height:100%"
                                    // js构建前端模板
                                    var self_plot_div = document.getElementById('self_plot_div')
                                    self_plot_div.append(plotImg)

                                }


                            })


                        } else if (type == "product_show") {
                            console.log("-------------------------------自定义材料加载----------------------")
                            $('#product_view').html(" ")
                            var product_view = document.getElementById('product_view')
                            product_view.style = "width:97.5%;height:97%;background-color:white;margin:15px"
                            var list_data_all = [
                                {  //# 文件头
                                    "type": "一周天气",
                                    "company": "台州市气象台",
                                    "writer": "翁之梅",
                                    "putter": "高丽",
                                    "index": 15,
                                    "time": 'Wed Mar 01 2022 19:18:00 GMT+0800 (中国标准时间)'
                                },
                                {  //# 文档内容
                                    "type": "段落",
                                    "title": ["本周后期强冷空气影响，全市有严重冰冻", 1, 2, 3],
                                    "subtitle": ["短信内容", 1, 2, 3],
                                    "text": "本周前期天气阴沉，周后期强冷空气影响转晴冷天气，全市有严重冰冻。今天、明天阴有分散性小雨，最高气温12～14度；后天多云到阴，夜里～周四受强冷空气影响有明显降温、大风和弱雨雪过程，预计日平均气温过程降温幅度可达8～10度，后天夜里部分地区有小雨夹雪或雪，山区有小雪；周五～周日天气晴冷，其中周五、周六早晨北部地区降至零下6～零下8度，山区零下9～零下12度，其它地区零下4～零下6度，全市有严重冰冻，须注意防寒保暖。另外，周二沿海风力8～9级，周三夜里～周四沿海和内陆分别有8～10级和6～8级偏北大风。"
                                },
                                {  //# 文档列表
                                    "type": "列表",
                                    "title": ["台州市主城区具体天气预报如下：", 1, 2, 3],
                                    "subtitle": ["短信内容", 1, 2, 3],
                                    "text_list1": "4日（周一）：阴，部分地区有时有小雨              9～14度",
                                    "text_list2": "4日（周一）：阴，部分地区有时有小雨        9～14度",
                                    "text_list3": "4日（周一）：阴，部分地区有时有小雨        9～14度",
                                    "text_list4": "4日（周一）：阴，部分地区有时有小雨        9～14度",
                                    "text_list5": "4日（周一）：阴，部分地区有时有小雨        9～14度",
                                    "text_list6": "4日（周一）：阴，部分地区有时有小雨        9～14度",

                                },
                                {  //# 图片列表
                                    "type": "单图",
                                    "title": "台州市气象台",
                                    "png": 'src/pre_test.png'
                                },
                                {
                                    "type": "文件尾",
                                    "title1": "微信宣传",
                                    "png1": 'src/二维码.png',
                                    "title2": "气象台宣传",
                                    "png2": 'src/二维码.png',
                                    "title3": "浙政钉宣传",
                                    "png3": 'src/二维码.png',
                                    "service_name": '宋伟2、李渊、小王、张三',
                                    "service_unity": '气象台、玉环市气象局、水利局、气象台、玉环市气象局、水利局、气象台、玉环市气象局、水利局、玉环市气象局、水利局、气象台、玉环市气象局、水利局、玉环市气象局、水利局、气象台、玉环市气象局、水利局、玉环市气象局、水利局、气象台、玉环市气象局、水利局',
                                    "recive_unity": '气象台、玉环市气象局、水利局、玉环市气象局、水利局'
                                }

                            ]
                            $('#product_view').html(" ")
                            for (const i of list_data_all) {
                                if (i['type'] == '一周天气预测') {
                                    head_div(i)
                                } else if (i['type'] == '单图') {
                                    // console.log(i)
                                    png_div(i)
                                } else if (i['type'] == '列表') {
                                    // console.log(i)
                                    list_div(i)
                                } else if (i['type'] == '文件尾') {
                                    // console.log(i)
                                    foot_div(i)
                                } else if (i['type'] == '段落') {
                                    // console.log(i)
                                    text_div(i)
                                }

                            }
                        } else if (type == "tool_history") {
                            // console.log("历史数据的加载")
                            var contentDocument = tinymce.get('content').getContent();
                            // 加载文件头
                            var hearder = list_button_object.render_head_info()
                            contentDocument = hearder + contentDocument
                            var formData = new FormData();
                            formData.append("document", contentDocument);
                            var product_view = document.getElementById('product_view')
                            product_view.style = "width:97.5%;height:97%;background-color:white;margin:15px"
                            $.ajax({
                                url: "file/history_save",  // 请求的地址
                                type: "POST",  // 请求方式
                                headers: { "Token": "Bearer " + localStorage.getItem("token") },
                                data: formData,
                                processData: false,
                                contentType: false,
                                enctype: "multipart/form-data",
                                responseType: "arraybuffer",
                                mimeType: "text/plain; charset=x-user-defined",
                                success: function (data) {
                                    var rawLength = data.length;
                                    var array = new Uint8Array(new ArrayBuffer(rawLength));
                                    for (i = 0; i < rawLength; i++) {
                                        array[i] = data.charCodeAt(i) & 0xff;
                                    }
                                    var pdfBlob = new Blob([array], { type: "application/pdf;charset=utf-8" })
                                    var pdfFile = URL.createObjectURL(pdfBlob)
                                    const options_pdf = {
                                        forcePDFJS: true,
                                        pdfOpenParams: {
                                            pagemode: "thumbs",
                                            navpanes: 0,
                                            toolbar: 0,
                                            scrollbar: 0,
                                            statusbar: 0,
                                            view: "FitV"
                                        }
                                    }

                                    PDFObject.embed(pdfFile, "#product_view", options_pdf);
                                }

                            })
                            // $('#product_view').html(" ")
                        } else if (type == "tool_prodict_product") {
                            $('#product_view').html("")
                            var product_view = document.getElementById('product_view')
                            product_view.style = "width:97.5%;height:97%;background-color:white;margin:15px"
                            //加载数据地图
                            var tzmap = document.createElement("div")
                            tzmap.style = "width: 100%;height:100%;border: 1px solid black;"
                            tzmap.id = "tzmap"
                            var mainui = document.createElement("div")
                            mainui.style = "position:absolute;text-align: center;width: 8%;height: 50%;top:20%;left:90%;overflow-x: hidden;overflow-y: scroll;border-left:2px solid black;padding-top:10px;"
                            mainui.id = "menu-ui"
                            mainui.setAttribute("class", "scrollbar_self")
                            product_view.append(tzmap, mainui)
                            let boundaries = {
                                type: "FeatureCollection",
                                name: "boundaries",
                                crs: { type: "name", properties: { name: "urn:ogc:def:crs:OGC:1.3:CRS84" } },
                                features: taizhoulist
                            };
                            // 加载ajax
                            var time_plot_taizhou = self_tz_product.select_state// $("input[name='tz_self_time']:checked").val()
                            
                            var type_plot_taizhou = self_tz_product.select_type//$("input[name='tz_self']:checked").val()
                            // console.log("加载数据的时间",time_plot_taizhou,type_plot_taizhou)
                            var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                            var isobandsLay = undefined
                            var title = undefined
                            var myIcon = undefined
                            // console.log(time_plot_taizhou, type_plot_taizhou)
                            $.ajax({
                                url: "upload_select_taizhou_data",  // 请求的地址
                                type: "post",  // 请求方式
                                //async: false,
                                timeout: 25000, //设置延迟上限
                                data: {
                                    'csrfmiddlewaretoken': csrf,
                                    'plot_type': type_plot_taizhou,
                                    'plot_time': time_plot_taizhou
                                },
                                dataType: "json",
                                success: function (data) {
                                    var select_type = data.plot_type
                                    if (select_type == "T" || select_type == "TMax24" || select_type == "TMin24"){
                                        var pl_type = "temp"
                                        var show_title = "气温"
                                        var levelV = map_toolbox_object.color_level(pl_type).levelV
                                        var isobands_options = map_toolbox_object.color_level(pl_type).isobands_options
                                    }
                                    else {
                                        var pl_type = "rain"
                                        var show_title = "降水"
                                        var levelV = map_toolbox_object.color_level(pl_type).levelV
                                        var isobands_options = map_toolbox_object.color_level(pl_type).isobands_options
                                    }
                                    var interpolate_options = {
                                        gridType: "points",
                                        property: "value",
                                        units: "degrees",
                                        weight: 10
                                    };
                                    // console.log(data.back_data)
                                    var grid = turf.featureCollection(data.back_data)
                                    
                                    let isobands = turf.isobands(
                                        grid,
                                        levelV,
                                        isobands_options
                                    );
                                    var map = new L.Map('tzmap', {
                                        center: new L.LatLng(28.6, 121.3),//110.763, 41.376   39.62353145, 121.9937485
                                        zoom: 9, //4
                                        zoomControl: false,
                                        dragging: false,
                                        scrollWheelZoom: false,
                                        doubleClickZoom: false,
                                        attributionControl: false, //是否去除右下角标志
                                        layers: []
                                    });
                                    map.bounds = turf.bbox(boundaries);
                                    // L.geoJSON(boundaries, {
                                    //     style: function (feature) {
                                    //         return { color: 'black', weight: 1, fillOpacity: 0.1 };
                                    //     }
                                    // }).addTo(map);
                                    isobandsLay = L.geoJSON(isobands, {
                                        style: function (feature) {
                                            return {
                                                color: '#4264fb',
                                                fillColor: feature.properties.fill,
                                                weight: 0.1,
                                                fillOpacity: 0.8
                                            };
                                        }
                                    });
                                    //   裁剪数据
                                    let features = [];//裁剪后的结果集
                                    isobands.features.forEach(function (feature1) {
                                        boundaries.features.forEach(function (feature2) {
                                            let intersection = null;
                                            try {
                                                intersection = turf.intersect(feature1, feature2);
                                            } catch (e) {
                                                try {
                                                    //色斑图绘制之后，可能会生成一些非法 Polygon ，例如 在 hole 里存在一些形状（听不懂？去查一下 GeoJSON 的规范），
                                                    //我遇到的一个意外情况大概是这样，这种 Polygon 在做 intersect() 操作的时候会报错，所以在代码中做了个容错操作。
                                                    //解决的方法通常就是做一次 turf.buffer() 操作，这样可以把一些小的碎片 Polygon 清理掉。
                                                    feature1 = turf.buffer(feature1, 0);
                                                    intersection = turf.intersect(feature1, feature2);
                                                } catch (e) {
                                                    intersection = feature1;//实在裁剪不了就不裁剪了,根据业务需求自行决定
                                                }
                                            }
                                            if (intersection != null) {
                                                intersection.properties = feature1.properties;
                                                intersection.id = (Math.random() * 100000).toFixed(0);
                                                features.push(intersection);
                                            }
                                        });
                                    });
                                    //turf.isobands有点不符合业务预期,只有一个等级时,结果集可能为空,无图形显示,写点程序(找出那一个等级，并添加进结果集)补救下
                                    if (features.length == 0) {
                                        let maxAttribute = map_toolbox_object.getMaxAttribute(levelV, grid, isobands_options.breaksProperties);
                                        let value = maxAttribute[0];
                                        let fill = maxAttribute[1];
                                        if (value != '' && fill != '') {
                                            //获取网格点Box
                                            let gridBox = turf.bbox(grid);
                                            //生成网格点范围的面
                                            let gridBoxPolygon = [[[gridBox[0], gridBox[1]], [gridBox[0], gridBox[3]], [gridBox[2], gridBox[3]], [gridBox[2], gridBox[1]], [gridBox[0], gridBox[1]]]];
                                            //获取网格范围的面与行政边界的交集 Polygon
                                            let intersectPolygon = null;
                                            let gridoxFeature = {
                                                "type": "Feature",
                                                "properties": { "fill-opacity": 0.8 },
                                                "geometry": { "type": "Polygon", "coordinates": gridBoxPolygon },
                                                "id": 10
                                            };
                                            try {
                                                intersectPolygon = turf.intersect(gridoxFeature, boundaries.features[0]);
                                            } catch (e) {
                                                try {
                                                    //色斑图绘制之后，可能会生成一些非法 Polygon ，例如 在 hole 里存在一些形状（听不懂？去查一下 GeoJSON 的规范），
                                                    //我遇到的一个意外情况大概是这样，这种 Polygon 在做 intersect() 操作的时候会报错，所以在代码中做了个容错操作。
                                                    //解决的方法通常就是做一次 turf.buffer() 操作，这样可以把一些小的碎片 Polygon 清理掉。
                                                    gridoxFeature = turf.buffer(gridoxFeature, 0);
                                                    intersectPolygon = turf.intersect(gridoxFeature, boundaries.features[0]);
                                                } catch (e) {
                                                    intersectPolygon = gridoxFeature;//实在裁剪不了就不裁剪了,根据业务需求自行决定
                                                }
                                            }
                                            //结果添加到结果数组
                                            if (intersectPolygon != null) {
                                                features.push({
                                                    "type": "Feature",
                                                    "properties": { "fill-opacity": 0.8, "fill": fill, "value": value },
                                                    "geometry": intersectPolygon.geometry,
                                                    "id": 0
                                                });
                                            }
                                        }
                                    }
                                    //裁剪结果
                                    // 叠加标题
                                    let intersection = turf.featureCollection(features);
                                    myIcon = L.divIcon({
                                        html: data.label,
                                        className: 'my-div-icon',
                                        iconSize: [600, 105],
                                    });
                                    title = L.marker([29.4, 120.9], { icon: myIcon }).addTo(map);

                                    var productIcon = L.divIcon({
                                        html: show_title,
                                        className: 'my-div-icon',
                                        iconSize: [300, 55],

                                    });

                                    L.marker([29.45, 122.56], { icon: productIcon }).addTo(map);
                                    // 叠加图片
                                    var imageBounds = [[27.6, 121.85], [27.8, 122.45]];
                                    // 将图片作为自定义图层加载到地图上（类似于Marker）
                                    L.imageOverlay('static/src/logo.png', imageBounds, { opacity: 1, zIndex: 20 }).addTo(map);
                                    var intersectionLay = L.geoJSON(intersection, {
                                        style: function (feature) {
                                            return {
                                                color: feature.properties.fill,
                                                fillColor: feature.properties.fill,
                                                weight: 1.0,
                                                fillOpacity: 0.9
                                            };
                                        }
                                    })
                                    intersectionLay.addTo(map)
                                    L.geoJSON(boundaries, {
                                        style: function (feature) {
                                            return { color: 'black', weight: 1, fillOpacity: 0.1 };
                                        }
                                    }).addTo(map);

                                    //色标                                   
                                    map_toolbox_object.label_map(isobands_options, map,pl_type)                                
                                    //页面设置slider
                                    var sliderui = document.getElementById("menu-ui");
                                    var labels = data.btn_index
                                    var layerstr = "";
                                    for (var i = 0; i < labels.length; i++) {
                                        var id = "time_silder" + i.toString();

                                        var singlebtn = document.createElement("button");
                                        singlebtn.id = id;
                                        singlebtn.style = "width:90%;height: 6%;margin-top:8px; border-radius:8px;"
                                        singlebtn.innerText = labels[i]
                                        singlebtn.onclick = function (e) {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            let clickedstr = this.id;
                                            var index = clickedstr.lastIndexOf("r");
                                            var item = clickedstr.substring(index + 1, clickedstr.length);
                                            var time_plot_taizhou = self_tz_product.select_state// $("input[name='tz_self_time']:checked").val()
                                            var type_plot_taizhou = self_tz_product.select_type //$("input[name='tz_self']:checked").val()
                                            var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                                            console.log(parseInt(item))


                                            $.ajax({
                                                url: "upload_select_taizhou_data",  // 请求的地址
                                                type: "post",  // 请求方式
                                                async: false,
                                                timeout: 25000, //设置延迟上限
                                                data: {
                                                    'csrfmiddlewaretoken': csrf,
                                                    'plot_type': type_plot_taizhou,
                                                    'plot_time': time_plot_taizhou,
                                                    'plot_item': parseInt(item)

                                                },
                                                dataType: "json",
                                                success: function (result) {
                                                    // console.log("ok--", result, item)
                                                    //开始进行数据的叠加
                                                    intersectionLay.remove()
                                                    title.remove()
                                                    myIcon = L.divIcon({
                                                        html: result.click_label,
                                                        className: 'my-div-icon',
                                                        iconSize: [600, 105],
                                                    });
                                                    title = L.marker([29.4, 120.9], { icon: myIcon }).addTo(map);
                                                    //L.marker([29.4, 120.9], { icon: myIcon }).addTo(map);

                                                    var grid = turf.featureCollection(result.click_data)

                                                    let isobands = turf.isobands(
                                                        grid,
                                                        levelV,
                                                        isobands_options
                                                    );
                                                    //   裁剪数据
                                                    let features = [];//裁剪后的结果集
                                                    isobands.features.forEach(function (feature1) {
                                                        boundaries.features.forEach(function (feature2) {
                                                            let intersection = null;
                                                            try {
                                                                intersection = turf.intersect(feature1, feature2);
                                                            } catch (e) {
                                                                try {
                                                                    //色斑图绘制之后，可能会生成一些非法 Polygon ，例如 在 hole 里存在一些形状（听不懂？去查一下 GeoJSON 的规范），
                                                                    //我遇到的一个意外情况大概是这样，这种 Polygon 在做 intersect() 操作的时候会报错，所以在代码中做了个容错操作。
                                                                    //解决的方法通常就是做一次 turf.buffer() 操作，这样可以把一些小的碎片 Polygon 清理掉。
                                                                    feature1 = turf.buffer(feature1, 0);
                                                                    intersection = turf.intersect(feature1, feature2);
                                                                } catch (e) {
                                                                    intersection = feature1;//实在裁剪不了就不裁剪了,根据业务需求自行决定
                                                                }
                                                            }
                                                            if (intersection != null) {
                                                                intersection.properties = feature1.properties;
                                                                intersection.id = (Math.random() * 100000).toFixed(0);
                                                                features.push(intersection);
                                                            }
                                                        });
                                                    });
                                                    //turf.isobands有点不符合业务预期,只有一个等级时,结果集可能为空,无图形显示,写点程序(找出那一个等级，并添加进结果集)补救下
                                                    if (features.length == 0) {
                                                        let maxAttribute = map_toolbox_object.getMaxAttribute(levelV, grid, isobands_options.breaksProperties);
                                                        let value = maxAttribute[0];
                                                        let fill = maxAttribute[1];
                                                        if (value != '' && fill != '') {
                                                            //获取网格点Box
                                                            let gridBox = turf.bbox(grid);
                                                            //生成网格点范围的面
                                                            let gridBoxPolygon = [[[gridBox[0], gridBox[1]], [gridBox[0], gridBox[3]], [gridBox[2], gridBox[3]], [gridBox[2], gridBox[1]], [gridBox[0], gridBox[1]]]];
                                                            //获取网格范围的面与行政边界的交集 Polygon
                                                            let intersectPolygon = null;
                                                            let gridoxFeature = {
                                                                "type": "Feature",
                                                                "properties": { "fill-opacity": 0.8 },
                                                                "geometry": {
                                                                    "type": "Polygon",
                                                                    "coordinates": gridBoxPolygon
                                                                },
                                                                "id": 10
                                                            };
                                                            try {
                                                                intersectPolygon = turf.intersect(gridoxFeature, boundaries.features[0]);
                                                            } catch (e) {
                                                                try {
                                                                    //色斑图绘制之后，可能会生成一些非法 Polygon ，例如 在 hole 里存在一些形状（听不懂？去查一下 GeoJSON 的规范），
                                                                    //我遇到的一个意外情况大概是这样，这种 Polygon 在做 intersect() 操作的时候会报错，所以在代码中做了个容错操作。
                                                                    //解决的方法通常就是做一次 turf.buffer() 操作，这样可以把一些小的碎片 Polygon 清理掉。
                                                                    gridoxFeature = turf.buffer(gridoxFeature, 0);
                                                                    intersectPolygon = turf.intersect(gridoxFeature, boundaries.features[0]);
                                                                } catch (e) {
                                                                    intersectPolygon = gridoxFeature;//实在裁剪不了就不裁剪了,根据业务需求自行决定
                                                                }
                                                            }
                                                            //结果添加到结果数组
                                                            if (intersectPolygon != null) {
                                                                features.push({
                                                                    "type": "Feature",
                                                                    "properties": {
                                                                        "fill-opacity": 0.8,
                                                                        "fill": fill,
                                                                        "value": value
                                                                    },
                                                                    "geometry": intersectPolygon.geometry,
                                                                    "id": 0
                                                                });
                                                            }
                                                        }
                                                    }
                                                    //裁剪结果
                                                    // 叠加标题
                                                    let intersection = turf.featureCollection(features);
                                                    intersectionLay = L.geoJSON(intersection, {
                                                        style: function (feature) {
                                                            return {
                                                                color: '#ffffff',
                                                                fillColor: feature.properties.fill,
                                                                weight: 0.1,
                                                                fillOpacity: 1.0
                                                            };
                                                        }
                                                    })
                                                    intersectionLay.addTo(map)
                                                    L.geoJSON(boundaries, {
                                                        style: function (feature) {
                                                            return { color: 'black', weight: 1, fillOpacity: 0.1 };
                                                        }
                                                    }).addTo(map);


                                                }
                                            })


                                        }
                                        sliderui.appendChild(singlebtn);
                                    }


                                }
                            })
                        } else if (type == "tool_ec") {
                            function label_of_ectime(data){
                                var today = new Date()
                                var y = today.getFullYear();
                                var m = today.getMonth() + 1 < 10 ? "0" + (today.getMonth() + 1) : today.getMonth() + 1;
                                var d = today.getDate() < 10 ? "0" + today.getDate() : today.getDate();
                                var h = today.getHours() < 10 ? "0" + today.getHours() + ":00:00" : today.getHours() + ":00:00";
                                var today_str = y + "-" + m + "-" + d + " " + h;
                                var init_day = getNextDate(today_str, day=-1) 
                                var label_x = []
                                // 坐标
                                for (var i = 0;i<41;i++){
                                    if (i%4==0){
                                        var day_item = i/4
                                        var label_day = getNextDate(init_day, day=day_item)
                                        var label = label_day.substring(5,12) + "-20:00"
                                        label_x.push(label)
                                        //console.log(i/4)
                                    }
                                    else{
                                        var label = " " 
                                        label_x.push(label)
                                    }
                                }
                                // 气温
                                var tempmax = Math.max.apply(null,data.t2)
                                var tempmin = Math.min.apply(null,data.t2)
                                var tempave = (tempmax + tempmin)/2.0
                                var labmax = (tempave * 1.5).toFixed(0)
                                var labmin = (tempmin - (tempave * 1.5 - tempmin)*1.8 ).toFixed(0)
                                // 降水
                                var lspmax = Math.max.apply(null,data.lsp)
                                var cpmax = Math.max.apply(null,data.cp)
                                if (lspmax>cpmax){
                                    var rainmax = lspmax
                                }
                                else{
                                    var rainmax = cpmax
                                }
                                var rainlabel = (rainmax*2.3).toFixed(0)
                                // console.log(,Math.max.apply(null,data.cp),data)
                                return [label_x,labmax,rainlabel,labmin]
                            }

                            var boundaries = map_toolbox_object.return_boundaries(taizhoulist).boundaries
                            $('#product_view').html(" ")
                            var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                            $.ajax({
                                url: "ec_single_data",  // 请求的地址
                                type: "post",  // 请求方式
                                timeout: 25000, //设置延迟上限
                                data: {
                                    'csrfmiddlewaretoken': csrf,
                                    'ec_start_time': $('#ec_start_time').val(),
                                    'ec_end_time': $('#ec_end_time').val()
                                },
                                dataType: "json",
                                beforeSend: function (XMLHttpRequest) {
                                    load = showLoad();
                                },
                                success: function (data) {
                                    console.log("tool_ec", data)
                                    var labelthings = label_of_ectime(data.linedata[0])
                                    // var serverdata = JSON.parse(data)  
                                    var product_view = document.getElementById("product_view")
                                    product_view.style = ";width:100%;height:100%;background-color:white;;padding:30px;"
                                    // 绘图的核心程序
                                    var mapdiv = document.createElement('div')
                                    mapdiv.style = "width: 100%;height:100%;border: 1px solid rgb(75, 73, 73);margin-bottom:15px;border-radius:15px;"
                                    mapdiv.id = "ecmapview"
                                    // 按钮组
                                    var main_ecmapui = document.createElement("div")
                                    main_ecmapui.style = "position:absolute;text-align: center;width: 6%;height: 35%;top:10%;left:54%;padding-top:10px;overflow-x: hidden;overflow-y: scroll;"
                                    main_ecmapui.id = "main_ecmapui"
                                    main_ecmapui.setAttribute("class", "scrollbar_self")

                                    // 按钮组 事件
                                    var labels_ecmapui = ["台州", "玉环", "温岭", "三门", "天台", "仙居", "临海", "路桥", "椒江", "黄岩"]
                                    var layerstr_ecmapui = [taizhou_map, yuhuan_map, wenling_map, sanmen_map, tiantai_map, xianju_map, linhai_map, luqiao_map, jiaojiang_map, huangyan_map]
                                    var Lat = [27.6, 27.9, 28.1, 28.8, 28.91, 28.25, 28.3, 28.4, 28.4, 28.3]
                                    var Lon = [120.7, 121.2, 121.3, 121.4, 121.0, 120.70, 121.1, 121.4, 121.4, 121.0]
                                    var zoon = [8, 10, 10, 10, 10, 9, 9, 11, 10, 10, 10]
                                    for (var i = 0; i < labels_ecmapui.length; i++) {
                                        var singlebtn = document.createElement("button");
                                        var id = "ecbt_silder" + i.toString();
                                        
                                        singlebtn.setAttribute("class", "layui-btn layui-btn-sm")
                                        singlebtn.style = "width:100%;height: 10%;margin-top:8px; border-radius:8px;margin-left:0px"
                                        singlebtn.id = id
                                        singlebtn.innerText = labels_ecmapui[i]
                                        singlebtn.onclick = function (e) {
                                            // console.log(this.innerText)
                                            map.eachLayer(function (layer) {
                                                if (!layer._container || ('' + jQuery(layer._container).attr('class')).replace(/\s/g, '') != 'leaflet-layer') {
                                                    layer.remove();
                                                }
                                            });
                                            //id
                                            var item = this.id
                                            var ites = item.substring(11, item.length)
                                            var charttings = label_of_ectime(data.linedata[parseInt(ites)])
                                            //截取数字
                                            var boundaries_sigle = map_toolbox_object.return_boundaries(layerstr_ecmapui[parseInt(ites)]).boundaries
                                            map.bounds = turf.bbox(boundaries_sigle);
                                            map.setView([Lat[parseInt(ites)], Lon[parseInt(ites)]], zoon[parseInt(ites)])
                                            var lines = L.geoJSON(boundaries_sigle, {
                                                style: function (feature) {
                                                    return { color: 'black', weight: 1, fillOpacity: 0.1 };
                                                }
                                            }).addTo(map)
                                            //绘制数据
                                            var plot_type = "rain"
                                            var intersectionLay = map_toolbox_object.return_shp(boundaries_sigle, data.plotdata,plot_type).intersectionLay
                                            intersectionLay.addTo(map)
                                            // 加载echart数据

                                            option = {
                                                // tooltip: {
                                                //     trigger: 'axis',
                                                //     axisPointer: {
                                                //         // Use axis to trigger tooltip
                                                //         type: 'shadow' // 'shadow' as default; can also be 'line' or 'shadow'
                                                //     }
                                                // },
                                                title: {
                                                    text: labels_ecmapui[parseInt(ites)],
                                                    textStyle: {
                                                        align: 'center',
                                                        color: 'black',
                                                        fontSize: 25,
                                                    },
                                                    top: '5%',
                                                    left: '8%',
                                                },
                                                grid: {
                                                    top: '8%',
                                                    right: '6%',
                                                    left: '6%',
                                                    bottom: '8%'
                                                },
                                                xAxis: [{
                                                    type: 'category',
                                                    axisTick: {
                                                        alignWithLabel: true
                                                    },
                                                    axisLine: {
                                                        show: true,
                                                        lineStyle: {
                                                            color: "black",
                                                            width: 2
                                                        }
                                                    },
                                                    data: charttings[0]
                                                }],
                                                yAxis: [{
                                                    type: 'value',
                                                    name: '',
                                                    position: 'left',
                                                    alignTicks: true,
                                                    max: charttings[1],
                                                    min: charttings[3],
                                                    // interval: 50,
                                                    splitLine: { show: false },
                                                    axisLine: {
                                                        show: true,
                                                        lineStyle: {
                                                            color: "black",
                                                            width: 2
                                                        }
                                                    },
                                                    axisLabel: {
                                                        formatter: '{value} °C'
                                                    }
                                                }, {
                                                    type: 'value',
                                                    name: '',
                                                    position: 'right',
                                                    alignTicks: true,
                                                    max:  charttings[2],
                                                    min: 0,
                                                    // interval: 10,
                                                    axisLine: {
                                                        show: true,
                                                        lineStyle: {
                                                            color: "black",
                                                            width: 2
                                                        },
                                                        onZero:false
                                                    },
                                                    splitLine: { show: false },
                                                    axisLabel: {
                                                        formatter: '{value} mm'
                                                    }
                                                }],
                                                series: [{
                                                    name: '总降水',
                                                    type: 'bar',
                                                    color: "red",
                                                    stack: 'Ad',
                                                    yAxisIndex: 1,
                                                    data: data.linedata[parseInt(ites)].lsp
                                                }, {
                                                    name: '对流降水',
                                                    stack: 'Ad',
                                                    type: 'bar',
                                                    yAxisIndex: 1,
                                                    color: "blue",
                                                    data: data.linedata[parseInt(ites)].cp
                                                }, {
                                                    name: '温度',
                                                    type: 'line',
                                                    yAxisIndex: 0,
                                                    data: data.linedata[parseInt(ites)].t2
                                                }]
                                            };
                                            // 使用刚指定的配置项和数据显示图表。

                                            myChart.setOption(option);

                                        }
                                        main_ecmapui.append(singlebtn)
                                    }
                                    product_view.append(mapdiv, main_ecmapui)
                                    // 加载地图
                                    var map = new L.Map('ecmapview', {
                                        center: new L.LatLng(27.6, 120.7),//110.763, 41.376   39.62353145, 121.9937485
                                        zoom: 8, //4
                                        zoomControl: false,
                                        dragging: true,
                                        scrollWheelZoom: true,
                                        doubleClickZoom: false,
                                        attributionControl: false, //是否去除右下角标志
                                        layers: []
                                    });
                                    map.bounds = turf.bbox(boundaries);
                                    L.geoJSON(boundaries, {
                                        style: function (feature) {
                                            return { color: 'black', weight: 1, fillOpacity: 0.1 };
                                        }
                                    }).addTo(map);
                                    var plot_type = "rain"
                                    var main_intersectionLay = map_toolbox_object.return_shp(boundaries, data.plotdata,plot_type).intersectionLay
                                    main_intersectionLay.addTo(map)
                                    var chart = L.control({ position: 'bottomright' });
                                    chart.onAdd = function (map) {
                                        var div = L.DomUtil.create('div', 'info chartecmap');
                                        div.id = "chatrecmap";
                                        return div;
                                    };
                                    chart.addTo(map);
                                    // 基于准备好的dom，初始化echarts实例
                                    var myChart = echarts.init(document.getElementById('chatrecmap'));
                                    // 洪家的情况
                                    option = {
                                        // tooltip: {
                                        //     trigger: 'axis',
                                        //     axisPointer: {
                                        //         // Use axis to trigger tooltip
                                        //         type: 'shadow' // 'shadow' as default; can also be 'line' or 'shadow'
                                        //     }
                                        // },
                                        title: {
                                            text: "台州",
                                            textStyle: {
                                                align: 'center',
                                                color: 'black',
                                                fontSize: 25,
                                            },
                                            top: '5%',
                                            left: '8%',
                                        },
                                        grid: {
                                            top: '8%',
                                            right: '6%',
                                            left: '6%',
                                            bottom: '8%'
                                        },
                                        xAxis: [{
                                            type: 'category',
                                            axisTick: {
                                                alignWithLabel: true
                                            },
                                            axisLabel: {
                                                inside: false,
                                                textStyle: {
                                                    color: '#000',
                                                    fontSize: '10',
                                                    itemSize: ''

                                                }
                                            },
                                            axisLine: {
                                                show: true,
                                                lineStyle: {
                                                    color: "black",
                                                    width: 2
                                                },
                                                onZero:false                                                                     
                                            },
                                            data:labelthings[0]
                                        }],
                                        yAxis: [{
                                            type: 'value',
                                            name: '',
                                            position: 'left',
                                            alignTicks: true,
                                            max: labelthings[1],
                                            min: labelthings[3],
                                            splitLine: { show: false },
                                            axisLine: {
                                                show: true,
                                                lineStyle: {
                                                    color: "black",
                                                    width: 2
                                                }
                                            },
                                            axisLabel: {
                                                formatter: '{value} °C'
                                            }
                                        }, {
                                            type: 'value',
                                            name: '',
                                            position: 'right',
                                            alignTicks: true,
                                            max: labelthings[2],
                                            min: 0,
                                            // interval: 10,
                                            axisLine: {
                                                show: true,
                                                lineStyle: {
                                                    color: "black",
                                                    width: 2
                                                }
                                            },
                                            splitLine: { show: false },
                                            axisLabel: {
                                                formatter: '{value} mm'
                                            }
                                        }],
                                        series: [{
                                            name: '总雨量',
                                            type: 'bar',
                                            color: "red",
                                            stack: 'Ad',
                                            yAxisIndex: 1,
                                            data: data.linedata[0].lsp
                                        }, {
                                            name: '对流降水',
                                            stack: 'Ad',
                                            type: 'bar',
                                            yAxisIndex: 1,
                                            color: "blue",
                                            data: data.linedata[0].cp
                                        }, {
                                            name: '温度',
                                            type: 'line',
                                            yAxisIndex: 0,
                                            data: data.linedata[0].t2
                                        }]
                                    };
                                    // 使用刚指定的配置项和数据显示图表。
                                    myChart.setOption(option);
                                    // 关闭加载界面
                                    closeLoad(load)




                                }
                            })

                        } else if (type == "select_self_plot") {
                            $('#product_view').html(" ")
                            var select_map = $('#self_plot_country').val()
                            var select_id = $('#select_self_plot').val()
                            var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                            $.ajax({
                                url: "select_self_plot",  // 请求的地址
                                type: "post",  // 请求方式
                                timeout: 25000, //设置延迟上限
                                data: {
                                    'csrfmiddlewaretoken': csrf,
                                    'select_id': $('#select_self_plot').val()
                                },
                                dataType: "json",
                                success: function (data) {
                                    // console.log("返回成功", data)
                                    // function return_boundaries(city) {

                                    // }

                                    function return_layers(grid, boundaries) {
                                        var isobands_options = {
                                            zProperty: "value",
                                            commonProperties: {
                                                "fill-opacity": 0.9
                                            },
                                            breaksProperties: [
                                                { fill: "rgb(255,255,255)" },
                                                { fill: "rgb(140,246,130)" },
                                                { fill: "rgb(0,191,27)" },
                                                { fill: "rgb(62,185,255)" },
                                                { fill: "rgb(25,0,235)" },
                                                { fill: "rgb(255,0,255)" },
                                                { fill: "rgb(140,0,65)" }
                                            ]
                                        };
                                        var levelV = [10, 20, 30, 50, 70, 90, 100];
                                        var isobands = turf.isobands(
                                            grid,
                                            levelV,
                                            isobands_options
                                        );
                                        var isobandsLay = L.geoJSON(isobands, {
                                            style: function (feature) {
                                                return {
                                                    color: '#4264fb',
                                                    fillColor: feature.properties.fill,
                                                    weight: 0.1,
                                                    fillOpacity: 0.8
                                                };
                                            }
                                        });
                                        //   裁剪数据
                                        var features = [];//裁剪后的结果集
                                        isobands.features.forEach(function (feature1) {
                                            boundaries.features.forEach(function (feature2) {
                                                var intersection = null;
                                                try {
                                                    intersection = turf.intersect(feature1, feature2);
                                                } catch (e) {
                                                    try {
                                                        //色斑图绘制之后，可能会生成一些非法 Polygon ，例如 在 hole 里存在一些形状（听不懂？去查一下 GeoJSON 的规范），
                                                        //我遇到的一个意外情况大概是这样，这种 Polygon 在做 intersect() 操作的时候会报错，所以在代码中做了个容错操作。
                                                        //解决的方法通常就是做一次 turf.buffer() 操作，这样可以把一些小的碎片 Polygon 清理掉。
                                                        feature1 = turf.buffer(feature1, 0);
                                                        intersection = turf.intersect(feature1, feature2);
                                                    } catch (e) {
                                                        intersection = feature1;//实在裁剪不了就不裁剪了,根据业务需求自行决定
                                                    }
                                                }
                                                if (intersection != null) {
                                                
                                                    intersection.properties = feature1.properties;
                                                    intersection.id = (Math.random() * 100000).toFixed(0);
                                                    features.push(intersection);
                                                    
                                                }
                                            });
                                        });
                                        //turf.isobands有点不符合业务预期,只有一个等级时,结果集可能为空,无图形显示,写点程序(找出那一个等级，并添加进结果集)补救下
                                        if (features.length == 0) {
                                            var maxAttribute = map_toolbox_object.getMaxAttribute(levelV, grid, isobands_options.breaksProperties);
                                            var value = maxAttribute[0];
                                            var fill = maxAttribute[1];
                                            if (value != '' && fill != '') {
                                                //获取网格点Box
                                                var gridBox = turf.bbox(grid);
                                                //生成网格点范围的面
                                                var gridBoxPolygon = [[[gridBox[0], gridBox[1]], [gridBox[0], gridBox[3]], [gridBox[2], gridBox[3]], [gridBox[2], gridBox[1]], [gridBox[0], gridBox[1]]]];
                                                //获取网格范围的面与行政边界的交集 Polygon
                                                var intersectPolygon = null;
                                                var gridoxFeature = {
                                                    "type": "Feature",
                                                    "properties": { "fill-opacity": 0.8 },
                                                    "geometry": { "type": "Polygon", "coordinates": gridBoxPolygon },
                                                    "id": 10
                                                };
                                                try {
                                                    intersectPolygon = turf.intersect(gridoxFeature, boundaries.features[0]);
                                                } catch (e) {
                                                    try {
                                                        //色斑图绘制之后，可能会生成一些非法 Polygon ，例如 在 hole 里存在一些形状（听不懂？去查一下 GeoJSON 的规范），
                                                        //我遇到的一个意外情况大概是这样，这种 Polygon 在做 intersect() 操作的时候会报错，所以在代码中做了个容错操作。
                                                        //解决的方法通常就是做一次 turf.buffer() 操作，这样可以把一些小的碎片 Polygon 清理掉。
                                                        gridoxFeature = turf.buffer(gridoxFeature, 0);
                                                        intersectPolygon = turf.intersect(gridoxFeature, boundaries.features[0]);
                                                    } catch (e) {
                                                        intersectPolygon = gridoxFeature;//实在裁剪不了就不裁剪了,根据业务需求自行决定
                                                    }
                                                }
                                                //结果添加到结果数组
                                                if (intersectPolygon != null) {
                                                    features.push({
                                                        "type": "Feature",
                                                        "properties": { "fill-opacity": 0.8, "fill": fill, "value": value },
                                                        "geometry": intersectPolygon.geometry,
                                                        "id": 0
                                                    });
                                                    
                                                }
                                            }
                                        }
                                        
                                        var intersection = turf.featureCollection(features);
                                        var intersectionLay = L.geoJSON(intersection, {
                                            style: function (feature) {
                                                return {
                                                    color: 'black',
                                                    fillColor: feature.properties.fill,
                                                    weight: 0.1,
                                                    fillOpacity: 0.7
                                                };
                                            }
                                        })
                                        return intersectionLay


                                    }

                                    //按钮组
                                    var product_view = document.getElementById('product_view')
                                    product_view.style = "width:97.5%;height:97%;background-color:white;margin:15px"
                                    //加载数据地图
                                    var tzmap = document.createElement("div")
                                    tzmap.style = "width: 100%;height:100%;border: 1px solid black;"
                                    tzmap.id = "product_self"
                                    var mainui = document.createElement("div")
                                    mainui.style = "position:absolute;text-align: center;width: 30%;height: 5%;top:15%;left:60%;overflow-x: scroll;overflow-y: hidden;border-bottom:2px solid black;padding-top:10px;"
                                    mainui.id = "menu-self-ui"
                                    mainui.setAttribute("class", "scrollbar_self")

                                    var labels = ["台州", "玉环", "温岭", "三门", "天台", "仙居", "临海", "路桥", "椒江", "黄岩"]
                                    var layerstr = [taizhou_map, yuhuan_map, wenling_map, sanmen_map, tiantai_map, xianju_map, linhai_map, luqiao_map, jiaojiang_map, huangyan_map]
                                    var Lat = [27.6, 28.2, 28.1, 28.8, 28.91, 28.25, 28.3, 28.4, 28.4, 28.3]
                                    var Lon = [120.7, 121.2, 121.3, 121.4, 121.0, 120.70, 121.1, 121.4, 121.4, 121.0]
                                    var zoon = [8, 11, 10, 10, 10, 9, 9, 11, 10, 10, 10]
                                    for (var i = 0; i < labels.length; i++) {
                                        var id = "self_silder" + i.toString();
                                        var singlebtn = document.createElement("button");
                                        singlebtn.id = id;
                                        singlebtn.style = "width:10%;height: 100%;margin-top:8px; border-radius:8px;"
                                        singlebtn.innerText = labels[i]
                                        singlebtn.onclick = function (e) {
                                            map_product.eachLayer(function (layer) {
                                                if (!layer._container || ('' + jQuery(layer._container).attr('class')).replace(/\s/g, '') != 'leaflet-layer') {
                                                    layer.remove();
                                                }
                                            });
                                            //id
                                            var item = this.id
                                            var ites = item.substring(11, item.length)
                                            //截取数字
                                            var boundaries = {
                                                type: "FeatureCollection",
                                                name: "boundaries",
                                                crs: { type: "name", properties: { name: "urn:ogc:def:crs:OGC:1.3:CRS84" } },
                                                features: layerstr[parseInt(ites)]
                                            };
                                            map_product.bounds = turf.bbox(boundaries);
                                            map_product.setView([Lat[parseInt(ites)], Lon[parseInt(ites)]], zoon[parseInt(ites)])
                                            var lines = L.geoJSON(boundaries, {
                                                style: function (feature) {
                                                    return { color: 'black', weight: 1, fillOpacity: 0.1 };
                                                }
                                            }).addTo(map_product)
                                            var intersectionLay = return_layers(grid, boundaries)
                                            intersectionLay.addTo(map_product)
                                            if (labels[parseInt(ites)] != "台州") {
                                                // 格点的裁剪
                                                var shp = []
                                                grid.features.forEach(function (feature1) {
                                                    boundaries.features.forEach(function (feature2) {
                                                        var point = feature1.geometry.coordinates
                                                        var value = feature1.properties.value
                                                        var points = turf.points([point]);
                                                        var ptsWithin = turf.pointsWithinPolygon(feature1, feature2);
                                                        if (ptsWithin.features.length > 0) {
                                                            shp.push(ptsWithin)
                                                        }
                                                    })
                                                })
                                                var shpgrid = turf.featureCollection(shp);
                                                var gridLay = L.geoJSON(shpgrid, {
                                                    pointToLayer: function (feature, latlng) {
                                                        //marker的icon文字
                                                        var myIcon = L.divIcon({
                                                            html: "<div style='color:black;font-size: 5px;'>" + feature.properties.value.toFixed(1) + "</div>",
                                                            className: '',
                                                            iconSize: 1
                                                        });
                                                        return L.marker(latlng, { icon: myIcon });
                                                    }
                                                });
                                                gridLay.addTo(map_product)

                                            }
                                            
                                        }
                                        mainui.append(singlebtn)
                                    }
                                    product_view.append(tzmap, mainui)
                                    var boundaries = {
                                        type: "FeatureCollection",
                                        name: "boundaries",
                                        crs: { type: "name", properties: { name: "urn:ogc:def:crs:OGC:1.3:CRS84" } },
                                        features: taizhoulist
                                    };
                                    var map_product = new L.Map('product_self', {
                                        center: new L.LatLng(28.7, 121.1),//110.763, 41.376   39.62353145, 121.9937485
                                        zoom: 9, //4
                                        zoomControl: false,
                                        // dragging: false,
                                        // scrollWheelZoom: false,
                                        doubleClickZoom: false,
                                        attributionControl: false, //是否去除右下角标志
                                        layers: []
                                    });
                                    var lines = L.geoJSON(boundaries, {
                                        style: function (feature) {
                                            return { color: 'black', weight: 1, fillOpacity: 0.1 };
                                        }
                                    }).addTo(map_product)
                                    map_product.bounds = turf.bbox(boundaries);
                                    var grid = data.grid                                
                                    var intersectionLay = return_layers(grid, boundaries)                                
                                    intersectionLay.addTo(map_product)
                                }
                            })
                        }
                    }
                    // 自定义材料加载
                    $('#product_show_button').click(function () {
                        var type = "product_show"
                        product_view_show(type)

                    })
                    // 画图--精细化
                    $('#plot_self_button').click(function () {
                        var type = "plot_self"
                        product_view_show(type)
                        // var chartDom = document.getElementById('canvas_bar');
                        // var myChart_bar = echarts.init(chartDom);

                    })
                    // 市台历史数据的显示
                    $('.tool_history_button').click(function () {
                        var type = "tool_history"
                        // console.log("tool_history_button")
                        product_view_show(type)


                    })

                    // 市台订正数据加载
                    const self_tz_product = {
                        select_state:undefined,
                        select_type:undefined
                    }
                    layui.use('layer', function () { //独立版的layer无需执行这一句
                            var $ = layui.jquery, layer = layui.layer; //独立版的layer无需执行这一句
                            
                            //触发事件
                            var active = {
                                product_date: function () {
                                    //配置一个透明的询问框
                                    layer.msg('请选择起报时次', {
                                        time: 20000, //20s后自动关闭
                                        btn: ['08时', '20时'],
                                        btn1: function (index, layero) {
                                            self_tz_product.select_state = "08" 
                                            var type = "tool_prodict_product"
                                            product_view_show(type)                                   
                                            layer.closeAll();
                                        },
                                        btn2: function (index, layero) {
                                            self_tz_product.select_state = "20"   
                                            var type = "tool_prodict_product"
                                            product_view_show(type)                                      
                                        }
                                    });
                                },

                            };

                            $('.tool_prodict_product').on('click', function () {
                                var othis = $(this), method = othis.data('method');
                                active[method] ? active[method].call(this, othis) : '';
                                self_tz_product.select_type = this.value
                                // console.log(this.value)
                                
                            });
                        });

                    // $('.tool_prodict_product').click(function () {
                    //     // console.log("点击了数据文件")
                    //     var type = "tool_prodict_product"
                    //     product_view_show(type)

                    // })
                    Highcharts.setOptions({
                            lang: {
                                contextButtonTitle: "图表导出菜单",
                                decimalPoint: ".",
                                downloadJPEG: "下载JPEG图片",
                                downloadPDF: "下载PDF文件",
                                downloadPNG: "下载PNG文件",
                                downloadSVG: "下载SVG文件",
                                drillUpText: "返回 {series.name}",
                                loading: "加载中",
                                months: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
                                noData: "没有数据",
                                numericSymbols: ["千", "兆", "G", "T", "P", "E"],
                                printChart: "打印图表",
                                resetZoom: "恢复缩放",
                                resetZoomTitle: "恢复图表",
                                shortMonths: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                                thousandsSep: ",",
                                weekdays: ["星期一", "星期二", "星期三", "星期四", "星期五", "星期六", "星期天"]
                            }
                        }); 
                    

                    const zdz_recdata_obj = {
                        start_date:undefined,
                        end_date:undefined,
                        table_data: undefined,
                        data_all: undefined,
                        data_single:undefined,
                        zdz_map: undefined,
                        plot_data: undefined,
                        boundaries_taizhou: undefined,
                        current_layer:undefined,
                        marker_list:[],
                        flush_map: function () {
                            if (zdz_recdata_obj.current_layer) {
                                zdz_recdata_obj.current_layer.remove()
                                zdz_recdata_obj.current_layer = undefined
                            }
                            if (zdz_recdata_obj.marker_list.length > 0) {
                                for (var i = 0; i < zdz_recdata_obj.marker_list.length; i++) {
                                    zdz_recdata_obj.marker_list[i].remove()
                                }
                                zdz_recdata_obj.marker_list = []
                            }
                        },
                        single_day: function (date, type) {
                            function single_data_fun(item,index_date,slicenum){
                                // 降水
                            if (item.rain_list){
                                var rain_list = item.rain_list.slice(index_date,slicenum)
                                var RR = rain_list.reduce(function (a,b){
                                    return a + b 
                                },0)
                            }
                            else {
                                var rain_list = false 
                                var RR = -9999.0
                            }
                            // 风速风向
                            if (item.fFy_list){
                                var fFy_list = item.fFy_list.slice(index_date,slicenum)
                                var wind = fFy_list.reduce((x, y) => x > y ? x : y)
                                var dFy_list = item.dFy_list.slice(index_date,slicenum)
                                var index = fFy_list.indexOf(wind)
                                if (index!=-1){
                                    var windir = dFy_list[index]
                                }
                                else {
                                    var windir = dFy_list[0]
                                }
                            }
                            else {
                                var fFy_list = false 
                                var wind = -9999.0
                                var windir = -9999.0
                                var dFy_list = false
                            }
                            // 高温
                            if (item.tmax_list){
                                var tmax_list = item.tmax_list.slice(index_date,slicenum)
                                var tmax = tmax_list.reduce((x, y) => x > y ? x : y)
                            }
                            else {
                                var tmax_list = false 
                                var tmax = -9999.0
                            }
                            // 低温
                            if (item.tmin_list){
                                var tmin_list = item.tmin_list.slice(index_date,slicenum)
                                var tmin = tmin_list.reduce((x, y) => x < y ? x : y)
                            }
                            else {
                                var tmin_list = false 
                                var tmin = -9999.0
                            }
                            // 能见度
                            if (item.view_list){
                                var view_list = item.view_list.slice(index_date,slicenum)
                                var view = view_list.reduce((x, y) => x < y ? x : y)
                            }
                            else {
                                var view_list = false 
                                var view = -9999.0
                            }
                            var single = {
                                "StationName":item.StationName,
                                "county":item.county,
                                "town":item.town,
                                "lat": item.lat,
                                "lon": item.lon,
                                "Tx":tmax,
                                "Tn":tmin,
                                "VV":view,
                                "fFy":wind/10.0,
                                "dFy":windir,
                                "RR":RR,
                                "time": item.time_list.slice(index_date, slicenum),
                                "dFy_list": dFy_list,
                                "fFy_list": fFy_list,
                                "rain_list": rain_list,
                                "tmax_list": tmax_list,
                                "tmin_list": tmin_list,
                                "view_list": view_list
                            }
                            return single

                            }
                            //刷新地图数据· 
                            function return_index(date,item) {
                                var arr = [];
                                for (var i = 0; i < item.time_list.length; i++) {
                                    if (item.time_list[i].match(date) != null) {
                                        arr.push(item.time_list[i]);
                                    }
                                }
                                return [arr[0],arr[arr.length - 1]];
                            }
                            zdz_recdata_obj.flush_map()
                            var data_single = []
                            // 解析单日数据
                            zdz_recdata_obj.data_all.forEach(function (item) {      
                                var len_time = item.time_list.length
                                var yestorday = getNextDate(date,-1)
                                var index = return_index(date,item)
                                
                                if (index[0] != index[1]){
                                    var index_start = item.time_list.indexOf(index[0])
                                    var index_end = item.time_list.indexOf(index[1])
                                    // console.log("日期",date,index,index_start,index_end)  
                                    var single = single_data_fun(item,index_start,index_end)
                                    data_single.push(single) 
                                }                             
                            })
                            zdz_recdata_obj.data_single = data_single
                            if (type=="view"){
                                // ------------------------------开始绘图---------------------------------
                                zdz_recdata_obj.flush_map()
                                var points = []
                                data_single.forEach(function (item) {
                                    if (item.VV != -9999.0) {           
                                        // 渲染颜色
                                        var single_point = {
                                            type: "Feature",
                                            "properties": {
                                                "value": item.VV
                                            },
                                            "geometry": {
                                                "type": "Point",
                                                "coordinates": [parseFloat(item.lon), parseFloat(item.lat)]
                                            }
                                        }
                                        points.push(single_point)
                                    }
                                })
                                var plot_type = "view"
                                var intersectionLay = map_toolbox_object.return_shp(zdz_recdata_obj.boundaries_taizhou, points,plot_type).intersectionLay
                                intersectionLay.addTo(zdz_recdata_obj.zdz_map)
                                zdz_recdata_obj.current_layer = intersectionLay 
                                data_single.forEach(function (item) {
                                    if (item.VV != -9999.0) {
                                         // 绘制单点
                                        var latlng = L.latLng(item.lat, item.lon);                       
                                            var marker = L.circleMarker(latlng, {
                                                station: item.StationName,
                                                timelist: item.time,
                                                viewlist: item.view_list,
                                                VV:item.VV,
                                                weight: 0,
                                                radius: 5,
                                                opacity: 1,
                                                fill: false,
                                                zIndexOffset:9999,
                                                labelStyle: {
                                                    text: item.StationName+':'+item.VV.toString(),
                                                    weight: 1,
                                                    opacity: 1,
                                                    rotation: 0,
                                                    color: "yellow",
                                                    zIndex: 800
                                                }
                                            }).addTo(zdz_recdata_obj.zdz_map).on("click",function (e) {
                                                // console.log(e.sourceTarget.options.station,e.sourceTarget.options.deg,e.sourceTarget.options.sped)
                                                //整理datalist
                                                var plot_type = "view"
                                                var plot_time = e.sourceTarget.options.timelist
                                                var plot_list = e.sourceTarget.options.viewlist
                                                var plot_name = e.sourceTarget.options.station
                                                // console.log("能见度单点数据",plot_time,plot_name)
                                                zdz_recdata_obj.rander_line(plot_type, plot_time, plot_list, plot_name)
                                            })
                                            zdz_recdata_obj.marker_list.push(marker)

                                    }})                                 
                            }
                            else if (type=="rain"){
                                zdz_recdata_obj.flush_map()
                                var points = []
                                zdz_recdata_obj.data_single.forEach(function (item) {
                                    if (item.RR != -9999.0) {                                    
                                        // 渲染颜色
                                        var single_point = {
                                            type: "Feature",
                                            "properties": {
                                                "value": item.RR
                                            },
                                            "geometry": {
                                                "type": "Point",
                                                "coordinates": [parseFloat(item.lon), parseFloat(item.lat)]
                                            }
                                        }
                                        points.push(single_point)
                                    }
                                })
                                var plot_type = "rain"
                                var intersectionLay = map_toolbox_object.return_shp(zdz_recdata_obj.boundaries_taizhou, points,plot_type).intersectionLay
                                intersectionLay.addTo(zdz_recdata_obj.zdz_map)
                                zdz_recdata_obj.current_layer = intersectionLay
                                zdz_recdata_obj.data_single.forEach(function (item) {
                                    if (item.RR != -9999.0) {
                                        // 绘制mark
                                        var latlng = L.latLng(item.lat, item.lon);
                                        var c = L.circleMarker(latlng, {
                                            name: item.IIiii,
                                            station: item.StationName,
                                            timelist: item.time,
                                            rainlist: item.rain_list,
                                            weight: 0,
                                            radius: 7,
                                            opacity: 1,
                                            fill: false,
                                            zIndexOffset:9999,
                                            labelStyle: {
                                                text: item.StationName,
                                                weight: 10,
                                                rotation: 0,
                                                color: "rgb(239, 243, 237)",
                                                zIndex: 60
                                            }
                                        }).addTo(zdz_recdata_obj.zdz_map).on("click", function (e) {
                                            var plot_type = "rain"
                                            var plot_time = e.sourceTarget.options.timelist
                                            var plot_list = e.sourceTarget.options.rainlist
                                            var plot_name = e.sourceTarget.options.station
                                            zdz_recdata_obj.rander_line(plot_type, plot_time, plot_list, plot_name)

                                        });
                                        zdz_recdata_obj.marker_list.push(c)

                                    }})
                            }
                            else if (type=="wind"){
                                zdz_recdata_obj.flush_map()
                                var points = []
                                zdz_recdata_obj.data_single.forEach(function (item) {
                                    if (item.fFy_list) {
                                        // 渲染颜色
                                        // console.log(item.fFy,[parseFloat(item.lon), parseFloat(item.lat)])
                                        var single_point = {
                                            type: "Feature",
                                            "properties": {
                                                "value": item.fFy
                                            },
                                            "geometry": {
                                                "type": "Point",
                                                "coordinates": [parseFloat(item.lon), parseFloat(item.lat)]
                                            }
                                        }
                                        points.push(single_point)
                                    }
                                })
                                var plot_type = "wind"
                                var intersectionLay = map_toolbox_object.return_shp(zdz_recdata_obj.boundaries_taizhou, points,plot_type).intersectionLay
                                intersectionLay.addTo(zdz_recdata_obj.zdz_map)
                                zdz_recdata_obj.current_layer = intersectionLay
                                zdz_recdata_obj.data_single.forEach(function (item) {
                                        if (item.fFy_list) {
                                            var latlng = L.latLng(item.lat, item.lon);
                                            var icon = L.WindBarb.icon({ 
                                                deg: 360-item.dFy, 
                                                pointRadius: 4, 
                                                strokeLength: 5,
                                                fillColor:"red",
                                                speed: item.fFy*2.5 
                                            });
                                            var marker = L.marker([item.lat, item.lon], { 
                                                icon: icon,
                                                name: item.IIiii,
                                                deg:item.dFy,
                                                sped:item.fFy,
                                                station: item.StationName,
                                                timelist: item.time,
                                                fFylist: item.fFy_list,
                                                dFylist: item.dFy_list
                                            }).addTo(zdz_recdata_obj.zdz_map).on("click",function (e) {
                                                // console.log(e.sourceTarget.options.station,e.sourceTarget.options.deg,e.sourceTarget.options.sped)
                                                //整理datalist
                                                var plot_type = "wind"
                                                var plot_time = e.sourceTarget.options.timelist
                                                var plot_list = []
                                                var plot_name = e.sourceTarget.options.station
                                                for (var i=0;i<e.sourceTarget.options.timelist.length;i++){
                                                    var single_list = [e.sourceTarget.options.fFylist[i]/10.0,e.sourceTarget.options.dFylist[i]]
                                                    plot_list.push(single_list) 
                                                }
                                                zdz_recdata_obj.rander_line(plot_type, plot_time, plot_list, plot_name)
                                            })
                                            zdz_recdata_obj.marker_list.push(marker)

                                        }
                                    })



                            }
                            else if (type=="temp"){
                                zdz_recdata_obj.flush_map()
                                var points = []
                                zdz_recdata_obj.data_single.forEach(function (item) {
                                    if (item.Tn != -9999.0) {
                                        // 渲染颜色
                                        var single_point = {
                                            type: "Feature",
                                            "properties": {
                                                "value": item.Tn
                                            },
                                            "geometry": {
                                                "type": "Point",
                                                "coordinates": [parseFloat(item.lon), parseFloat(item.lat)]
                                            }
                                        }
                                        points.push(single_point)
                                    }
                                })
                                var plot_type = "temp"
                                var intersectionLay = map_toolbox_object.return_shp(zdz_recdata_obj.boundaries_taizhou, points,plot_type).intersectionLay
                                intersectionLay.addTo(zdz_recdata_obj.zdz_map)
                                zdz_recdata_obj.current_layer = intersectionLay

                                zdz_recdata_obj.data_single.forEach(function (item) {
                                        if (item.Tx!=-9999.0 || item.Tn!=-9999.0) {
                                            var latlng = L.latLng(item.lat, item.lon);                       
                                            var marker = L.circleMarker(latlng, {
                                                name: item.IIiii,
                                                station: item.StationName,
                                                timelist: item.time,
                                                templist: item.tmax_list,
                                                tempmax:item.Tx,
                                                tempmin:item.Tn,
                                                weight: 0,
                                                radius: 5,
                                                opacity: 1,
                                                fill: false,
                                                labelStyle: {
                                                    text: item.StationName+':'+item.Tx.toString(),
                                                    weight: 1,
                                                    rotation: 0,
                                                    color: "rgb(239, 243, 237)",
                                                    zIndex: 800
                                                }
                                            }).addTo(zdz_recdata_obj.zdz_map).on("click",function (e) {
                                                // console.log(e.sourceTarget.options.station,e.sourceTarget.options.deg,e.sourceTarget.options.sped)
                                                //整理datalist
                                                var plot_type = "temp"
                                                var plot_time = e.sourceTarget.options.timelist
                                                var plot_list = e.sourceTarget.options.templist
                                                var plot_name = e.sourceTarget.options.station
                                                // console.log(e.sourceTarget.options.station,e.sourceTarget.options.tempmax,e.sourceTarget.options.tempmin)
                                                zdz_recdata_obj.rander_line(plot_type, plot_time, plot_list, plot_name)
                                            })
                                            zdz_recdata_obj.marker_list.push(marker)

                                        }
                                    })

                            }



                            
                        },
                        init: function () {
                            if (zdz_recdata_obj.zdz_map) {
                                zdz_recdata_obj.zdz_map.eachLayer(function (layer) {
                                    if (!layer._container || ('' + jQuery(layer._container).attr('class')).replace(/\s/g, '') != 'leaflet-layer') {
                                        layer.remove();
                                    }
                                });
                                var boundaries = map_toolbox_object.return_boundaries(taizhoulist).boundaries
                                zdz_recdata_obj.boundaries_taizhou = boundaries
                                var canvasLabel = new L.CanvasLabel({
                                    defaultLabelStyle: {
                                        collisionFlg: true,
                                        scale: 1,
                                        strokeStyle: "#000",
                                        fillStyle: "#fff",
                                        lineWidth: 3
                                    }

                                });
                                var lines = L.geoJSON(boundaries, {
                                    style: function (feature) {
                                        return { color: 'black', weight: 1, fillOpacity: 0.01 };
                                    }
                                })
                                var map_zdz = new L.Map('zdz_webgis', {
                                    center: new L.LatLng(28.6, 120.9),//110.763, 41.376   39.62353145, 121.9937485
                                    renderer: canvasLabel,
                                    zoom: 8, //4
                                    zoomControl: false,
                                    dragging: true,
                                    scrollWheelZoom: true,
                                    doubleClickZoom: false,
                                    attributionControl: false, //是否去除右下角标志
                                    bounds: turf.bbox(boundaries),
                                    layers: [lines]
                                });
                                zdz_recdata_obj.zdz_map = map_zdz

                            }
                            else {
                                var boundaries = map_toolbox_object.return_boundaries(taizhoulist).boundaries
                                zdz_recdata_obj.boundaries_taizhou = boundaries
                                var canvasLabel = new L.CanvasLabel({
                                    defaultLabelStyle: {
                                        collisionFlg: true,
                                        scale: 1,
                                        strokeStyle: "#000",
                                        fillStyle: "#fff",
                                        lineWidth: 3
                                    }

                                });
                                var lines = L.geoJSON(boundaries, {
                                    style: function (feature) {
                                        return { color: 'black', weight: 1, fillOpacity: 0.01 };
                                    }
                                })
                                var map_zdz = new L.Map('zdz_webgis', {
                                    center: new L.LatLng(28.6, 120.9),//110.763, 41.376   39.62353145, 121.9937485
                                    renderer: canvasLabel,
                                    zoom: 8, //4
                                    zoomControl: false,
                                    dragging: true,
                                    scrollWheelZoom: true,
                                    doubleClickZoom: false,
                                    attributionControl: false, //是否去除右下角标志
                                    bounds: turf.bbox(boundaries),
                                    layers: [lines]
                                });
                                zdz_recdata_obj.zdz_map = map_zdz

                            }
                            


                        },
                        plot: function (click_type) {
                            // zdz_recdata_obj.init()
                            var points = []
                            if (click_type == "rain") {
                                zdz_recdata_obj.data_all.forEach(function (item) {
                                    if (item.RR != "-9999.0") {
                                        // 渲染颜色
                                        var single_point = {
                                            type: "Feature",
                                            "properties": {
                                                "value": item.RR
                                            },
                                            "geometry": {
                                                "type": "Point",
                                                "coordinates": [parseFloat(item.lon), parseFloat(item.lat)]
                                            }
                                        }
                                        points.push(single_point)
                                    }
                                })
                                var plot_type = "rain"
                                var intersectionLay = map_toolbox_object.return_shp(zdz_recdata_obj.boundaries_taizhou, points,plot_type).intersectionLay
                                intersectionLay.addTo(zdz_recdata_obj.zdz_map)
                                zdz_recdata_obj.current_layer = intersectionLay
                            }
                            else if (click_type == "wind"){
                                // console.log("绘制封场")
                                zdz_recdata_obj.data_all.forEach(function (item) {
                                    if (item.fFy != "-9999.0") {
                                        // 渲染颜色
                                        // console.log(item.fFy,[parseFloat(item.lon), parseFloat(item.lat)])
                                        var single_point = {
                                            type: "Feature",
                                            "properties": {
                                                "value": item.fFy
                                            },
                                            "geometry": {
                                                "type": "Point",
                                                "coordinates": [parseFloat(item.lon), parseFloat(item.lat)]
                                            }
                                        }
                                        points.push(single_point)
                                    }
                                })
                                var plot_type = "wind"
                                var intersectionLay = map_toolbox_object.return_shp(zdz_recdata_obj.boundaries_taizhou, points,plot_type).intersectionLay
                                intersectionLay.addTo(zdz_recdata_obj.zdz_map)
                                zdz_recdata_obj.current_layer = intersectionLay

                            }
                            else if (click_type == "temp"){
                                zdz_recdata_obj.data_all.forEach(function (item) {
                                    if (item.Tn != "-9999.0") {
                                        // 渲染颜色
                                        var single_point = {
                                            type: "Feature",
                                            "properties": {
                                                "value": item.Tn
                                            },
                                            "geometry": {
                                                "type": "Point",
                                                "coordinates": [parseFloat(item.lon), parseFloat(item.lat)]
                                            }
                                        }
                                        points.push(single_point)
                                    }
                                })
                                var plot_type = "temp"
                                var intersectionLay = map_toolbox_object.return_shp(zdz_recdata_obj.boundaries_taizhou, points,plot_type).intersectionLay
                                intersectionLay.addTo(zdz_recdata_obj.zdz_map)
                                zdz_recdata_obj.current_layer = intersectionLay
                            }
                            else if (click_type == "view"){
                                zdz_recdata_obj.data_all.forEach(function (item) {
                                    if (item.VV != "-9999.0") {
                                        // 渲染颜色
                                        var single_point = {
                                            type: "Feature",
                                            "properties": {
                                                "value": item.VV
                                            },
                                            "geometry": {
                                                "type": "Point",
                                                "coordinates": [parseFloat(item.lon), parseFloat(item.lat)]
                                            }
                                        }
                                        points.push(single_point)
                                    }
                                })
                                var plot_type = "view"
                                var intersectionLay = map_toolbox_object.return_shp(zdz_recdata_obj.boundaries_taizhou, points,plot_type).intersectionLay
                                intersectionLay.addTo(zdz_recdata_obj.zdz_map)
                                zdz_recdata_obj.current_layer = intersectionLay
                            }
                            
                        },
                        randar_single_table:function(type){
                            // 升序排列
                            function up(a, b) {
                                return a.RR - b.RR
                            }
                            // 降序排列
                            function down(a, b) {
                                return b.RR - a.RR
                            }
                            if (type == "wind") {
                                var sort_data = zdz_recdata_obj.data_all.sort(down)
                                layui.use('table', function (data) {
                                    var table = layui.table;
                                    //展示已知数据
                                    table.render({
                                        elem: '#zdz_table'
                                        , cols: [[ //标题栏
                                            { field: 'IIiii', title: '站号', width: 80 }
                                            , { field: 'county', title: '县市', minWidth: 80 }
                                            , { field: 'StationName', title: '站名', width: 80 }
                                            , { field: 'town', title: '站名', width: 80 }
                                            , { field: 'lat', title: '纬度', width: 80 }
                                            , { field: 'lon', title: '经度', width: 80 }
                                            , { field: 'fFy', title: '风力', minWidth: 80, sort: true }
                                        ]]
                                        , data: sort_data
                                        , skin: 'line' //表格风格
                                        // , even: true
                                        , page: true //是否显示分页
                                        , limits: [5]
                                        , limit: 5 //每页默认显示的数量
                                    });
                                });
                            }
                            else if (type == "rain") {
                                var sort_data = zdz_recdata_obj.data_all.sort(down)
                                layui.use('table', function (data) {
                                    var table = layui.table;
                                    //展示已知数据
                                    table.render({
                                        elem: '#zdz_table'
                                        , cols: [[ //标题栏
                                            { field: 'IIiii', title: '站号', width: 80 }
                                            , { field: 'county', title: '县市', minWidth: 80 }
                                            , { field: 'StationName', title: '站名', width: 80 }
                                            , { field: 'town', title: '站名', width: 80 }
                                            , { field: 'lat', title: '纬度', width: 80 }
                                            , { field: 'lon', title: '经度', width: 80 }
                                            , { field: 'RR', title: '降雨', minWidth: 80, sort: true }
                                        ]]
                                        , data: sort_data
                                        , skin: 'line' //表格风格
                                        // , even: true
                                        , page: true //是否显示分页
                                        , limits: [5]
                                        , limit: 5 //每页默认显示的数量
                                    });
                                });

                            }
                            else if (type == "temp") {
                                var sort_data = zdz_recdata_obj.data_all.sort(down)
                                layui.use('table', function (data) {
                                    var table = layui.table;
                                    //展示已知数据
                                    table.render({
                                        elem: '#zdz_table'
                                        , cols: [[ //标题栏
                                            { field: 'IIiii', title: '站号', width: 80 }
                                            , { field: 'county', title: '县市', minWidth: 80 }
                                            , { field: 'StationName', title: '站名', width: 80 }
                                            , { field: 'town', title: '站名', width: 80 }
                                            , { field: 'lat', title: '纬度', width: 80 }
                                            , { field: 'lon', title: '经度', width: 80 }
                                            , { field: 'Tn', title: '气温', minWidth: 80, sort: true }
                                        ]]
                                        , data: sort_data
                                        , skin: 'line' //表格风格
                                        // , even: true
                                        , page: true //是否显示分页
                                        , limits: [5]
                                        , limit: 5 //每页默认显示的数量
                                    });
                                });

                            }     
                            else if (type == "view") {
                                var sort_data = zdz_recdata_obj.data_all.sort(down)
                                layui.use('table', function (data) {
                                    var table = layui.table;
                                    //展示已知数据
                                    table.render({
                                        elem: '#zdz_table'
                                        , cols: [[ //标题栏
                                            { field: 'IIiii', title: '站号', width: 80 }
                                            , { field: 'county', title: '县市', minWidth: 80 }
                                            , { field: 'StationName', title: '站名', width: 80 }
                                            , { field: 'town', title: '站名', width: 80 }
                                            , { field: 'lat', title: '纬度', width: 80 }
                                            , { field: 'lon', title: '经度', width: 80 }
                                            , { field: 'VV', title: '能见度', minWidth: 80, sort: true }
                                        ]]
                                        , data: sort_data
                                        , skin: 'line' //表格风格
                                        // , even: true
                                        , page: true //是否显示分页
                                        , limits: [5]
                                        , limit: 5 //每页默认显示的数量
                                    });
                                });

                            }             
                            
                        },
                        rander_table: function (revdata) {
                            layui.use('table', function (data) {
                                var table = layui.table;
                                //展示已知数据
                                table.render({
                                    elem: '#zdz_table'
                                    , cols: [[ //标题栏
                                        { field: 'IIiii', title: '站号', width: 80 }
                                        , { field: 'county', title: '县市', minWidth: 80 }
                                        , { field: 'StationName', title: '站名', width: 80 }
                                        , { field: 'fFy', title: '风力', minWidth: 80, sort: true }
                                        , { field: 'RR', title: '降水', width: 80, sort: true }
                                        , { field: 'Tx', title: '低温', width: 80, sort: true }
                                        , { field: 'Tn', title: '高温', width: 80, sort: true }
                                        , { field: 'VV', title: '能见度', width: 80, sort: true }
                                    ]]
                                    , data: revdata
                                    , skin: 'line' //表格风格
                                    // , even: true
                                    , page: true //是否显示分页
                                    , limits: [5]
                                    , limit: 5 //每页默认显示的数量
                                });
                            });
                        },
                        rander_btn: function (revdata) {
                            var ul_zdz = document.getElementById("ul_time_zdz")
                            for (var i = 0; i < revdata.length; i++) {
                                if (i==0){
                                    var status = "first"
                                }
                                else if (i==revdata.length-1){
                                    var status = "last"
                                }
                                else {
                                    var status = "middle"
                                }
                                var li_single = document.createElement("li")
                                li_single.setAttribute("class", "layui-timeline-item")
                                li_single.innerHTML = '<i class="layui-icon layui-timeline-axis"></i>'
                                var div_single = document.createElement("div")
                                div_single.setAttribute("class", "layui-timeline-content layui-text")
                                // 按钮
                                var single = revdata[i]
                                var title = single["time"]
                                var title_h = document.createElement("h3")
                                title_h.setAttribute("class", "layui-timeline-title")
                                title_h.innerText = title
                                var rain = single["rain"]
                                var wind = single["wind"]
                                var tmax = single["tmax"]
                                var tmin = single["tmin"]
                                var view = single["view"]
                                var div_btn = document.createElement("div")
                                div_btn.setAttribute("class", "layui-btn-group")
                                if (view) {
                                    var btn_view = document.createElement("button")
                                    btn_view.setAttribute("class", "layui-btn layui-btn-xs view")
                                    btn_view.innerText = "雾"
                                    btn_view.value = title
                                    btn_view.addEventListener("click",function(e){
                                        var date = this.value
                                        var type = "view"
                                        zdz_recdata_obj.single_day(date,type)
                                    })
                                    div_btn.append(btn_view)
                                }
                                if (wind) {
                                    var btn_wind = document.createElement("button")
                                    btn_wind.setAttribute("class", "layui-btn layui-btn-xs wind")
                                    btn_wind.innerText = "风"
                                    btn_wind.value = title
                                    btn_wind.addEventListener("click",function(e){
                                        var date = this.value
                                        var type = "wind"
                                        zdz_recdata_obj.single_day(date,type)
                                    })
                                    div_btn.append(btn_wind)
                                }
                                if (rain) {
                                    var btn_rain = document.createElement("button")
                                    btn_rain.setAttribute("class", "layui-btn layui-btn-xs rain")
                                    btn_rain.innerText = "雨"
                                    btn_rain.value = title
                                    btn_rain.addEventListener("click",function(e){
                                        zdz_recdata_obj.flush_map()
                                        var date = this.value
                                        var type = "rain"
                                        zdz_recdata_obj.single_day(date,type)
                                    })
                                    div_btn.append(btn_rain)
                                }
                                if (tmax) {
                                    var btn_tmax = document.createElement("button")
                                    btn_tmax.setAttribute("class", "layui-btn layui-btn-xs temp")
                                    btn_tmax.innerText = "温"
                                    btn_tmax.value = title
                                    btn_tmax.addEventListener("click",function(e){
                                        var date = this.value
                                        var type = "tmax"
                                        zdz_recdata_obj.single_day(date,type)
                                    })
                                    div_btn.append(btn_tmax)
                                }
                                if (tmin) {
                                    var btn_tmin = document.createElement("button")
                                    btn_tmin.setAttribute("class", "layui-btn layui-btn-xs temp")
                                    btn_tmin.innerText = "温"
                                    btn_tmin.value = title
                                    btn_tmin.addEventListener("click",function(e){
                                        var date = this.value
                                        var type = "tmin"
                                        zdz_recdata_obj.single_day(date,type)
                                    })
                                    div_btn.append(btn_tmin)
                                }
                                div_single.append(title_h, div_btn)
                                li_single.append(div_single)
                                ul_zdz.append(li_single)
                            }

                        },
                        rander_line: function (plot_type, plot_time, plot_list, plot_name) {
                            //2022-01-25 20:00:00
                            var date_str = plot_time[0].toString()                          
                            var date_year = parseInt(date_str.slice(0,4)) 
                            var date_month = parseInt(date_str.slice(5,7))-1
                            var date_day = parseInt(date_str.slice(8,10))
                            var date_hour = parseInt(date_str.slice(11,13))
                            // console.log("画图的起始日期",date_str,plot_time[plot_time.length-1],date_year,date_month,date_day,date_hour)
                            if (plot_type == "rain") {
                                $("#li_zdz_line_chart").click()
                                // hightchatr 
                                chart = Highcharts.chart('continer_zdz_line_chart', {
                                    chart: {
                                        type: 'column',
                                        zoomType: 'x'
                                    },
                                    title: {
                                        text: plot_name.toString()
                                    },
                                    credits: {
                                        enabled: false//不显示LOGO
                                    },
                                    xAxis: {
                                        type: 'datetime',
                                        dateTimeLabelFormats: {
                                            millisecond: '%H:%M:%S.%L',
                                            second: '%H:%M:%S',
                                            minute: '%H:%M',
                                            hour: '%H:%M',
                                            day: '%m-%d',
                                            week: '%m-%d',
                                            month: '%Y-%m',
                                            year: '%Y'
                                        }
                                    },
                                    // tooltip: {
                                    //     dateTimeLabelFormats: {
                                    //         millisecond: '%H:%M:%S.%L',
                                    //         second: '%H:%M:%S',
                                    //         minute: '%H:%M',
                                    //         hour: '%H:%M',
                                    //         day: '%Y-%m-%d',
                                    //         week: '%m-%d',
                                    //         month: '%Y-%m',
                                    //         year: '%Y'
                                    //     }
                                    // },
                                    yAxis: {
                                        title: {
                                            text: '降雨量'
                                        }
                                    },
                                    legend: {
                                        enabled: false
                                    },
                                    plotOptions: {
                                        column: {
                                            borderWidth: 0
                                        },
                                        series: {
                                            pointStart: Date.UTC(date_year,date_month,date_day,date_hour),
                                            // pointStart: Date.UTC(2017, 0, 29),
                                            pointInterval: 36e5
                                        },
                                        area: {
                                            fillColor: {
                                                linearGradient: {
                                                    x1: 0,
                                                    y1: 0,
                                                    x2: 0,
                                                    y2: 1
                                                },
                                                stops: [
                                                    [0, new Highcharts.getOptions().colors[0]],
                                                    [1, new Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                                                ]
                                            },
                                            // marker: {
                                            //     radius: 2
                                            // },
                                            // lineWidth: 1,
                                            // states: {
                                            //     hover: {
                                            //         lineWidth: 1
                                            //     }
                                            // },
                                            barWidth: 1,
                                            threshold: null
                                        }
                                    },
                                    series: [{
                                        // type: 'area',
                                        name: '降水过程',
                                        data: plot_list
                                    }]
                                });


                            }
                            else if (plot_type == "wind") {
                                $("#li_zdz_line_chart").click()
                                Highcharts.chart('continer_zdz_line_chart', {
                                    title: {
                                        text: plot_name.toString()
                                    },
                                    credits: {
                                        enabled: false//不显示LOGO
                                    },
                                    chart: {
                                        zoomType: 'x'
                                    },
                                    xAxis: {
                                        type: 'datetime',
                                        offset: 40
                                    },
                                    plotOptions: {
                                        series: {
                                            pointStart: Date.UTC(date_year,date_month,date_day,date_hour),
                                            // pointStart: Date.UTC(2017, 0, 29),
                                            pointInterval: 36e5
                                        }
                                    },
                                    series: [
                                        {
                                            type: 'windbarb',
                                            data: plot_list,
                                            name: 'Wind',
                                            color: Highcharts.getOptions().colors[1],
                                            showInLegend: true,
                                            tooltip: {
                                                valueSuffix: ' m/s'
                                            }
                                        },
                                        {
                                            type: 'area',
                                            keys: ['y', 'rotation'], // rotation is not used here
                                            data: plot_list,
                                            color: Highcharts.getOptions().colors[0],
                                            fillColor: {
                                                linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                                                stops: [
                                                    [0, Highcharts.getOptions().colors[0]],
                                                    [
                                                        1,
                                                        Highcharts.color(Highcharts.getOptions().colors[0])
                                                            .setOpacity(0.25).get()
                                                    ]
                                                ]
                                            },
                                            name: '',
                                            tooltip: {
                                                valueSuffix: ' m/s'
                                            },
                                            states: {
                                                inactive: {
                                                    opacity: 1
                                                }
                                            }
                                        }
                                    ]

                                })
                            }
                            else if (plot_type == "temp") {
                                $("#li_zdz_line_chart").click()
                                
                                chart = Highcharts.chart('continer_zdz_line_chart', {
                                    chart: {
                                        zoomType: 'x'
                                    },
                                    title: {
                                        text: plot_name.toString()
                                    }, 
                                    credits: {
                                        enabled: false//不显示LOGO
                                    },                           
                                    xAxis: {
                                        type: 'datetime',
                                        dateTimeLabelFormats: {
                                            millisecond: '%H:%M:%S.%L',
                                            second: '%H:%M:%S',
                                            minute: '%H:%M',
                                            hour: '%H:%M',
                                            day: '%m-%d',
                                            week: '%m-%d',
                                            month: '%Y-%m',
                                            year: '%Y'
                                        }
                                    },
                                    // tooltip: {
                                    //     dateTimeLabelFormats: {
                                    //         millisecond: '%H:%M:%S.%L',
                                    //         second: '%H:%M:%S',
                                    //         minute: '%H:%M',
                                    //         hour: '%H:%M',
                                    //         day: '%Y-%m-%d',
                                    //         week: '%m-%d',
                                    //         month: '%Y-%m',
                                    //         year: '%Y'
                                    //     }
                                    // },
                                    yAxis: {
                                        title: {
                                            text: '气温'
                                        }
                                    },
                                    legend: {
                                        enabled: false
                                    },
                                    plotOptions: {
                                        series: {
                                            pointStart: Date.UTC(date_year,date_month,date_day,date_hour),
                                            // pointStart: Date.UTC(2017, 0, 29),
                                            pointInterval: 36e5
                                        },
                                        area: {
                                            fillColor: {
                                                linearGradient: {
                                                    x1: 0,
                                                    y1: 0,
                                                    x2: 0,
                                                    y2: 1
                                                },
                                                stops: [
                                                    [0, new Highcharts.getOptions().colors[0]],
                                                    [1, new Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                                                ]
                                            },
                                            marker: {
                                                radius: 2
                                            },
                                            lineWidth: 1,
                                            states: {
                                                hover: {
                                                    lineWidth: 1
                                                }
                                            },
                                            threshold: null
                                        }
                                    },
                                    series: [{
                                        type: 'area',
                                        name: '温度曲线',
                                        data: plot_list
                                    }]
                                });

                            }
                            else if (plot_type == "view") {
                                $("#li_zdz_line_chart").click()
                                
                                chart = Highcharts.chart('continer_zdz_line_chart', {
                                    chart: {
                                        type: 'column',
                                        zoomType: 'x'
                                    },
                                    title: {
                                        text: plot_name.toString()
                                    },
                                    credits: {
                                        enabled: false//不显示LOGO
                                    },                            
                                    xAxis: {
                                        type: 'datetime',
                                        dateTimeLabelFormats: {
                                            millisecond: '%H:%M:%S.%L',
                                            second: '%H:%M:%S',
                                            minute: '%H:%M',
                                            hour: '%H:%M',
                                            day: '%m-%d',
                                            week: '%m-%d',
                                            month: '%Y-%m',
                                            year: '%Y'
                                        }
                                    },
                                    // tooltip: {
                                    //     dateTimeLabelFormats: {
                                    //         millisecond: '%H:%M:%S.%L',
                                    //         second: '%H:%M:%S',
                                    //         minute: '%H:%M',
                                    //         hour: '%H:%M',
                                    //         day: '%Y-%m-%d',
                                    //         week: '%m-%d',
                                    //         month: '%Y-%m',
                                    //         year: '%Y'
                                    //     }
                                    // },
                                    yAxis: {
                                        title: {
                                            text: '能见度'
                                        }
                                    },
                                    legend: {
                                        enabled: false
                                    },
                                    plotOptions: {
                                        series: {
                                            pointStart: Date.UTC(date_year,date_month,date_day,date_hour),
                                            // pointStart: Date.UTC(2017, 0, 29),
                                            pointInterval: 36e5
                                        },
                                        area: {
                                            fillColor: {
                                                linearGradient: {
                                                    x1: 0,
                                                    y1: 0,
                                                    x2: 0,
                                                    y2: 1
                                                },
                                                stops: [
                                                    [0, new Highcharts.getOptions().colors[0]],
                                                    [1, new Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                                                ]
                                            },
                                            marker: {
                                                radius: 2
                                            },
                                            lineWidth: 1,
                                            states: {
                                                hover: {
                                                    lineWidth: 1
                                                }
                                            },
                                            threshold: null
                                        }
                                    },
                                    series: [{
                                        type: 'area',
                                        name: '能见度曲线',
                                        data: plot_list
                                    }]
                                });


                            }
                        },
                        rander_marker: function (click_type, click_time) {
                            // 
                            // zdz_recdata_obj.init()
                            var points = []
                            if (click_type == "rain") {
                                if (click_time == "all") {
                                    zdz_recdata_obj.plot(click_type)
                                    // 轮询   
                                    zdz_recdata_obj.data_all.forEach(function (item) {
                                        if (item.RR != "-9999.0") {
                                            // 渲染站点                     
                                            var latlng = L.latLng(item.lat, item.lon);
                                            var c = L.circleMarker(latlng, {
                                                name: item.IIiii,
                                                station: item.StationName,
                                                timelist: item.time_list,
                                                rainlist: item.rain_list,
                                                weight: 0,
                                                radius: 7,
                                                opacity: 1,
                                                fill: false,
                                                labelStyle: {
                                                    text: item.StationName,
                                                    weight: 10,
                                                    rotation: 0,
                                                    color: "rgb(239, 243, 237)",
                                                    zIndex: 60
                                                }
                                            }).addTo(zdz_recdata_obj.zdz_map).on("click", function (e) {
                                                /// 叠加echart绘图
                                                // console.log(e.sourceTarget.options.timelist,e.sourceTarget.options.rainlist)
                                                var plot_type = "rain"
                                                var plot_time = e.sourceTarget.options.timelist
                                                var plot_list = e.sourceTarget.options.rainlist
                                                var plot_name = e.sourceTarget.options.station
                                                zdz_recdata_obj.rander_line(plot_type, plot_time, plot_list, plot_name)

                                            });
                                            zdz_recdata_obj.marker_list.push(c)

                                        }
                                    })

                                }
                                else {

                                }

                            }
                            else if (click_type == "wind") {
                                if (click_time == "all") {
                                    zdz_recdata_obj.plot(click_type)
                                    // 轮询   
                                    zdz_recdata_obj.data_all.forEach(function (item) {
                                        if (item.fFy!="-9999.0") {
                                            var latlng = L.latLng(item.lat, item.lon);
                                            var icon = L.WindBarb.icon({ 
                                                deg: 360-item.dFy, 
                                                pointRadius: 4, 
                                                strokeLength: 5,
                                                fillColor:"red",
                                                speed: item.fFy*2.5 
                                            });
                                            var marker = L.marker([item.lat, item.lon], { 
                                                icon: icon,
                                                name: item.IIiii,
                                                deg:item.dFy,
                                                sped:item.fFy,
                                                station: item.StationName,
                                                timelist: item.time_list,
                                                fFylist: item.fFy_list,
                                                dFylist: item.dFy_list
                                            }).addTo(zdz_recdata_obj.zdz_map).on("click",function (e) {
                                                // console.log(e.sourceTarget.options.station,e.sourceTarget.options.deg,e.sourceTarget.options.sped)
                                                //整理datalist
                                                var plot_type = "wind"
                                                var plot_time = e.sourceTarget.options.timelist
                                                var plot_list = []
                                                var plot_name = e.sourceTarget.options.station
                                                for (var i=0;i<e.sourceTarget.options.timelist.length;i++){
                                                    var single_list = [e.sourceTarget.options.fFylist[i]/10.0,e.sourceTarget.options.dFylist[i]]
                                                    plot_list.push(single_list) 
                                                }
                                                zdz_recdata_obj.rander_line(plot_type, plot_time, plot_list, plot_name)
                                            })
                                            zdz_recdata_obj.marker_list.push(marker)

                                        }
                                    })


                                }
                                else {

                                }

                            }
                            else if (click_type == "temp") {
                                if (click_time == "all") {
                                    zdz_recdata_obj.plot(click_type)
                                    // 轮询   
                                    zdz_recdata_obj.data_all.forEach(function (item) {
                                        if (item.tmax!="-9999.0" || item.tmin!="-9999.0") {
                                            var latlng = L.latLng(item.lat, item.lon);                       
                                            var marker = L.circleMarker(latlng, {
                                                name: item.IIiii,
                                                station: item.StationName,
                                                timelist: item.time_list,
                                                templist: item.tmax_list,
                                                tempmax:item.Tx,
                                                tempmin:item.Tn,
                                                weight: 0,
                                                radius: 5,
                                                opacity: 1,
                                                fill: false,
                                                labelStyle: {
                                                    text: item.StationName+':'+item.Tx.toString(),
                                                    weight: 1,
                                                    rotation: 0,
                                                    color: "rgb(239, 243, 237)",
                                                    zIndex: 800
                                                }
                                            }).addTo(zdz_recdata_obj.zdz_map).on("click",function (e) {
                                                // console.log(e.sourceTarget.options.station,e.sourceTarget.options.deg,e.sourceTarget.options.sped)
                                                //整理datalist
                                                var plot_type = "temp"
                                                var plot_time = e.sourceTarget.options.timelist
                                                var plot_list = e.sourceTarget.options.templist
                                                var plot_name = e.sourceTarget.options.station
                                                // console.log(e.sourceTarget.options.station,e.sourceTarget.options.tempmax,e.sourceTarget.options.tempmin)
                                                zdz_recdata_obj.rander_line(plot_type, plot_time, plot_list, plot_name)
                                            })
                                            zdz_recdata_obj.marker_list.push(marker)

                                        }
                                    })


                                }
                                else {

                                }
                                 

                            }
                            else if (click_type == "view") {
                                if (click_time == "all") {
                                    zdz_recdata_obj.plot(click_type)
                                    // 轮询   
                                    zdz_recdata_obj.data_all.forEach(function (item) {
                                        if (item.VV!="-9999.0") {
                                            var latlng = L.latLng(item.lat, item.lon);                       
                                            var marker = L.circleMarker(latlng, {
                                                name: item.IIiii,
                                                station: item.StationName,
                                                timelist: item.time_list,
                                                viewlist: item.view_list,
                                                VV:item.VV,
                                                weight: 0,
                                                radius: 5,
                                                opacity: 1,
                                                fill: false,
                                                labelStyle: {
                                                    text: item.StationName+':'+item.VV.toString(),
                                                    weight: 1,
                                                    opacity: 1,
                                                    rotation: 0,
                                                    color: "yellow",
                                                    zIndex: 800
                                                }
                                            }).addTo(zdz_recdata_obj.zdz_map).on("click",function (e) {
                                                // console.log(e.sourceTarget.options.station,e.sourceTarget.options.deg,e.sourceTarget.options.sped)
                                                //整理datalist
                                                var plot_type = "view"
                                                var plot_time = e.sourceTarget.options.timelist
                                                var plot_list = e.sourceTarget.options.viewlist
                                                var plot_name = e.sourceTarget.options.station
                                                // console.log(e.sourceTarget.options.station,e.sourceTarget.options.tempmax,e.sourceTarget.options.tempmin)
                                                zdz_recdata_obj.rander_line(plot_type, plot_time, plot_list, plot_name)
                                            })
                                            zdz_recdata_obj.marker_list.push(marker)

                                        }
                                    })


                                }
                                else {

                                }
                                 

                            }

                        },
                        rander_data_group: function (recvdata,key) {
                            // key 是需要分组的键 data是json数据，功能是用来分组聚合
                            var id = key
                            var map = {},
                                dest = [];
                            for (var i = 0; i < recvdata.length; i++) {
                                var ai = recvdata[i];
                                if (!map[ai[id]]) {
                                    dest.push({
                                        id: ai[id],
                                        data: [ai]
                                    });
                                    map[ai[id]] = ai;
                                } else {
                                    for (var j = 0; j < dest.length; j++) {
                                        var dj = dest[j];
                                        if (dj.id == ai[key]) {
                                            dest[j].data.push(ai)
                                            dj.data.push(ai);
                                            break;
                                        }
                                    }
                                }
                            }
                            // console.log(dest);
                            return dest
                        },
                        randar_data_average:function(recvdata){
                            for (var i=0;i<recvdata.length;i++){
                                var name = recvdata[i].id
                                var single_data = recvdata[i].data
                                var total = single_data.reduce((t, l) => t + l.RR,0)
                                var len = single_data.length
                                recvdata[i].average = (total / len)/10.0
                            }
                            return recvdata
                        },
                        rander_data_range:function (recvdata,range){
                            var len = range.length
                            if (len ==1){
                                var start = range[0]
                                recvdata.forEach(function(item){
                                    if (item.RR>start){
                                        count = count + 1 
                                    }
                                })

                            }
                            else{
                                var start = range[0]
                                var end = range[1]
                                var count = 0
                                recvdata.forEach(function(item){
                                    if (item.RR>start && item.RR<end){
                                        count = count + 1 
                                    }
                                })
                            }
                            return count

                        },
                        randar_status_range:function(status,unity){
                            var text = "其中，"
                            if (unity=="米/秒"){
                                var unitys = "级"
                            }
                            else if(unity=="米"){
                                var unitys = "度"
                            }
                            else if(unity=="毫米"){
                                var unitys = "毫米"
                            }
                            else if(unity=="度"){
                                var unitys = "度"
                            }
                            for (key  in status){
                                if (key!="text"){
                                    if(status[key]>0){
                                        text = text + key.toString().slice(4) + unitys + "以上的有"+status[key].toString()+"站;"
                                    }                                
                                }
                                
                            }
                            return text 
                        },
                        randar_data_text:function(data,unity){
                            var text = ""
                            var index = 0
                            var len = data.length -1
                            data.forEach(function (item){
                                if (index==len){
                                    if (item.id) {
                                        text = text + item.id + ":" + item.average.toFixed(2).toString() + unity + "。"
                                    }
                                    else {
                                        text = text + item.StationName + ":" + item.RR.toFixed(2).toString() + unity + "。"
                                    }
                                }
                                else {
                                    if (item.id) {
                                        text = text + item.id + ":" + item.average.toFixed(2).toString() + unity + ";"
                                    }
                                    else {
                                        text = text + item.StationName + ":" + item.RR.toFixed(2).toString() + unity + ";"
                                    }
                                }               
                                index = index + 1 
                            })
                            return text 
                        },
                        randar_rain_text:function (click_time){
                            // 升序排列
                            function up(a, b) {
                                return a.RR - b.RR
                            }
                            // 降序排列
                            function down(a, b) {
                                return b.RR - a.RR
                            }
                            if (click_time == "all") {                
                                // 定义数据层
                                var wash_data = []
                                // var 
                                zdz_recdata_obj.data_all.forEach(function (item){
                                    // console.log(item)
                                    if (item.RR != "-9999") {
                                        if (parseFloat(item.RR) != 0) {
                                            var single = {
                                                "IIiii": item.IIiii,
                                                "county": item.county,
                                                "town": item.town,
                                                "StationName": item.StationName,
                                                "RR": parseFloat(item.RR),
                                                "lat": item.lat,
                                                "lon": item.lon
                                            }
                                            wash_data.push(single)
                                        }
                                    }
                                })
                                // sort 会直接对原数据排序
                                // wash_data.sort(down)
                                // 求和
                                // let total = wash_data.reduce((t, l) => t + l.score,0)
                                var key = "county"
                                var county =  zdz_recdata_obj.rander_data_group(wash_data,key)
                                // 面雨量
                                var average = zdz_recdata_obj.randar_data_average(county)
                                var totle_sum = 0
                                average.forEach(function(item){
                                    totle_sum = totle_sum + item.average
                                })
                                // 单站前五前五排序
                                var station = wash_data.sort(down).slice(0, 5)
                                // 乡镇前五排序
                                var keytown = "town"
                                var town = zdz_recdata_obj.rander_data_group(wash_data,keytown)
                                var town_average  =  zdz_recdata_obj.randar_data_average(town).sort(down).slice(0, 5)
                                // 量级---返回大于某一个量级的个数
                                var range = [10,50]
                                var count = zdz_recdata_obj.rander_data_range(wash_data,range)
                                var rain_text = "全市面雨量："
                                var unity = "毫米"
                                var text_average = zdz_recdata_obj.randar_data_text(average,unity)
                                var text_station = zdz_recdata_obj.randar_data_text(station,unity)
                                var text_town = zdz_recdata_obj.randar_data_text(town_average,unity)
                                rain_text = rain_text + (totle_sum/9).toFixed(2).toString() + "毫米。" + "各县面雨量：" + text_average + "单站前五分别是：" + text_station + "乡镇前五为：" + text_town 
                                return rain_text                               
                            }
                            else{    }

                        }, 
                        randar_wind_text: function (click_time) {
                            // 升序排列
                            function up(a, b) {
                                return a.RR - b.RR
                            }
                            // 降序排列
                            function down(a, b) {
                                return b.RR - a.RR
                            }
                            if (click_time == "all") {
                                // 定义数据层
                                var status = {
                                    "text":"",
                                    "wind17":0,
                                    "wind16":0,
                                    "wind15":0,
                                    "wind14":0,
                                    "wind13":0,
                                    "wind12":0,
                                    "wind11":0,
                                    "wind10":0,
                                    "wind9":0,
                                    "wind8":0
                                }
                                var wash_data = []
                                // var 
                                zdz_recdata_obj.data_all.forEach(function (item){
                                    // console.log(item)
                                    if (item.fFy != "-9999") {
                                        if (parseFloat(item.fFy) != 0) {                                     
                                            if ((parseFloat(item.fFy) >17.1) && (parseFloat(item.fFy) <20.7)){
                                                status.text = "全市出现8级大风。"
                                                status.wind8 = status.wind8 + 1               
                                            }
                                            else if ((parseFloat(item.fFy) >20.7) && (parseFloat(item.fFy) <24.4)){
                                                status.text = "全市出现8-9级大风。"
                                                status.wind9 = status.wind9 + 1
                                            }
                                            else if ((parseFloat(item.fFy) >24.4) && (parseFloat(item.fFy) <28.4)){
                                                status.text = "全市出现8-10级大风。"
                                                status.wind10 = status.wind10 + 1
                                            }
                                            else if ((parseFloat(item.fFy) >28.4) && (parseFloat(item.fFy) <32.6)){
                                                status.text = "全市出现8-11级大风。"
                                                status.wind11 = status.wind11 + 1
                                            }
                                            else if ((parseFloat(item.fFy) >32.6) && (parseFloat(item.fFy) <36.9)){
                                                status.text = "全市出现8-12级大风。"
                                                status.wind12 = status.wind12 + 1
                                            }
                                            else if ((parseFloat(item.fFy) >36.9) && (parseFloat(item.fFy) <41.4)){
                                                status.text = "全市出现8-13级大风。"
                                                status.wind13 = status.wind13 + 1
                                            }
                                            else if ((parseFloat(item.fFy) >41.4) && (parseFloat(item.fFy) <46.1)){
                                                status.text = "全市出现8-14级大风。"
                                                status.wind14 = status.wind14 + 1
                                            }
                                            else if ((parseFloat(item.fFy) >46.1) && (parseFloat(item.fFy) <50.9)){
                                                status.text = "全市出现8-15级大风。"
                                                status.wind15 = status.wind15 + 1
                                            }
                                            else if ((parseFloat(item.fFy) >50.9) && (parseFloat(item.fFy) <56.0)){
                                                status.text = "全市出现8-16级大风。"
                                                status.wind16 = status.wind16 + 1
                                            }
                                            else if (parseFloat(item.fFy) >56.0){
                                                status.text = "全市出现8-17级大风。"
                                                status.wind17 = status.wind17 + 1
                                            }
                                            var single = {
                                                "IIiii": item.IIiii,
                                                "county": item.county,
                                                "town": item.town,
                                                "StationName": item.StationName,
                                                "RR": parseFloat(item.fFy),
                                                "lat": item.lat,
                                                "lon": item.lon
                                            }
                                            wash_data.push(single)
                                        }
                                    }
                                })
                                var station = wash_data.sort(down).slice(0, 5)
                                var unity = "米/秒"
                                var text_count = zdz_recdata_obj.randar_status_range(status,unity)                        
                                var wind_text = status.text + text_count
                                var text_station = zdz_recdata_obj.randar_data_text(station,unity)
                                wind_text = wind_text + "风力较大的有:"+  text_station 
                                return wind_text
                            }
                            else {

                            }
                        },
                        randar_view_text: function (click_time) {
                            // 升序排列
                            function up(a, b) {
                                return a.RR - b.RR
                            }
                            // 降序排列
                            function down(a, b) {
                                return b.RR - a.RR
                            }
                            if (click_time == "all") {
                                // 定义数据层
                                var wash_data = []
                                var status = {
                                    "text":"",
                                    "view500":false,
                                    "view200":false,
                                    "view100":false,
                                    "view50":false
                                }
                                zdz_recdata_obj.data_all.forEach(function (item){
                                    // console.log(item)
                                    if (item.VV != "-9999") {
                                        if (parseFloat(item.VV) != 0) {
                                            // 判断灾害等级
                                            if (parseFloat(item.VV)<500){
                                                status.view500 = true
                                                status.text = "沿海出现能见度低于500米的雾。"
                                                if (parseFloat(item.VV)<200){
                                                    status.text = "沿海出现能见度低于200米的大雾。"
                                                    status.view200 = true
                                                    if (parseFloat(item.VV)<100){
                                                        status.text = "沿海出现能见度低于100米的浓雾。"
                                                        status.view100 = true
                                                        if (parseFloat(item.VV)<50){
                                                            status.text = "沿海出现能见度低于50米的强浓雾。"
                                                            status.view50 = true
                                                        }
                                                    }
                                                }
                                            }
                                            var single = {
                                                "IIiii": item.IIiii,
                                                "county": item.county,
                                                "town": item.town,
                                                "StationName": item.StationName,
                                                "RR": parseFloat(item.fFy),
                                                "lat": item.lat,
                                                "lon": item.lon
                                            }
                                            wash_data.push(single)
                                        }
                                    }
                                })
                                var station = wash_data.sort(down).slice(0, 5)
                                var unity = "米"
                                var view_text = status.text 
                                view_text = view_text +  "能见度较低的有:"
                                var text_station = zdz_recdata_obj.randar_data_text(station,unity)
                                view_text = view_text +  text_station 
                                return view_text

                            }
                            else {

                            }

                        },
                        randar_temp_text: function (click_time) {
                            // 升序排列
                            function up(a, b) {
                                return a.RR - b.RR
                            }
                            // 降序排列
                            function down(a, b) {
                                return b.RR - a.RR
                            }
                            if (click_time == "all") {
                                var wash_data = []
                                var status = {
                                    "text":"",
                                    "temp0":0,
                                    "temp3":0,
                                    "temp5":0,
                                    "temp35":0,
                                    "temp38":0
                                }
                                zdz_recdata_obj.data_all.forEach(function (item){
                                    // console.log(item)
                                    if (item.Tn && item.Tx) {
                                        if (parseFloat(item.Tn) < 0) {
                                            status.temp0 = status.temp0 + 1
                                        }
                                        if ((parseFloat(item.Tn) > 0) && (parseFloat(item.Tn)<3)) {
                                            status.temp3 = status.temp3 + 1
                                        }
                                        if ((parseFloat(item.Tn) > 3) && (parseFloat(item.Tn)<5)) {
                                            status.temp5 = status.temp5 + 1
                                        }
                                        if ((parseFloat(item.Tx) > 35) && (parseFloat(item.Tx)<38)) {
                                            status.temp35 = status.temp35 + 1
                                        }
                                        if (parseFloat(item.Tx) > 38) {
                                            status.temp38 = status.temp38 + 1
                                        }                                 
                                    }
                                })
                                var text = ""
                                for (key in status) {
                                    if (key != "text") {
                                        if (status[key] > 0) {
                                            if (key=="temp0"){}
                                            text = text +"出现冰冻（0度以下）的有" + status[key].toString() + "站;"
                                        }
                                        if (status[key] > 0) {
                                            if (key=="temp3"){}
                                            text = text +"出现薄冰（3度以下）的有" + status[key].toString() + "站;"
                                        }
                                        if (status[key] > 0) {
                                            if (key=="temp5"){}
                                            text = text +"出现霜（5度以下）的有" + status[key].toString() + "站;"
                                        }
                                        if (status[key] > 0) {
                                            if (key=="temp35"){}
                                            text = text +"出现高温（35度以上）的有" + status[key].toString() + "站;"
                                        }
                                        if (status[key] > 0) {
                                            if (key=="temp38"){}
                                            text = text +"出现酷暑（38度以上）的有" + status[key].toString() + "站;"
                                        }
                                }
                                if (text){
                                    text = "【气温】" + text
                                }
                                return text 
                                
                            }


                            }
                            else {

                            }

                        },
                        randar_text:function (){
                            var rander_test = "【实况通报】" 
                            /// 开始表演
                            var click_time = "all"
                            var rain_text = zdz_recdata_obj.randar_rain_text(click_time)
                            rander_test = rander_test + rain_text
                            var wind_text = zdz_recdata_obj.randar_wind_text(click_time)
                            rander_test = rander_test + wind_text
                            var view_text = zdz_recdata_obj.randar_view_text(click_time)
                            rander_test = rander_test + view_text 
                            var temp_text = zdz_recdata_obj.randar_temp_text(click_time)
                            rander_test = rander_test + temp_text
                            // 最后赋值
                            $("#zdz_text_info").html("")
                            $("#zdz_text_info").html(rander_test )

                            // return rander_test
                        },           
                    }
                    
                   
                    // 风
                    $('.wind').click(function (click_type,click_time) {
                        if (this.value == "wind_all") {
                            var click_type = "wind"
                            var click_time = "all"
                            //刷新
                            zdz_recdata_obj.flush_map()
                            // 画图
                            zdz_recdata_obj.rander_marker(click_type, click_time)
                        }
                        else {
                            console.log("single",this)
                        }
                    })
                    // 雨
                    $('.rain').click(function () {
                        if (this.value == "rain_all") {
                            // console.log(this.value)
                            var click_type = "rain"
                            var click_time = "all"
                            //刷新
                            zdz_recdata_obj.flush_map()
                            zdz_recdata_obj.randar_rain_text(click_time)
                            zdz_recdata_obj.rander_marker(click_type, click_time)
                        }
                        else {
                            console.log("single")
                        }
                    })
                    // 温
                    $('.temp').click(function () {
                        if (this.value == "temp_all") {
                            console.log(this.value)
                            var click_type = "temp"
                            var click_time = "all"
                            //刷新
                            zdz_recdata_obj.flush_map()
                            zdz_recdata_obj.rander_marker(click_type, click_time)
                        }
                        else {
                            console.log("single")
                        }
                    })
                    // 雾
                    $('.view').click(function () {
                        if (this.value == "view_all") {
                            console.log(this.value)
                            var click_type = "view"
                            var click_time = "all"
                            //刷新
                            zdz_recdata_obj.flush_map()
                            zdz_recdata_obj.rander_marker(click_type, click_time)
                        }
                        else {
                            console.log("single")
                        }
                    })
              
                    // 自动站数据加载
                    $('#tool_zdz_button').click(function () {
                        var map_z = document.getElementById("zdz_webgis")
                        if (map_z.children.length > 0) {
                            zdz_recdata_obj.zdz_map.remove()
                        }
                        $('#product_view').attr("style", "display:none;background-color:rgb(239, 243, 237); width: 100%; height: 100%;")
                        $('#product_zdz').attr("style", "background-color:rgb(239, 243, 237); width: 100%; height: 100%;padding:30px;")
                        var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                        // 如果日期为空
                        if (!zdz_recdata_obj.start_date){
                            var today = new Date()
                            var y = today.getFullYear();
                            var m = today.getMonth() + 1 < 10 ? "0" + (today.getMonth() + 1) : today.getMonth() + 1;
                            var d = today.getDate() < 10 ? "0" + today.getDate() : today.getDate();
                            var h = today.getHours() < 10 ? "0" + today.getHours() + ":00:00" : today.getHours() + ":00:00";
                            var today_str = y + "-" + m + "-" + d + " " + h;
                            var seven_day = getNextDate(today_str, day=-7)
                            zdz_recdata_obj.start_date = seven_day
                            zdz_recdata_obj.end_date = today_str
                        }
                        $.ajax({
                            url: "tool_zdz_date",  // 请求的地址
                            type: "post",  // 请求方式
                            timeout: 25000, //设置延迟上限
                            data: {
                                'csrfmiddlewaretoken': csrf,
                                'start_time':  zdz_recdata_obj.start_date,
                                'end_time': zdz_recdata_obj.end_date
                            },
                            dataType: "json",
                            beforeSend: function (XMLHttpRequest) {
                                load = showLoad();
                            },
                            success: function (data) { 
                                // console.log(data)                    
                                zdz_recdata_obj.init()                     
                                // 加载降水平面图
                                // 加载表格数据
                                var datatable = JSON.parse(data.table_data)
                                zdz_recdata_obj.data_all = datatable
                                // zdz_recdata_obj.table_data = data_tabel                                
                                zdz_recdata_obj.rander_table(datatable)
                                // 加载 时间线
                                zdz_recdata_obj.rander_btn(data.daily_btn_list)
                                // zdz_recdata_obj.zdz_map = map_zdz
                                // 降水图绘制
                                var click_type = "rain"
                                var click_time = "all"
                                zdz_recdata_obj.rander_marker(click_type, click_time)
                                zdz_recdata_obj.randar_text()
                                //关闭
                                closeLoad(load)
                            }
                        })
                        

                    })
                    // 精细化EC单点数据加载
                    $('#tool_ec_button').click(function () {
                        // $('#product_view').attr("style", "display:none;background-color:rgb(239, 243, 237); width: 100%; height: 100%;")
                        // $('#product_ec').attr("style", "background-color:rgb(239, 243, 237); width: 100%; height: 100%;padding:30px;") 

                        // 原始版本
                        var type = "tool_ec"
                        product_view_show(type)
                    })

                    // 降水订正
                    $('#tool_selfplot_button').click(function () {
                        var type = "select_self_plot"
                        product_view_show(type)

                    })


                </script>



            </div>

        </div>
        {% csrf_token %}
    </div>


</body>

</html>